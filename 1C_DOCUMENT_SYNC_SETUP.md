# 1С Налаштування Синхронізації Документів

## Огляд

Створення обробників для автоматичної синхронізації:
- **Приходні накладні** (ПоступлениеТоваровИУслуг)
- **Вихідні рахунки** (СчетНаОплатуПокупателю)

## 1. Модуль об'єкта для Приходних Накладних

### Документ.ПоступлениеТоваровИУслуг.МодульОбъекта

```1c
// =======================================================
// МОДУЛЬ ОБ'ЄКТА: Документ.ПоступлениеТоваровИУслуг.МодульОбъекта
// =======================================================

// Процедура записи в лог
Процедура ЗаписатьЛог(Сообщение)
    Попытка
        Файл = Новый ЗаписьТекста("c:\temp\invoice_sync_log.txt", КодировкаТекста.UTF8,, Истина);
        Файл.ЗаписатьСтроку(ТекущаяДата() + ": " + Сообщение);
        Файл.Закрыть();
    Исключение
        // Игнорируем ошибки логирования
    КонецПопытки;
КонецПроцедуры

// Функция для создания JSON
Функция СоздатьJSON(Данные)
    Попытка
        // Для 1С 8.3.15 и новее
        ЗаписьJSON = Новый ЗаписьJSON;
        ЗаписьJSON.УстановитьСтроку();
        ЗаписатьJSON(ЗаписьJSON, Данные);
        Возврат ЗаписьJSON.Закрыть();
    Исключение
        // Для более старых версий 1С
        Попытка
            Возврат ОбщегоНазначения.ОбъектВСтрокуJSON(Данные);
        Исключение
            ЗаписатьЛог("Ошибка создания JSON: " + ОписаниеОшибки());
            Возврат "";
        КонецПопытки;
    КонецПопытки;
КонецФункции

// Функция отправки webhook
Функция ОтправитьWebhook(URL, Данные)
    Попытка
        HTTPСоединение = Новый HTTPСоединение("your-erp-domain.com", 443,,,, 30, Новый ЗащищенноеСоединениеOpenSSL);
        Запрос = Новый HTTPЗапрос(URL);
        Запрос.УстановитьТелоИзСтроки(Данные, КодировкаТекста.UTF8);
        Запрос.Заголовки.Вставить("Content-Type", "application/json");
        Запрос.Заголовки.Вставить("User-Agent", "1C-Enterprise/8.3");
        
        Ответ = HTTPСоединение.ОтправитьДляОбработки(Запрос);
        
        Если Ответ.КодСостояния = 200 Тогда
            Возврат Истина;
        Иначе
            ЗаписатьЛог("Ошибка webhook: " + Ответ.КодСостояния + " - " + Ответ.ПолучитьТелоКакСтроку());
            Возврат Ложь;
        КонецЕсли;
    Исключение
        ЗаписатьЛог("Исключение webhook: " + ОписаниеОшибки());
        Возврат Ложь;
    КонецПопытки;
КонецФункции

// Функция для отправки данных накладной
Функция ОтправитьДанныеНакладной(Накладная, Действие)
    Попытка
        Данные = Новый Структура;
        Данные.Вставить("action", Действие);
        
        ДанныеНакладной = Новый Структура;
        ДанныеНакладной.Вставить("СсылкаДокумента", Строка(Накладная.Ссылка));
        ДанныеНакладной.Вставить("НомерДокумента", Накладная.Номер);
        ДанныеНакладной.Вставить("ДатаДокумента", Накладная.Дата);
        ДанныеНакладной.Вставить("Постачальник", Накладная.Контрагент.Наименование);
        ДанныеНакладной.Вставить("ЄДРПОУ", Накладная.Контрагент.КодПоЕДРПОУ);
        ДанныеНакладной.Вставить("СуммаДокумента", Накладная.СуммаДокумента);
        ДанныеНакладной.Вставить("КодВалюты", Накладная.ВалютаДокумента.Код);
        ДанныеНакладной.Вставить("Проведен", Накладная.Проведен);
        
        // Безопасное получение дополнительных полей
        Попытка
            ДанныеНакладной.Вставить("Комментарий", Накладная.Комментарий);
        Исключение
            ДанныеНакладной.Вставить("Комментарий", "");
        КонецПопытки;
        
        // Позиции товаров
        Позиции = Новый Массив;
        Для Каждого СтрокаТовара Из Накладная.Товары Цикл
            Позиция = Новый Структура;
            Позиция.Вставить("НаименованиеТовара", СтрокаТовара.Номенклатура.Наименование);
            Позиция.Вставить("КодТовара", СтрокаТовара.Номенклатура.Код);
            Позиция.Вставить("Количество", СтрокаТовара.Количество);
            Позиция.Вставить("Цена", СтрокаТовара.Цена);
            Позиция.Вставить("Сумма", СтрокаТовара.Сумма);
            
            // Безопасное получение единиц измерения
            Попытка
                Позиция.Вставить("ЕдиницаИзмерения", СтрокаТовара.ЕдиницаИзмерения.Наименование);
            Исключение
                Позиция.Вставить("ЕдиницаИзмерения", "");
            КонецПопытки;
            
            Позиции.Добавить(Позиция);
        КонецЦикла;
        
        ДанныеНакладной.Вставить("positions", Позиции);
        Данные.Вставить("invoiceData", ДанныеНакладной);
        
        JSONСтрока = СоздатьJSON(Данные);
        Если ПустаяСтрока(JSONСтрока) Тогда
            ЗаписатьЛог("Пустой JSON для накладной: " + Накладная.Номер);
            Возврат Ложь;
        КонецЕсли;
        
        Результат = ОтправитьWebhook("/api/webhook/1c/invoices", JSONСтрока);
        
        Если Результат Тогда
            ЗаписатьЛог("Успешно отправлена накладная: " + Накладная.Номер + " (" + Действие + ")");
        Иначе
            ЗаписатьЛог("Ошибка отправки накладной: " + Накладная.Номер);
        КонецЕсли;
        
        Возврат Результат;
        
    Исключение
        ЗаписатьЛог("Исключение при отправке накладной: " + ОписаниеОшибки());
        Возврат Ложь;
    КонецПопытки;
КонецФункции

// ========================================
// ОБРАБОТЧИКИ СОБЫТИЙ ДОКУМЕНТА
// ========================================

// При записи документа (создание или изменение)
Процедура ПриЗаписи(Отказ)
    Если Отказ Тогда
        Возврат;
    КонецЕсли;
    
    Попытка
        Действие = ?(ЭтотОбъект.ЭтоНовый(), "create", "update");
        ОтправитьДанныеНакладной(ЭтотОбъект, Действие);
    Исключение
        ЗаписатьЛог("Ошибка синхронизации накладной: " + ОписаниеОшибки());
    КонецПопытки;
КонецПроцедуры

// Перед удалением документа
Процедура ПередУдалением(Отказ)
    Если Отказ Тогда
        Возврат;
    КонецЕсли;
    
    Попытка
        ОтправитьДанныеНакладной(ЭтотОбъект, "delete");
    Исключение
        ЗаписатьЛог("Ошибка синхронизации удаления накладной: " + ОписаниеОшибки());
    КонецПопытки;
КонецПроцедуры
```

## 2. Модуль об'єкта для Вихідних Рахунків

### Документ.СчетНаОплатуПокупателю.МодульОбъекта

```1c
// =======================================================
// МОДУЛЬ ОБ'ЄКТА: Документ.СчетНаОплатуПокупателю.МодульОбъекта
// =======================================================

// Процедура записи в лог
Процедура ЗаписатьЛог(Сообщение)
    Попытка
        Файл = Новый ЗаписьТекста("c:\temp\outgoing_invoice_sync_log.txt", КодировкаТекста.UTF8,, Истина);
        Файл.ЗаписатьСтроку(ТекущаяДата() + ": " + Сообщение);
        Файл.Закрыть();
    Исключение
        // Игнорируем ошибки логирования
    КонецПопытки;
КонецПроцедуры

// Функция для создания JSON
Функция СоздатьJSON(Данные)
    Попытка
        // Для 1С 8.3.15 и новее
        ЗаписьJSON = Новый ЗаписьJSON;
        ЗаписьJSON.УстановитьСтроку();
        ЗаписатьJSON(ЗаписьJSON, Данные);
        Возврат ЗаписьJSON.Закрыть();
    Исключение
        // Для более старых версий 1С
        Попытка
            Возврат ОбщегоНазначения.ОбъектВСтрокуJSON(Данные);
        Исключение
            ЗаписатьЛог("Ошибка создания JSON: " + ОписаниеОшибки());
            Возврат "";
        КонецПопытки;
    КонецПопытки;
КонецФункции

// Функция отправки webhook
Функция ОтправитьWebhook(URL, Данные)
    Попытка
        HTTPСоединение = Новый HTTPСоединение("your-erp-domain.com", 443,,,, 30, Новый ЗащищенноеСоединениеOpenSSL);
        Запрос = Новый HTTPЗапрос(URL);
        Запрос.УстановитьТелоИзСтроки(Данные, КодировкаТекста.UTF8);
        Запрос.Заголовки.Вставить("Content-Type", "application/json");
        Запрос.Заголовки.Вставить("User-Agent", "1C-Enterprise/8.3");
        
        Ответ = HTTPСоединение.ОтправитьДляОбработки(Запрос);
        
        Если Ответ.КодСостояния = 200 Тогда
            Возврат Истина;
        Иначе
            ЗаписатьЛог("Ошибка webhook: " + Ответ.КодСостояния + " - " + Ответ.ПолучитьТелоКакСтроку());
            Возврат Ложь;
        КонецЕсли;
    Исключение
        ЗаписатьЛог("Исключение webhook: " + ОписаниеОшибки());
        Возврат Ложь;
    КонецПопытки;
КонецФункции

// Функция для отправки данных вихідного рахунку
Функция ОтправитьДанныеВихідногоРахунку(Рахунок, Действие)
    Попытка
        Данные = Новый Структура;
        Данные.Вставить("action", Действие);
        
        ДанныеРахунку = Новый Структура;
        ДанныеРахунку.Вставить("СсылкаДокумента", Строка(Рахунок.Ссылка));
        ДанныеРахунку.Вставить("НомерДокумента", Рахунок.Номер);
        ДанныеРахунку.Вставить("ДатаДокумента", Рахунок.Дата);
        ДанныеРахунку.Вставить("Клиент", Рахунок.Контрагент.Наименование);
        ДанныеРахунку.Вставить("ЄДРПОУ", Рахунок.Контрагент.КодПоЕДРПОУ);
        ДанныеРахунку.Вставить("СуммаДокумента", Рахунок.СуммаДокумента);
        ДанныеРахунку.Вставить("КодВалюты", Рахунок.ВалютаДокумента.Код);
        ДанныеРахунку.Вставить("Проведен", Рахунок.Проведен);
        
        // Безопасное получение дополнительных полей
        Попытка
            ДанныеРахунку.Вставить("Комментарий", Рахунок.Комментарий);
        Исключение
            ДанныеРахунку.Вставить("Комментарий", "");
        КонецПопытки;
        
        Попытка
            ДанныеРахунку.Вставить("ДатаОплаты", Рахунок.ДатаОплаты);
        Исключение
            ДанныеРахунку.Вставить("ДатаОплаты", '00010101');
        КонецПопытки;
        
        Попытка
            ДанныеРахунку.Вставить("КодКлиента", Рахунок.Контрагент.Код);
        Исключение
            ДанныеРахунку.Вставить("КодКлиента", "");
        КонецПопытки;
        
        Попытка
            ДанныеРахунку.Вставить("ИННКлиента", Рахунок.Контрагент.ИНН);
        Исключение
            ДанныеРахунку.Вставить("ИННКлиента", "");
        КонецПопытки;
        
        // Позиции товаров
        Позиции = Новый Массив;
        Для Каждого СтрокаТовара Из Рахунок.Товары Цикл
            Позиция = Новый Структура;
            Позиция.Вставить("НаименованиеТовара", СтрокаТовара.Номенклатура.Наименование);
            Позиция.Вставить("КодТовара", СтрокаТовара.Номенклатура.Код);
            Позиция.Вставить("Количество", СтрокаТовара.Количество);
            Позиция.Вставить("Цена", СтрокаТовара.Цена);
            Позиция.Вставить("Сумма", СтрокаТовара.Сумма);
            
            // Безопасное получение единиц измерения
            Попытка
                Позиция.Вставить("ЕдиницаИзмерения", СтрокаТовара.ЕдиницаИзмерения.Наименование);
            Исключение
                Позиция.Вставить("ЕдиницаИзмерения", "");
            КонецПопытки;
            
            Позиции.Добавить(Позиция);
        КонецЦикла;
        
        ДанныеРахунку.Вставить("positions", Позиции);
        Данные.Вставить("invoiceData", ДанныеРахунку);
        
        JSONСтрока = СоздатьJSON(Данные);
        Если ПустаяСтрока(JSONСтрока) Тогда
            ЗаписатьЛог("Пустой JSON для вихідного рахунку: " + Рахунок.Номер);
            Возврат Ложь;
        КонецЕсли;
        
        Результат = ОтправитьWebhook("/api/webhook/1c/outgoing-invoices", JSONСтрока);
        
        Если Результат Тогда
            ЗаписатьЛог("Успешно отправлен вихідний рахунок: " + Рахунок.Номер + " (" + Действие + ")");
        Иначе
            ЗаписатьЛог("Ошибка отправки вихідного рахунку: " + Рахунок.Номер);
        КонецЕсли;
        
        Возврат Результат;
        
    Исключение
        ЗаписатьЛог("Исключение при отправке вихідного рахунку: " + ОписаниеОшибки());
        Возврат Ложь;
    КонецПопытки;
КонецФункции

// ========================================
// ОБРАБОТЧИКИ СОБЫТИЙ ДОКУМЕНТА
// ========================================

// При записи документа (создание или изменение)
Процедура ПриЗаписи(Отказ)
    Если Отказ Тогда
        Возврат;
    КонецЕсли;
    
    Попытка
        Действие = ?(ЭтотОбъект.ЭтоНовый(), "create", "update");
        ОтправитьДанныеВихідногоРахунку(ЭтотОбъект, Действие);
    Исключение
        ЗаписатьЛог("Ошибка синхронизации вихідного рахунку: " + ОписаниеОшибки());
    КонецПопытки;
КонецПроцедуры

// Перед удалением документа
Процедура ПередУдалением(Отказ)
    Если Отказ Тогда
        Возврат;
    КонецЕсли;
    
    Попытка
        ОтправитьДанныеВихідногоРахунку(ЭтотОбъект, "delete");
    Исключение
        ЗаписатьЛог("Ошибка синхронизации удаления вихідного рахунку: " + ОписаниеОшибки());
    КонецПопытки;
КонецПроцедуры
```

## 🔧 Кроки налаштування

### 1. Налаштування Приходних Накладних

1. **Відкрийте модуль документа**:
   - Документи → ПоступлениеТоваровИУслуг
   - Правий клік → Открыть модуль объекта
   - Якщо модуль не існує, створіть: Модуль объекта → Создать

2. **Додайте код**:
   - Скопіюйте код для ПоступлениеТоваровИУслуг
   - Замініть `your-erp-domain.com` на реальний домен

### 2. Налаштування Вихідних Рахунків

1. **Відкрийте модуль документа**:
   - Документи → СчетНаОплатуПокупателю
   - Правий клік → Открыть модуль объекта
   - Якщо модуль не існує, створіть: Модуль объекта → Создать

2. **Додайте код**:
   - Скопіюйте код для СчетНаОплатуПокупателю
   - Замініть `your-erp-domain.com` на реальний домен

### 3. Замініть URL у всіх модулях

Знайдіть у кожному модулі:
```1c
HTTPСоединение = Новый HTTPСоединение("your-erp-domain.com", 443,,,, 30, Новый ЗащищенноеСоединениеOpenSSL);
```

Замініть на:
```1c
HTTPСоединение = Новый HTTPСоединение("ваш-домен.com", 443,,,, 30, Новый ЗащищенноеСоединениеOpenSSL);
```

### 4. Перевірте компіляцію

1. У кожному модулі натисніть **Ctrl+F7**
2. Переконайтеся що немає помилок
3. Збережіть модулі

### 5. Протестуйте

1. **Приходні накладні**:
   - Створіть або змініть накладну
   - Перевірте лог: `c:\temp\invoice_sync_log.txt`

2. **Вихідні рахунки**:
   - Створіть або змініть рахунок
   - Перевірте лог: `c:\temp\outgoing_invoice_sync_log.txt`

## ✅ Функціонал

### Приходні накладні
- ✅ Автоматична синхронізація при створенні/оновленні
- ✅ Передача всіх позицій товарів
- ✅ Безпечне отримання полів
- ✅ Детальне логування

### Вихідні рахунки
- ✅ Автоматична синхронізація при створенні/оновленні
- ✅ Передача всіх позицій товарів
- ✅ Додаткові поля клієнта (код, ІПН)
- ✅ Детальне логування

## 📝 Файли логів

- **Клієнти**: `c:\temp\client_sync_log.txt`
- **Приходні накладні**: `c:\temp\invoice_sync_log.txt`
- **Вихідні рахунки**: `c:\temp\outgoing_invoice_sync_log.txt`

## 🚀 Результат

Тепер всі зміни в 1С автоматично синхронізуються з ERP системою:
- Створення/оновлення/видалення клієнтів
- Створення/оновлення/видалення приходних накладних
- Створення/оновлення/видалення вихідних рахунків
# 1С Webhook Автоматична Синхронізація - Налаштування

## Огляд

Цей документ містить повний код для налаштування автоматичної синхронізації між 1С та ERP через webhook'и. Коли дані змінюються в 1С, система автоматично надсилає оновлення в ERP.

## Webhook Endpoints

ERP система надає наступні webhook endpoints:

1. **Синхронізація клієнтів**: `POST /api/webhook/1c/clients`
2. **Синхронізація накладних**: `POST /api/webhook/1c/invoices`
3. **Синхронізація вихідних рахунків**: `POST /api/webhook/1c/outgoing-invoices`

## Структура даних клієнта в 1С

**ВАЖЛИВО**: Різні поля клієнта в 1С мають різне призначення:

- `Контрагент.Код` - внутрішній код клієнта в 1С (наприклад, "00-000655")
- `Контрагент.КодПоЕДРПОУ` - офіційний код ЄДРПОУ для пошуку в ERP (наприклад, "12345678")
- `Контрагент.ИНН` - індивідуальний податковий номер (ІПН) для фізичних осіб

ERP система використовує пріоритет: **ЄДРПОУ** → **Код клієнта** → **ІПН** для пошуку існуючих клієнтів.

## Код для 1С

### 1. Основний HTTP-сервіс (webhook_sender.1c)

```1c
// Функція для відправки webhook'а
Функция ОтправитьWebhook(URL, Данные)
    Попытка
        HTTPСоединение = Новый HTTPСоединение("your-erp-domain.com", 443,,,, 30, Новый ЗащищенноеСоединениеOpenSSL);
        Запрос = Новый HTTPЗапрос(URL);
        Запрос.УстановитьТелоИзСтроки(Данные, КодировкаТекста.UTF8);
        Запрос.Заголовки.Вставить("Content-Type", "application/json");
        Запрос.Заголовки.Вставить("User-Agent", "1C-Enterprise/8.3");
        
        Ответ = HTTPСоединение.ОтправитьДляОбработки(Запрос);
        
        Если Ответ.КодСостояния = 200 Тогда
            Возврат Истина;
        Иначе
            ЗаписатьЛог("Ошибка webhook: " + Ответ.КодСостояния + " - " + Ответ.ПолучитьТелоКакСтроку());
            Возврат Ложь;
        КонецЕсли;
    Исключение
        ЗаписатьЛог("Исключение webhook: " + ОписаниеОшибки());
        Возврат Ложь;
    КонецПопытки;
КонецФункции

// Функция логирования
Функция ЗаписатьЛог(Сообщение)
    Попытка
        Файл = Новый ЗаписьТекста("c:\temp\webhook_log.txt", КодировкаТекста.UTF8,, Истина);
        Файл.ЗаписатьСтроку(ТекущаяДата() + ": " + Сообщение);
        Файл.Закрыть();
    Исключение
        // Игнорируем ошибки логирования
    КонецПопытки;
КонецФункции

// Функция для получения данных компании
Функция ПолучитьДанныеКомпании(Организация)
    ДанныеКомпании = Новый Структура;
    Если ЗначениеЗаполнено(Организация) Тогда
        ДанныеКомпании.Вставить("НашаКомпанія", Организация.Наименование);
        ДанныеКомпании.Вставить("КомпаніяЄДРПОУ", Организация.КодПоЕДРПОУ);
        ДанныеКомпании.Вставить("КомпаніяІПН", Организация.ИНН);
        ДанныеКомпании.Вставить("КомпаніяКод", Организация.Код);
    КонецЕсли;
    Возврат ДанныеКомпании;
КонецФункции

// Функция для отправки данных клиента (ОБНОВЛЕНА)
Функция ОтправитьДанныеКлиента(Контрагент, Действие)
    Данные = Новый Структура;
    Данные.Вставить("action", Действие);
    
    ДанныеКлиента = Новый Структура;
    ДанныеКлиента.Вставить("Код", Контрагент.Код);
    ДанныеКлиента.Вставить("Наименование", Контрагент.Наименование);
    ДанныеКлиента.Вставить("ИНН", Контрагент.ИНН);
    ДанныеКлиента.Вставить("ЄДРПОУ", Контрагент.КодПоЕДРПОУ);  // ВАЖЛИВО: правильне поле для ЄДРПОУ
    ДанныеКлиента.Вставить("Телефон", Контрагент.Телефон);
    ДанныеКлиента.Вставить("Email", Контрагент.Email);
    
    // ДОДАЄМО ДАНІ КОМПАНІЇ ДО КОЖНОГО КЛІЄНТА
    ДанныеКомпании = ПолучитьДанныеКомпании(ПолучитьОсновнуюОрганизацию());
    Для Каждого КлючЗначение Из ДанныеКомпании Цикл
        ДанныеКлиента.Вставить(КлючЗначение.Ключ, КлючЗначение.Значение);
    КонецЦикла;
    ДанныеКлиента.Вставить("Адрес", Контрагент.ЮридическийАдрес);
    
    Данные.Вставить("clientData", ДанныеКлиента);
    
    JSONСтрока = "";
    Попытка
        JSONСтрока = СоздатьJSON(Данные);
    Исключение
        ЗаписатьЛог("Ошибка JSON клиента: " + ОписаниеОшибки());
        Возврат Ложь;
    КонецПопытки;
    
    Возврат ОтправитьWebhook("/api/webhook/1c/clients", JSONСтрока);
КонецФункции

// Функция для отправки данных накладной (ОБНОВЛЕНА)
Функция ОтправитьДанныеНакладной(Накладная, Действие)
    Данные = Новый Структура;
    Данные.Вставить("action", Действие);
    
    ДанныеНакладной = Новый Структура;
    ДанныеНакладной.Вставить("СсылкаДокумента", Накладная.СсылкаДокумента);
    ДанныеНакладной.Вставить("НомерДокумента", Накладная.Номер);
    ДанныеНакладной.Вставить("ДатаДокумента", Накладная.Дата);
    ДанныеНакладной.Вставить("Постачальник", Накладная.Контрагент.Наименование);
    ДанныеНакладной.Вставить("СуммаДокумента", Накладная.СуммаДокумента);
    ДанныеНакладной.Вставить("КодВалюты", Накладная.ВалютаДокумента.Код);
    
    // ДОДАЄМО ДАНІ КОМПАНІЇ ДО КОЖНОЇ НАКЛАДНОЇ
    ДанныеКомпании = ПолучитьДанныеКомпании(Накладная.Организация);
    Для Каждого КлючЗначение Из ДанныеКомпании Цикл
        ДанныеНакладной.Вставить(КлючЗначение.Ключ, КлючЗначение.Значение);
    КонецЦикла;
    
    // Позиции товаров
    Позиции = Новый Массив;
    Для Каждого СтрокаТовара Из Накладная.Товары Цикл
        Позиция = Новый Структура;
        Позиция.Вставить("НаименованиеТовара", СтрокаТовара.Номенклатура.Наименование);
        Позиция.Вставить("КодТовара", СтрокаТовара.Номенклатура.Код);
        Позиция.Вставить("Количество", СтрокаТовара.Количество);
        Позиция.Вставить("Цена", СтрокаТовара.Цена);
        Позиция.Вставить("Сумма", СтрокаТовара.Сумма);
        Позиции.Добавить(Позиция);
    КонецЦикла;
    
    ДанныеНакладной.Вставить("positions", Позиции);
    Данные.Вставить("invoiceData", ДанныеНакладной);
    
    JSONСтрока = "";
    Попытка
        JSONСтрока = СоздатьJSON(Данные);
    Исключение
        ЗаписатьЛог("Ошибка JSON накладной: " + ОписаниеОшибки());
        Возврат Ложь;
    КонецПопытки;
    
    Возврат ОтправитьWebhook("/api/webhook/1c/invoices", JSONСтрока);
КонецФункции

// Функция для отправки данных вихідного рахунку (ОБНОВЛЕНА)
Функция ОтправитьДанныеВихідногоРахунку(Рахунок, Действие)
    Данные = Новый Структура;
    Данные.Вставить("action", Действие);
    
    ДанныеРахунку = Новый Структура;
    ДанныеРахунку.Вставить("СсылкаДокумента", Рахунок.СсылкаДокумента);
    ДанныеРахунку.Вставить("НомерДокумента", Рахунок.Номер);
    ДанныеРахунку.Вставить("ДатаДокумента", Рахунок.Дата);
    ДанныеРахунку.Вставить("Клиент", Рахунок.Контрагент.Наименование);
    ДанныеРахунку.Вставить("СуммаДокумента", Рахунок.СуммаДокумента);
    ДанныеРахунку.Вставить("КодВалюты", Рахунок.ВалютаДокумента.Код);
    
    // ДОДАЄМО ДАНІ КОМПАНІЇ ДО КОЖНОГО РАХУНКУ
    ДанныеКомпании = ПолучитьДанныеКомпании(Рахунок.Организация);
    Для Каждого КлючЗначение Из ДанныеКомпании Цикл
        ДанныеРахунку.Вставить(КлючЗначение.Ключ, КлючЗначение.Значение);
    КонецЦикла;
    
    // Позиции товаров
    Позиции = Новый Массив;
    Для Каждого СтрокаТовара Из Рахунок.Товары Цикл
        Позиция = Новый Структура;
        Позиция.Вставить("НаименованиеТовара", СтрокаТовара.Номенклатура.Наименование);
        Позиция.Вставить("КодТовара", СтрокаТовара.Номенклатура.Код);
        Позиция.Вставить("Количество", СтрокаТовара.Количество);
        Позиция.Вставить("Цена", СтрокаТовара.Цена);
        Позиция.Вставить("Сумма", СтрокаТовара.Сумма);
        Позиции.Добавить(Позиция);
    КонецЦикла;
    
    ДанныеРахунку.Вставить("positions", Позиции);
    Данные.Вставить("invoiceData", ДанныеРахунку);
    
    JSONСтрока = "";
    Попытка
        JSONСтрока = СоздатьJSON(Данные);
    Исключение
        ЗаписатьЛог("Ошибка JSON вихідного рахунку: " + ОписаниеОшибки());
        Возврат Ложь;
    КонецПопытки;
    
    Возврат ОтправитьWebhook("/api/webhook/1c/outgoing-invoices", JSONСтрока);
КонецФункции

// Функция для создания JSON (совместимость с разными версиями 1С)
Функция СоздатьJSON(Данные)
    Попытка
        // Для 1С 8.3.15+
        ЗаписьJSON = Новый ЗаписьJSON;
        ЗаписьJSON.УстановитьСтроку();
        ЗаписатьJSON(ЗаписьJSON, Данные);
        Возврат ЗаписьJSON.Закрыть();
    Исключение
        // Для старых версий 1С - используем общий модуль
        Попытка
            Возврат ОбщегоНазначения.ОбъектВСтрокуJSON(Данные);
        Исключение
            // Альтернативный способ для совсем старых версий
            Возврат "";
        КонецПопытки;
    КонецПопытки;
КонецФункции
```

### 2. Обработчики событий документов

Додайте ці обробники в модулі відповідних документів:

#### Для документу "Справочник.Контрагенты"

```1c
// В модуле объекта справочника Контрагенты
Процедура ПриЗаписи(Отказ)
    Если Отказ Тогда
        Возврат;
    КонецЕсли;
    
    Попытка
        // Определяем действие
        Действие = ?(ЭтоНовый(), "create", "update");
        
        // Отправляем данные в ERP
        ОтправитьДанныеКлиента(ЭтотОбъект, Действие);
        
    Исключение
        ЗаписатьЛог("Ошибка синхронизации клиента: " + ОписаниеОшибки());
    КонецПопытки;
КонецПроцедуры

Процедура ПередУдалением(Отказ)
    Если Отказ Тогда
        Возврат;
    КонецЕсли;
    
    Попытка
        // Отправляем данные в ERP
        ОтправитьДанныеКлиента(ЭтотОбъект, "delete");
        
    Исключение
        ЗаписатьЛог("Ошибка синхронизации удаления клиента: " + ОписаниеОшибки());
    КонецПопытки;
КонецПроцедуры
```

#### Для документу "Документ.ПоступлениеТоваровИУслуг"

```1c
// В модуле объекта документа ПоступлениеТоваровИУслуг
Процедура ПриЗаписи(Отказ)
    Если Отказ Тогда
        Возврат;
    КонецЕсли;
    
    // Синхронизируем только проведенные документы
    Если НЕ Проведен Тогда
        Возврат;
    КонецЕсли;
    
    Попытка
        // Определяем действие
        Действие = ?(ЭтоНовый(), "create", "update");
        
        // Отправляем данные в ERP
        ОтправитьДанныеНакладной(ЭтотОбъект, Действие);
        
    Исключение
        ЗаписатьЛог("Ошибка синхронизации накладной: " + ОписаниеОшибки());
    КонецПопытки;
КонецПроцедуры

Процедура ПередУдалением(Отказ)
    Если Отказ Тогда
        Возврат;
    КонецЕсли;
    
    Попытка
        // Отправляем данные в ERP
        ОтправитьДанныеНакладной(ЭтотОбъект, "delete");
        
    Исключение
        ЗаписатьЛог("Ошибка синхронизации удаления накладной: " + ОписаниеОшибки());
    КонецПопытки;
КонецПроцедуры
```

#### Для документу "Документ.СчетНаОплатуПокупателю"

```1c
// В модуле объекта документа СчетНаОплатуПокупателю
Процедура ПриЗаписи(Отказ)
    Если Отказ Тогда
        Возврат;
    КонецЕсли;
    
    // Синхронизируем только проведенные документы
    Если НЕ Проведен Тогда
        Возврат;
    КонецЕсли;
    
    Попытка
        // Определяем действие
        Действие = ?(ЭтоНовый(), "create", "update");
        
        // Отправляем данные в ERP
        ОтправитьДанныеВихідногоРахунку(ЭтотОбъект, Действие);
        
    Исключение
        ЗаписатьЛог("Ошибка синхронизации вихідного рахунку: " + ОписаниеОшибки());
    КонецПопытки;
КонецПроцедуры

Процедура ПередУдалением(Отказ)
    Если Отказ Тогда
        Возврат;
    КонецЕсли;
    
    Попытка
        // Отправляем данные в ERP
        ОтправитьДанныеВихідногоРахунку(ЭтотОбъект, "delete");
        
    Исключение
        ЗаписатьЛог("Ошибка синхронизации удаления вихідного рахунку: " + ОписаниеОшибки());
    КонецПопытки;
КонецПроцедуры
```

## Виправлення помилок компіляції

### ❌ ПОМИЛКА: "Процедура або функція з вказаним ім'ям вже визначена (ЗаписатьJSON)"

**Рішення**: В коді вище вже виправлено - використовується функція `СоздатьJSON` замість дублікату `ЗаписатьJSON`.

### ❌ ПОМИЛКА: "Звернення до процедури як до функції (ЗаписатьJSON)"

**Рішення**: Замінено всі виклики `ЗаписатьJSON(Данные)` на `СоздатьJSON(Данные)`.

## Налаштування

### 1. Замініть URL
В коді замініть `your-erp-domain.com` на реальний домен вашої ERP системи.

### 2. Додайте код у 1С
1. Створіть новий загальний модуль `WebhookIntegration`
2. Скопіюйте виправлений основний код HTTP-сервісу (з функцією `СоздатьJSON`)
3. Додайте обробники подій в модулі відповідних документів

### 3. Перевірте код після додавання
Переконайтеся що:
- ✅ Немає дублікатів функцій
- ✅ Всі виклики використовують `СоздатьJSON(Данные)`  
- ✅ Модуль компілюється без помилок

### 3. Налаштуйте права доступу
Переконайтеся, що у 1С є права на:
- Читання та запис документів
- Створення HTTP-з'єднань
- Запис файлів в c:\temp\

### 4. Тестування
1. Створіть або змініть клієнта в 1С
2. Перевірте лог файл `c:\temp\webhook_log.txt`
3. Перевірте в ERP чи з'явилися дані

## Логування
Всі дії записуються в файл `c:\temp\webhook_log.txt` для діагностики проблем.

## Безпека
- Використовується HTTPS з'єднання
- Передаються тільки необхідні дані
- Є обробка помилок без розкриття внутрішньої структури

## Підтримка
При виникненні проблем перевірте:
1. Логи 1С: `c:\temp\webhook_log.txt`
2. Логи ERP: в консолі сервера
3. Мережеве з'єднання між 1С та ERP
4. Коректність URL webhook'ів
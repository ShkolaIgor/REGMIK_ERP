# 1С Webhook Автоматична Синхронізація - Налаштування

## Огляд

Цей документ містить повний код для налаштування автоматичної синхронізації між 1С та ERP через webhook'и. Коли дані змінюються в 1С, система автоматично надсилає оновлення в ERP.

## Webhook Endpoints

ERP система надає наступні webhook endpoints:

1. **Синхронізація клієнтів**: `POST /api/webhook/1c/clients`
2. **Синхронізація накладних**: `POST /api/webhook/1c/invoices`
3. **Синхронізація вихідних рахунків**: `POST /api/webhook/1c/outgoing-invoices`

## Код для 1С

### 1. Основний HTTP-сервіс (webhook_sender.1c)

```1c
// Функція для відправки webhook'а
Функция ОтправитьWebhook(URL, Данные)
    Попытка
        HTTPСоединение = Новый HTTPСоединение("your-erp-domain.com", 443,,,, 30, Новый ЗащищенноеСоединениеOpenSSL);
        Запрос = Новый HTTPЗапрос(URL);
        Запрос.УстановитьТелоИзСтроки(Данные, КодировкаТекста.UTF8);
        Запрос.Заголовки.Вставить("Content-Type", "application/json");
        Запрос.Заголовки.Вставить("User-Agent", "1C-Enterprise/8.3");
        
        Ответ = HTTPСоединение.ОтправитьДляОбработки(Запрос);
        
        Если Ответ.КодСостояния = 200 Тогда
            Возврат Истина;
        Иначе
            ЗаписатьЛог("Ошибка webhook: " + Ответ.КодСостояния + " - " + Ответ.ПолучитьТелоКакСтроку());
            Возврат Ложь;
        КонецЕсли;
    Исключение
        ЗаписатьЛог("Исключение webhook: " + ОписаниеОшибки());
        Возврат Ложь;
    КонецПопытки;
КонецФункции

// Функция логирования
Функция ЗаписатьЛог(Сообщение)
    Попытка
        Файл = Новый ЗаписьТекста("c:\temp\webhook_log.txt", КодировкаТекста.UTF8,, Истина);
        Файл.ЗаписатьСтроку(ТекущаяДата() + ": " + Сообщение);
        Файл.Закрыть();
    Исключение
        // Игнорируем ошибки логирования
    КонецПопытки;
КонецФункции

// Функция для отправки данных клиента
Функция ОтправитьДанныеКлиента(Контрагент, Действие)
    Данные = Новый Структура;
    Данные.Вставить("action", Действие);
    
    ДанныеКлиента = Новый Структура;
    ДанныеКлиента.Вставить("Код", Контрагент.Код);
    ДанныеКлиента.Вставить("Наименование", Контрагент.Наименование);
    ДанныеКлиента.Вставить("ИНН", Контрагент.ИНН);
    ДанныеКлиента.Вставить("Телефон", Контрагент.Телефон);
    ДанныеКлиента.Вставить("Email", Контрагент.Email);
    ДанныеКлиента.Вставить("Адрес", Контрагент.ЮридическийАдрес);
    
    Данные.Вставить("clientData", ДанныеКлиента);
    
    JSONСтрока = "";
    Попытка
        JSONСтрока = ЗаписатьJSON(Данные);
    Исключение
        ЗаписатьЛог("Ошибка JSON клиента: " + ОписаниеОшибки());
        Возврат Ложь;
    КонецПопытки;
    
    Возврат ОтправитьWebhook("/api/webhook/1c/clients", JSONСтрока);
КонецФункции

// Функция для отправки данных накладной
Функция ОтправитьДанныеНакладной(Накладная, Действие)
    Данные = Новый Структура;
    Данные.Вставить("action", Действие);
    
    ДанныеНакладной = Новый Структура;
    ДанныеНакладной.Вставить("СсылкаДокумента", Накладная.СсылкаДокумента);
    ДанныеНакладной.Вставить("НомерДокумента", Накладная.Номер);
    ДанныеНакладной.Вставить("ДатаДокумента", Накладная.Дата);
    ДанныеНакладной.Вставить("Постачальник", Накладная.Контрагент.Наименование);
    ДанныеНакладной.Вставить("СуммаДокумента", Накладная.СуммаДокумента);
    ДанныеНакладной.Вставить("КодВалюты", Накладная.ВалютаДокумента.Код);
    
    // Позиции товаров
    Позиции = Новый Массив;
    Для Каждого СтрокаТовара Из Накладная.Товары Цикл
        Позиция = Новый Структура;
        Позиция.Вставить("НаименованиеТовара", СтрокаТовара.Номенклатура.Наименование);
        Позиция.Вставить("КодТовара", СтрокаТовара.Номенклатура.Код);
        Позиция.Вставить("Количество", СтрокаТовара.Количество);
        Позиция.Вставить("Цена", СтрокаТовара.Цена);
        Позиция.Вставить("Сумма", СтрокаТовара.Сумма);
        Позиции.Добавить(Позиция);
    КонецЦикла;
    
    ДанныеНакладной.Вставить("positions", Позиции);
    Данные.Вставить("invoiceData", ДанныеНакладной);
    
    JSONСтрока = "";
    Попытка
        JSONСтрока = ЗаписатьJSON(Данные);
    Исключение
        ЗаписатьЛог("Ошибка JSON накладной: " + ОписаниеОшибки());
        Возврат Ложь;
    КонецПопытки;
    
    Возврат ОтправитьWebhook("/api/webhook/1c/invoices", JSONСтрока);
КонецФункции

// Функция для отправки данных вихідного рахунку
Функция ОтправитьДанныеВихідногоРахунку(Рахунок, Действие)
    Данные = Новый Структура;
    Данные.Вставить("action", Действие);
    
    ДанныеРахунку = Новый Структура;
    ДанныеРахунку.Вставить("СсылкаДокумента", Рахунок.СсылкаДокумента);
    ДанныеРахунку.Вставить("НомерДокумента", Рахунок.Номер);
    ДанныеРахунку.Вставить("ДатаДокумента", Рахунок.Дата);
    ДанныеРахунку.Вставить("Клиент", Рахунок.Контрагент.Наименование);
    ДанныеРахунку.Вставить("СуммаДокумента", Рахунок.СуммаДокумента);
    ДанныеРахунку.Вставить("КодВалюты", Рахунок.ВалютаДокумента.Код);
    
    // Позиции товаров
    Позиции = Новый Массив;
    Для Каждого СтрокаТовара Из Рахунок.Товары Цикл
        Позиция = Новый Структура;
        Позиция.Вставить("НаименованиеТовара", СтрокаТовара.Номенклатура.Наименование);
        Позиция.Вставить("КодТовара", СтрокаТовара.Номенклатура.Код);
        Позиция.Вставить("Количество", СтрокаТовара.Количество);
        Позиция.Вставить("Цена", СтрокаТовара.Цена);
        Позиция.Вставить("Сумма", СтрокаТовара.Сумма);
        Позиции.Добавить(Позиция);
    КонецЦикла;
    
    ДанныеРахунку.Вставить("positions", Позиции);
    Данные.Вставить("invoiceData", ДанныеРахунку);
    
    JSONСтрока = "";
    Попытка
        JSONСтрока = ЗаписатьJSON(Данные);
    Исключение
        ЗаписатьЛог("Ошибка JSON вихідного рахунку: " + ОписаниеОшибки());
        Возврат Ложь;
    КонецПопытки;
    
    Возврат ОтправитьWebhook("/api/webhook/1c/outgoing-invoices", JSONСтрока);
КонецФункции

// Функция для записи JSON (совместимость с разными версиями 1С)
Функция ЗаписатьJSON(Данные)
    Попытка
        // Для 1С 8.3.15+
        ЗаписьJSON = Новый ЗаписьJSON;
        ЗаписьJSON.УстановитьСтроку();
        ЗаписатьJSON(ЗаписьJSON, Данные);
        Возврат ЗаписьJSON.Закрыть();
    Исключение
        // Для старых версий 1С
        Возврат РаботаСДанными.ЗаписатьJSON(Данные);
    КонецПопытки;
КонецФункции
```

### 2. Обработчики событий документов

Додайте ці обробники в модулі відповідних документів:

#### Для документу "Справочник.Контрагенты"

```1c
// В модуле объекта справочника Контрагенты
Процедура ПриЗаписи(Отказ)
    Если Отказ Тогда
        Возврат;
    КонецЕсли;
    
    Попытка
        // Определяем действие
        Действие = ?(ЭтоНовый(), "create", "update");
        
        // Отправляем данные в ERP
        ОтправитьДанныеКлиента(ЭтотОбъект, Действие);
        
    Исключение
        ЗаписатьЛог("Ошибка синхронизации клиента: " + ОписаниеОшибки());
    КонецПопытки;
КонецПроцедуры

Процедура ПередУдалением(Отказ)
    Если Отказ Тогда
        Возврат;
    КонецЕсли;
    
    Попытка
        // Отправляем данные в ERP
        ОтправитьДанныеКлиента(ЭтотОбъект, "delete");
        
    Исключение
        ЗаписатьЛог("Ошибка синхронизации удаления клиента: " + ОписаниеОшибки());
    КонецПопытки;
КонецПроцедуры
```

#### Для документу "Документ.ПоступлениеТоваровИУслуг"

```1c
// В модуле объекта документа ПоступлениеТоваровИУслуг
Процедура ПриЗаписи(Отказ)
    Если Отказ Тогда
        Возврат;
    КонецЕсли;
    
    // Синхронизируем только проведенные документы
    Если НЕ Проведен Тогда
        Возврат;
    КонецЕсли;
    
    Попытка
        // Определяем действие
        Действие = ?(ЭтоНовый(), "create", "update");
        
        // Отправляем данные в ERP
        ОтправитьДанныеНакладной(ЭтотОбъект, Действие);
        
    Исключение
        ЗаписатьЛог("Ошибка синхронизации накладной: " + ОписаниеОшибки());
    КонецПопытки;
КонецПроцедуры

Процедура ПередУдалением(Отказ)
    Если Отказ Тогда
        Возврат;
    КонецЕсли;
    
    Попытка
        // Отправляем данные в ERP
        ОтправитьДанныеНакладной(ЭтотОбъект, "delete");
        
    Исключение
        ЗаписатьЛог("Ошибка синхронизации удаления накладной: " + ОписаниеОшибки());
    КонецПопытки;
КонецПроцедуры
```

#### Для документу "Документ.СчетНаОплатуПокупателю"

```1c
// В модуле объекта документа СчетНаОплатуПокупателю
Процедура ПриЗаписи(Отказ)
    Если Отказ Тогда
        Возврат;
    КонецЕсли;
    
    // Синхронизируем только проведенные документы
    Если НЕ Проведен Тогда
        Возврат;
    КонецЕсли;
    
    Попытка
        // Определяем действие
        Действие = ?(ЭтоНовый(), "create", "update");
        
        // Отправляем данные в ERP
        ОтправитьДанныеВихідногоРахунку(ЭтотОбъект, Действие);
        
    Исключение
        ЗаписатьЛог("Ошибка синхронизации вихідного рахунку: " + ОписаниеОшибки());
    КонецПопытки;
КонецПроцедуры

Процедура ПередУдалением(Отказ)
    Если Отказ Тогда
        Возврат;
    КонецЕсли;
    
    Попытка
        // Отправляем данные в ERP
        ОтправитьДанныеВихідногоРахунку(ЭтотОбъект, "delete");
        
    Исключение
        ЗаписатьЛог("Ошибка синхронизации удаления вихідного рахунку: " + ОписаниеОшибки());
    КонецПопытки;
КонецПроцедуры
```

## Налаштування

### 1. Замініть URL
В коді замініть `your-erp-domain.com` на реальний домен вашої ERP системи.

### 2. Додайте код у 1С
1. Створіть новий загальний модуль `WebhookIntegration`
2. Скопіюйте основний код HTTP-сервісу
3. Додайте обробники подій в модулі відповідних документів

### 3. Налаштуйте права доступу
Переконайтеся, що у 1С є права на:
- Читання та запис документів
- Створення HTTP-з'єднань
- Запис файлів в c:\temp\

### 4. Тестування
1. Створіть або змініть клієнта в 1С
2. Перевірте лог файл `c:\temp\webhook_log.txt`
3. Перевірте в ERP чи з'явилися дані

## Логування
Всі дії записуються в файл `c:\temp\webhook_log.txt` для діагностики проблем.

## Безпека
- Використовується HTTPS з'єднання
- Передаються тільки необхідні дані
- Є обробка помилок без розкриття внутрішньої структури

## Підтримка
При виникненні проблем перевірте:
1. Логи 1С: `c:\temp\webhook_log.txt`
2. Логи ERP: в консолі сервера
3. Мережеве з'єднання між 1С та ERP
4. Коректність URL webhook'ів
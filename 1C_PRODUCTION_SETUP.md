# Налаштування 1C інтеграції для production

## 1. Підготовка 1C системи

### 1.1 Активація HTTP-сервісів у 1C
```1c
// У конфігураторі 1C створіть HTTP-сервіс "ERP_Integration"
// Шлях: /hs/invoices

// Створіть метод GetInvoices():
Функция GetInvoices() Экспорт
    Результат = Новый Массив;
    
    // Запит накладних з 1C
    Запрос = Новый Запрос;
    Запрос.Текст = "
        |ВЫБРАТЬ
        |    ПоступлениеТоваровУслуг.Ссылка КАК ID,
        |    ПоступлениеТоваровУслуг.Номер КАК НомерДокумента,
        |    ПоступлениеТоваровУслуг.Дата КАК Дата,
        |    ПоступлениеТоваровУслуг.Контрагент КАК Постачальник,
        |    ПоступлениеТоваровУслуг.СуммаДокумента КАК Сума,
        |    ПоступлениеТоваровУслуг.Валюта КАК Валюта
        |ИЗ
        |    Документ.ПоступлениеТоваровУслуг КАК ПоступлениеТоваровУслуг
        |ГДЕ
        |    ПоступлениеТоваровУслуг.Проведен = ИСТИНА
        |    И ПоступлениеТоваровУслуг.Дата >= &НачалоПериода
        |УПОРЯДОЧИТЬ ПО
        |    ПоступлениеТоваровУслуг.Дата УБЫВ
        |";
    
    Запрос.УстановитьПараметр("НачалоПериода", ТекущаяДата() - 30*24*3600); // 30 днів
    
    Выборка = Запрос.Выполнить().Выбрать();
    
    Пока Выборка.Следующий() Цикл
        НакладнаяСтрока = Новый Структура;
        НакладнаяСтрока.Вставить("ID", Строка(Выборка.ID.УникальныйИдентификатор()));
        НакладнаяСтрока.Вставить("НомерДокумента", Выборка.НомерДокумента);
        НакладнаяСтрока.Вставить("Дата", Формат(Выборка.Дата, "ДФ=yyyy-MM-dd"));
        НакладнаяСтрока.Вставить("Постачальник", Строка(Выборка.Постачальник));
        НакладнаяСтрока.Вставить("Сума", Выборка.Сума);
        НакладнаяСтрока.Вставить("Валюта", Строка(Выборка.Валюта));
        НакладнаяСтрока.Вставить("Статус", "new");
        
        // Отримуємо позиції накладної
        Позиції = Новый Массив;
        ЗапросПозиций = Новый Запрос;
        ЗапросПозиций.Текст = "
            |ВЫБРАТЬ
            |    ПоступлениеТоваровУслугТовары.Номенклатура КАК Назва,
            |    ПоступлениеТоваровУслугТовары.Количество КАК Кількість,
            |    ПоступлениеТоваровУслугТовары.Цена КАК Ціна,
            |    ПоступлениеТоваровУслугТовары.Сумма КАК Сума,
            |    ПоступлениеТоваровУслугТовары.ЕдиницаИзмерения КАК ОдиницяВиміру
            |ИЗ
            |    Документ.ПоступлениеТоваровУслуг.Товары КАК ПоступлениеТоваровУслугТовары
            |ГДЕ
            |    ПоступлениеТоваровУслугТовары.Ссылка = &Ссылка
            |";
        ЗапросПозиций.УстановитьПараметр("Ссылка", Выборка.ID);
        
        ВыборкаПозиций = ЗапросПозиций.Выполнить().Выбрать();
        Пока ВыборкаПозиций.Следующий() Цикл
            ПозицияСтрока = Новый Структура;
            ПозицияСтрока.Вставить("Назва", Строка(ВыборкаПозиций.Назва));
            ПозицияСтрока.Вставить("Кількість", ВыборкаПозиций.Кількість);
            ПозицияСтрока.Вставить("Ціна", ВыборкаПозиций.Ціна);
            ПозицияСтрока.Вставить("Сума", ВыборкаПозиций.Сума);
            ПозицияСтрока.Вставить("ОдиницяВиміру", Строка(ВыборкаПозиций.ОдиницяВиміру));
            
            Позиції.Добавить(ПозицияСтрока);
        КонецЦикла;
        
        НакладнаяСтрока.Вставить("Позиції", Позиції);
        Результат.Добавить(НакладнаяСтрока);
    КонецЦикла;
    
    Возврат Результат;
КонецФункции
```

### 1.2 Налаштування доступу
1. Увімкніть публікацію веб-сервісу у 1C
2. Створіть користувача для інтеграції з правами читання документів
3. Налаштуйте брандмауер для доступу до порту 1C

## 2. Налаштування в ERP системі

### 2.1 Через веб-інтерфейс
1. Увійдіть в систему REGMIK ERP
2. Перейдіть в розділ "Інтеграції"
3. Виберіть 1C інтеграцію
4. Вкажіть:
   - **Base URL**: `http://IP_АДРЕСА_1C:ПОРТ` (наприклад: `http://192.168.1.100:8080`)
   - **Client ID**: ім'я користувача 1C
   - **Client Secret**: пароль користувача 1C

### 2.2 Через SQL (для швидкого налаштування)
```sql
UPDATE integration_configs 
SET config = jsonb_set(
    jsonb_set(
        jsonb_set(config, '{baseUrl}', '"http://192.168.1.100:8080"'),
        '{clientId}', '"integration_user"'
    ),
    '{clientSecret}', '"your_password"'
)
WHERE type = '1c_accounting' AND name = '1c_import';
```

### 2.3 Тестування з'єднання
1. Натисніть "Тестувати з'єднання" в інтерфейсі інтеграцій
2. Переконайтеся, що отримали відповідь "З'єднання успішне"

## 3. Типові проблеми та їх вирішення

### 3.1 Помилка "fetch failed"
- Перевірте доступність 1C сервера з ERP системи
- Переконайтеся, що порт відкритий у брандмауері
- Спробуйте ping до сервера 1C

### 3.2 Помилка "HTTP 401 Unauthorized"
- Перевірте правильність логіна та пароля
- Переконайтеся, що користувач має права доступу до веб-сервісів

### 3.3 Помилка "HTTP 404 Not Found"
- Перевірте, чи правильно опублікований веб-сервіс
- Переконайтеся, що шлях `/hs/invoices` існує

## 4. Налагодження

### 4.1 Логи системи
Система пише детальні логи з'єднання з 1C. Дивіться консоль сервера для діагностики.

### 4.2 Ручне тестування
```bash
# Тестування з'єднання з 1C
curl -u "username:password" http://IP_АДРЕСА_1C:ПОРТ/hs/invoices

# Має повернути JSON з накладними
```

## 5. Безпека

1. Використовуйте HTTPS для production систем
2. Створіть окремого користувача тільки для інтеграції
3. Обмежте права доступу до мінімуму необхідного
4. Регулярно змінюйте паролі для інтеграції
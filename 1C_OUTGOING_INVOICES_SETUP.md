# Настройка 1С интеграции для исходящих счетов

## Описание

Данная документация описывает настройку HTTP-сервиса в 1С для передачи исходящих счетов (выставленных клиентам) в ERP систему REGMIK.

## Структура исходящих счетов

Исходящие счета - это документы, которые организация выставляет своим клиентам за товары или услуги. В отличие от входящих счетов от поставщиков, исходящие счета представляют дебиторскую задолженность.

## Настройка HTTP-сервиса в 1С

### 1. Создание HTTP-сервиса

1. Откройте конфигуратор 1С
2. Перейдите в раздел "Общие" → "HTTP-сервисы"
3. Создайте новый HTTP-сервис с именем `ERPOutgoingInvoices`
4. Добавьте шаблон URL: `outgoing-invoices`
5. Создайте HTTP-метод `POST`

### 2. Код обработчика для исходящих счетов

```1c
// Обработчик HTTP-сервиса для исходящих счетов
Функция outgoing_invoicesПОСТ(Запрос)
    
    // Инициализация ответа
    Ответ = Новый HTTPСервисОтвет(200);
    Ответ.УстановитьТелоИзСтроки("", КодировкаТекста.UTF8, "application/json");
    
    Попытка
        // Создаем объект для логирования
        ДатаВремя = ТекущаяДата();
        ИмяФайлаЛога = "c:\temp\erp_outgoing_debug.txt";
        
        // Получаем параметры из тела запроса
        ТелоЗапроса = Запрос.ПолучитьТелоКакСтроку("utf-8");
        
        // Записываем в лог
        ЗаписатьВФайл(ИмяФайлаЛога, Формат(ДатаВремя, "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " - Получен запрос исходящих счетов: " + ТелоЗапроса + Символы.ПС);
        
        // Парсим JSON (сумісність з різними версіями 1С)
        Попытка
            ПарсерJSON = Новый ПарсерJSON();
            ПараметрыЗапроса = ПарсерJSON.ПрочитатьJSON(ТелоЗапроса);
        Исключение
            // Для старих версій 1С використовуємо ПрочитатьJSON з загального модуля
            ПараметрыЗапроса = ПрочитатьJSON(ТелоЗапроса);
        КонецПопытки;
        
        Если ПараметрыЗапроса.Свойство("action") И ПараметрыЗапроса.action = "getOutgoingInvoices" Тогда
            
            // Получаем лимит записей
            Лимит = 100;
            Если ПараметрыЗапроса.Свойство("limit") Тогда
                Лимит = ПараметрыЗапроса.limit;
            КонецЕсли;
            
            // Получаем данные исходящих счетов
            МассивСчетов = ПолучитьДанныеИсходящихСчетов(Лимит);
            
            // Формируем ответ
            ОтветJSON = Новый Структура;
            ОтветJSON.Вставить("invoices", МассивСчетов);
            ОтветJSON.Вставить("total", МассивСчетов.Количество());
            ОтветJSON.Вставить("timestamp", Формат(ТекущаяДата(), "ДФ=yyyy-MM-dd ВФ=HH:mm:ss"));
            
            // Преобразуем в JSON (сумісність з різними версіями 1С)
            Попытка
                ЗаписьJSON = Новый ЗаписьJSON;
                ЗаписьJSON.УстановитьСтроку();
                ЗаписатьJSON(ЗаписьJSON, ОтветJSON);
                СтрокаJSON = ЗаписьJSON.Закрыть();
            Исключение
                // Для старих версій 1С пробуємо різні варіанти
                Попытка
                    // Спочатку пробуємо функцію ЗаписатьJSON з одним параметром
                    СтрокаJSON = ЗаписатьJSON(ОтветJSON);
                Исключение
                    // Пробуємо з додатковими параметрами (деякі версії 1С)
                    Попытка
                        СтрокаJSON = ЗаписатьJSON(ОтветJSON, Ложь);
                    Исключение
                        // Якщо ЗаписатьJSON - процедура, використовуємо інший підхід
                        Попытка
                            ЗаписьJSON = Новый ЗаписьJSON;
                            ЗаписьJSON.УстановитьСтроку();
                            ЗаписатьJSON(ЗаписьJSON, ОтветJSON); // Процедура
                            СтрокаJSON = ЗаписьJSON.Закрыть();
                        Исключение
                            // Якщо нічого не працює, формуємо JSON вручну
                            СтрокаJSON = "{""error"":""Не удалось сформировать JSON""}";
                        КонецПопытки;
                    КонецПопытки;
                КонецПопытки;
            КонецПопытки;
            
            // Записываем в лог успешный результат
            ЗаписатьВФайл(ИмяФайлаЛога, Формат(ДатаВремя, "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " - Успешно получено исходящих счетов: " + МассивСчетов.Количество() + Символы.ПС);
            
            // Возвращаем результат
            Ответ.УстановитьТелоИзСтроки(СтрокаJSON, КодировкаТекста.UTF8, "application/json");
            
        Иначе
            // Неизвестное действие
            ОтветОшибка = Новый Структура;
            ОтветОшибка.Вставить("error", "Неизвестное действие");
            ОтветОшибка.Вставить("action", ПараметрыЗапроса.action);
            
            Попытка
                ЗаписьJSON = Новый ЗаписьJSON;
                ЗаписьJSON.УстановитьСтроку();
                ЗаписатьJSON(ЗаписьJSON, ОтветОшибка);
                СтрокаJSON = ЗаписьJSON.Закрыть();
            Исключение
                Попытка
                    СтрокаJSON = ЗаписатьJSON(ОтветОшибка);
                Исключение
                    Попытка
                        СтрокаJSON = ЗаписатьJSON(ОтветОшибка, Ложь);
                    Исключение
                        СтрокаJSON = "{""error"":""Неизвестное действие""}";
                    КонецПопытки;
                КонецПопытки;
            КонецПопытки;
            
            Ответ.УстановитьТелоИзСтроки(СтрокаJSON, КодировкаТекста.UTF8, "application/json");
            Ответ.КодСостояния = 400;
        КонецЕсли;
        
    Исключение
        // Обработка ошибки
        ТекстОшибки = ОписаниеОшибки();
        
        // Записываем ошибку в лог
        ЗаписатьВФайл(ИмяФайлаЛога, Формат(ДатаВремя, "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " - ОШИБКА: " + ТекстОшибки + Символы.ПС);
        
        // Формируем ответ об ошибке
        ОтветОшибка = Новый Структура;
        ОтветОшибка.Вставить("error", "Ошибка сервера");
        ОтветОшибка.Вставить("details", ТекстОшибки);
        
        Попытка
            ЗаписьJSON = Новый ЗаписьJSON;
            ЗаписьJSON.УстановитьСтроку();
            ЗаписатьJSON(ЗаписьJSON, ОтветОшибка);
            СтрокаJSON = ЗаписьJSON.Закрыть();
        Исключение
            Попытка
                СтрокаJSON = ЗаписатьJSON(ОтветОшибка);
            Исключение
                Попытка
                    СтрокаJSON = ЗаписатьJSON(ОтветОшибка, Ложь);
                Исключение
                    СтрокаJSON = "{""error"":""Ошибка сервера""}";
                КонецПопытки;
            КонецПопытки;
        КонецПопытки;
        
        Ответ.УстановитьТелоИзСтроки(СтрокаJSON, "application/json", "utf-8");
        Ответ.КодСостояния = 500;
    КонецПопытки;
    
    Возврат Ответ;
    
КонецФункции

// Функция получения данных исходящих счетов
Функция ПолучитьДанныеИсходящихСчетов(Лимит)
    
    МассивСчетов = Новый Массив;
    
    Попытка
        // Запрос исходящих счетов (выставленных клиентам)
        Запрос = Новый Запрос;
        Запрос.Текст = "
        |ВЫБРАТЬ ПЕРВЫЕ " + Лимит + "
        |    СчетНаОплату.Ссылка КАК Ссылка,
        |    СчетНаОплату.Номер КАК НомерДокумента,
        |    СчетНаОплату.Дата КАК ДатаДокумента,
        |    СчетНаОплату.Контрагент КАК Клиент,
        |    СчетНаОплату.СуммаДокумента КАК Сумма,
        |    СчетНаОплату.Валюта КАК Валюта,
        |    СчетНаОплату.Статус КАК Статус,
        |    СчетНаОплату.Комментарий КАК Примечание,
        |    ВЫБОР
        |        КОГДА СчетНаОплату.Проведен ТОГДА ""confirmed""
        |        ИНАЧЕ ""draft""
        |    КОНЕЦ КАК СтатусДокумента
        |ИЗ
        |    Документ.СчетНаОплату КАК СчетНаОплату
        |ГДЕ
        |    СчетНаОплату.Дата >= &ДатаС
        |    И НЕ СчетНаОплату.ПометкаУдаления
        |УПОРЯДОЧИТЬ ПО
        |    СчетНаОплату.Дата УБЫВ";
        
        // Параметры запроса (последние 30 дней)
        Запрос.УстановитьПараметр("ДатаС", ТекущаяДата() - 30*86400);
        
        РезультатЗапроса = Запрос.Выполнить();
        ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
        
        Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
            
            СтруктураСчета = Новый Структура;
            СтруктураСчета.Вставить("ID", Строка(ВыборкаДетальныеЗаписи.Ссылка.УникальныйИдентификатор()));
            СтруктураСчета.Вставить("НомерДокумента", ВыборкаДетальныеЗаписи.НомерДокумента);
            СтруктураСчета.Вставить("ДатаДокумента", Формат(ВыборкаДетальныеЗаписи.ДатаДокумента, "ДФ=yyyy-MM-dd"));
            
            // Получаем наименование клиента
            Если ЗначениеЗаполнено(ВыборкаДетальныеЗаписи.Клиент) Тогда
                СтруктураСчета.Вставить("Клиент", Строка(ВыборкаДетальныеЗаписи.Клиент));
            Иначе
                СтруктураСчета.Вставить("Клиент", "Неизвестный клиент");
            КонецЕсли;
            
            // Сумма с проверкой типа
            Если ТипЗнч(ВыборкаДетальныеЗаписи.Сумма) = Тип("Число") Тогда
                СтруктураСчета.Вставить("Сумма", Строка(ВыборкаДетальныеЗаписи.Сумма));
            Иначе
                СтруктураСчета.Вставить("Сумма", "0");
            КонецЕсли;
            
            // Валюта
            Если ЗначениеЗаполнено(ВыборкаДетальныеЗаписи.Валюта) Тогда
                СтруктураСчета.Вставить("Валюта", Строка(ВыборкаДетальныеЗаписи.Валюта));
            Иначе
                СтруктураСчета.Вставить("Валюта", "UAH");
            КонецЕсли;
            
            // Статус документа
            СтруктураСчета.Вставить("Статус", ВыборкаДетальныеЗаписи.СтатусДокумента);
            
            // Статус оплаты (определяем по оплаченным суммам)
            СтатусОплаты = ПолучитьСтатусОплатыСчета(ВыборкаДетальныеЗаписи.Ссылка);
            СтруктураСчета.Вставить("СтатусОплаты", СтатусОплаты);
            
            // Примечание
            Если ЗначениеЗаполнено(ВыборкаДетальныеЗаписи.Примечание) Тогда
                СтруктураСчета.Вставить("Примечание", Строка(ВыборкаДетальныеЗаписи.Примечание));
            Иначе
                СтруктураСчета.Вставить("Примечание", "");
            КонецЕсли;
            
            // Получаем позиции счета
            Позиции = ПолучитьПозицииСчета(ВыборкаДетальныеЗаписи.Ссылка);
            СтруктураСчета.Вставить("Позиции", Позиции);
            
            МассивСчетов.Добавить(СтруктураСчета);
            
        КонецЦикла;
        
    Исключение
        // При ошибке возвращаем пустой массив
        ТекстОшибки = ОписаниеОшибки();
        ЗаписатьВФайл("c:\temp\erp_outgoing_debug.txt", Формат(ТекущаяДата(), "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " - ОШИБКА запроса исходящих счетов: " + ТекстОшибки + Символы.ПС);
        МассивСчетов = Новый Массив;
    КонецПопытки;
    
    Возврат МассивСчетов;
    
КонецФункции

// Функция получения позиций счета
Функция ПолучитьПозицииСчета(СсылкаНаСчет)
    
    МассивПозиций = Новый Массив;
    
    Попытка
        Запрос = Новый Запрос;
        Запрос.Текст = "
        |ВЫБРАТЬ
        |    СчетНаОплатуТовары.Номенклатура КАК Номенклатура,
        |    СчетНаОплатуТовары.Количество КАК Количество,
        |    СчетНаОплатуТовары.Цена КАК Цена,
        |    СчетНаОплатуТовары.Сумма КАК Сумма
        |ИЗ
        |    Документ.СчетНаОплату.Товары КАК СчетНаОплатуТовары
        |ГДЕ
        |    СчетНаОплатуТовары.Ссылка = &Ссылка";
        
        Запрос.УстановитьПараметр("Ссылка", СсылкаНаСчет);
        
        РезультатЗапроса = Запрос.Выполнить();
        ВыборкаПозиций = РезультатЗапроса.Выбрать();
        
        Пока ВыборкаПозиций.Следующий() Цикл
            
            СтруктураПозиции = Новый Структура;
            
            // Наименование товара/услуги
            Если ЗначениеЗаполнено(ВыборкаПозиций.Номенклатура) Тогда
                СтруктураПозиции.Вставить("productName", Строка(ВыборкаПозиций.Номенклатура));
            Иначе
                СтруктураПозиции.Вставить("productName", "Неизвестный товар");
            КонецЕсли;
            
            // Количество
            Если ТипЗнч(ВыборкаПозиций.Количество) = Тип("Число") Тогда
                СтруктураПозиции.Вставить("quantity", ВыборкаПозиций.Количество);
            Иначе
                СтруктураПозиции.Вставить("quantity", 1);
            КонецЕсли;
            
            // Цена
            Если ТипЗнч(ВыборкаПозиций.Цена) = Тип("Число") Тогда
                СтруктураПозиции.Вставить("price", ВыборкаПозиций.Цена);
            Иначе
                СтруктураПозиции.Вставить("price", 0);
            КонецЕсли;
            
            // Сумма
            Если ТипЗнч(ВыборкаПозиций.Сумма) = Тип("Число") Тогда
                СтруктураПозиции.Вставить("total", ВыборкаПозиций.Сумма);
            Иначе
                СтруктураПозиции.Вставить("total", 0);
            КонецЕсли;
            
            МассивПозиций.Добавить(СтруктураПозиции);
            
        КонецЦикла;
        
    Исключение
        // При ошибке возвращаем пустой массив
        ТекстОшибки = ОписаниеОшибки();
        ЗаписатьВФайл("c:\temp\erp_outgoing_debug.txt", Формат(ТекущаяДата(), "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " - ОШИБКА получения позиций счета: " + ТекстОшибки + Символы.ПС);
        МассивПозиций = Новый Массив;
    КонецПопытки;
    
    Возврат МассивПозиций;
    
КонецФункции

// Функция определения статуса оплаты
Функция ПолучитьСтатусОплатыСчета(СсылкаНаСчет)
    
    Попытка
        // Запрос оплат по счету
        Запрос = Новый Запрос;
        Запрос.Текст = "
        |ВЫБРАТЬ
        |    СУММА(ПоступлениеНаРасчетныйСчет.Сумма) КАК СуммаОплат
        |ИЗ
        |    Документ.ПоступлениеНаРасчетныйСчет КАК ПоступлениеНаРасчетныйСчет
        |ГДЕ
        |    ПоступлениеНаРасчетныйСчет.СчетНаОплату = &Счет
        |    И ПоступлениеНаРасчетныйСчет.Проведен";
        
        Запрос.УстановитьПараметр("Счет", СсылкаНаСчет);
        
        РезультатЗапроса = Запрос.Выполнить();
        
        Если РезультатЗапроса.Пустой() Тогда
            Возврат "unpaid";
        КонецЕсли;
        
        ВыборкаОплат = РезультатЗапроса.Выбрать();
        ВыборкаОплат.Следующий();
        
        СуммаОплат = ВыборкаОплат.СуммаОплат;
        
        // Получаем сумму счета
        СуммаСчета = СсылкаНаСчет.СуммаДокумента;
        
        Если СуммаОплат = 0 Тогда
            Возврат "unpaid";
        ИначеЕсли СуммаОплат >= СуммаСчета Тогда
            Возврат "paid";
        Иначе
            Возврат "partial";
        КонецЕсли;
        
    Исключение
        // При ошибке считаем неоплаченным
        Возврат "unpaid";
    КонецПопытки;
    
КонецФункции

// Функция записи в файл
Функция ЗаписатьВФайл(ИмяФайла, Текст)
    
    Попытка
        ФайлДляЗаписи = Новый ТекстовыйДокумент;
        
        Файл = Новый Файл(ИмяФайла);
        Если Файл.Существует() Тогда
            ФайлДляЗаписи.Прочитать(ИмяФайла, "UTF-8");
        КонецЕсли;
        
        ФайлДляЗаписи.ДобавитьСтроку(Текст);
        ФайлДляЗаписи.Записать(ИмяФайла, "UTF-8");
        
    Исключение
        // Игнорируем ошибки записи в лог
    КонецПопытки;
    
КонецФункции
```

## Настройка в ERP системе

### 1. Конфигурация интеграции

1. Откройте страницу "Интеграции" в ERP системе
2. Найдите или создайте интеграцию типа "1С Учет"
3. Укажите URL: `http://your-1c-server:port/base/hs/ERPOutgoingInvoices/outgoing-invoices`
4. Настройте авторизацию (логин/пароль)
5. Активируйте интеграцию

### 2. Тестирование

1. Нажмите кнопку "Тест соединения"
2. Убедитесь, что связь установлена
3. Используйте кнопку "Импорт вихідних рахунків з 1С"
4. Проверьте логи в файле `c:\temp\erp_outgoing_debug.txt`

## Отличия от входящих счетов

| Параметр | Входящие счета | Исходящие счета |
|----------|---------------|-----------------|
| Документ 1С | ПоступлениеТоваров | СчетНаОплату |
| Контрагент | Поставщик | Клиент |
| Тип операции | Расход денег | Приход денег |
| Статус оплаты | Оплачен поставщику | Оплачен клиентом |
| Направление | Приход товаров | Продажа товаров |

## Логирование

Все операции записываются в файл `c:\temp\erp_outgoing_debug.txt` с отметками времени и детальной информацией о процессе.

## Устранение неполадок

1. **Нет данных**: Проверьте, есть ли в 1С документы "Счет на оплату"
2. **Ошибка доступа**: Убедитесь, что HTTP-сервис опубликован
3. **Ошибка авторизации**: Проверьте логин/пароль в настройках интеграции
4. **Проблемы с кодировкой**: Все данные передаются в UTF-8
5. **Ошибка "ПарсерJSON не определен"**: Код содержит обработку для разных версий 1С
6. **Ошибка "ЗаписьJSON не определен"**: Используется fallback для старых версий 1С
7. **Ошибка "Обращение к процедуре как к функции (ЗаписатьJSON)"**: Код автоматически определяет тип ЗаписатьJSON
8. **Ошибка "Недостаточно фактических параметров (ЗаписатьJSON)"**: Код пробует разные варианты вызова функции
9. **Ошибка "Обращение к процедуре как к функции"**: Используйте упрощённый код 1C_OUTGOING_INVOICES_PROCEDURE_VERSION.md

### Сумісність з версіями 1С

Код автоматично адаптується до различных версий 1С:
- **1С 8.3.15+**: Використовує нативні об'єкти ПарсерJSON та ЗаписьJSON
- **1С 8.3.14 та старіші**: Використовує загальні функції модуля ПрочитатьJSON() та ЗаписатьJSON()
- **Всі версії**: Автоматично визначає чи ЗаписатьJSON це функція або процедура

### Особливості різних версій 1С:

1. **ПарсерJSON**:
   - 1С 8.3.15+: Об'єкт ПарсерJSON доступний
   - Старіші версії: Використовується функція ПрочитатьJSON()

2. **ЗаписатьJSON**:
   - Функція з одним параметром: `СтрокаJSON = ЗаписатьJSON(Данные)`
   - Функція з двома параметрами: `СтрокаJSON = ЗаписатьJSON(Данные, Ложь)`
   - Процедура з об'єктом: `ЗаписатьJSON(ЗаписьJSON, Данные)`

3. **Обробка помилок**:
   - Код використовує каскадні try-catch блоки
   - Якщо нічого не працює, формується JSON вручну

## Рекомендації для різних версій 1С

### Якщо отримуєте помилки "Звернення до процедури як до функції"

**Рішення**: Використовуйте спрощений код з файлу `1C_OUTGOING_INVOICES_PROCEDURE_VERSION.md`

**Переваги спрощеного коду**:
- Не використовує ЗаписатьJSON зовсім
- Формує JSON вручну через конкатенацію рядків
- Працює в будь-якій версії 1С
- Простий та зрозумілий код

### Якщо JSON функції працюють частково

**Рішення**: Використовуйте основний код з файлу `1C_OUTGOING_INVOICES_SETUP.md`

**Переваги основного коду**:
- Автоматично адаптується до версії 1С
- Використовує нативні JSON функції коли можливо
- Fallback на ручне формування JSON

### Універсальні рекомендації

1. **Для стабільності**: Завжди використовуйте спрощений код з PROCEDURE_VERSION
2. **Для продуктивності**: Використовуйте основний код якщо немає помилок
3. **Для відладки**: Додавайте логування в c:\temp\erp_outgoing_debug.txt

### Перевірка версії 1С

Для перевірки версії 1С використовуйте:
```1c
Сообщить("Версия 1С: " + Строка(Метаданные.Версия));
```

## Статусы документов

- `draft` - черновик, не проведен
- `confirmed` - проведен
- `cancelled` - помечен на удаление

## Статусы оплаты

- `unpaid` - не оплачен
- `partial` - частично оплачен  
- `paid` - полностью оплачен
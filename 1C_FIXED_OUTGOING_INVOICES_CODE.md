# Исправленный код 1С для передачи позиций рахунків

## Проблема
В текущем коде функция `ПолучитьПозицииСчета` существует, но НЕ ВЫЗЫВАЕТСЯ в основной функции. Позиции рахунків не передаются в ERP.

## Исправленный код

```1c
// Обработчик HTTP-сервиса для исходящих счетов
Функция outgoing_invoicesПОСТ(Запрос)
    
    // Инициализация ответа
    Ответ = Новый HTTPСервисОтвет(200);
    
    // Имя файла лога
    ИмяФайлаЛога = "c:\temp\erp_outgoing_debug.txt";
    ДатаВремя = ТекущаяДата();
    
    Попытка
        // Получаем тело запроса
        ТелоЗапроса = Запрос.ПолучитьТелоКакСтроку();
        
        // Логируем запрос
        ЗаписатьВФайл(ИмяФайлаЛога, Формат(ДатаВремя, "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " - Получен запрос: " + ТелоЗапроса + Символы.ПС);
        
        // Парсим JSON вручную (избегаем ПрочитатьJSON)
        action = "";
        limit = 100;
        
        // Простой парсинг action
        Если СтрНайти(ТелоЗапроса, """getOutgoingInvoices""") > 0 Тогда
            action = "getOutgoingInvoices";
        КонецЕсли;
        
        // Простой парсинг limit
        ПозицияLimit = СтрНайти(ТелоЗапроса, """limit"":");
        Если ПозицияLimit > 0 Тогда
            ОстатокСтроки = Сред(ТелоЗапроса, ПозицияLimit + 8);
            ПозицияЧисла = 1;
            НачалоЧисла = 0;
            Пока ПозицияЧисла <= СтрДлина(ОстатокСтроки) Цикл
                Символ = Сред(ОстатокСтроки, ПозицияЧисла, 1);
                Если Символ >= "0" И Символ <= "9" Тогда
                    НачалоЧисла = ПозицияЧисла;
                    Прервать;
                КонецЕсли;
                ПозицияЧисла = ПозицияЧисла + 1;
            КонецЦикла;
            
            Если НачалоЧисла > 0 Тогда
                КонецЧисла = НачалоЧисла;
                Пока КонецЧисла <= СтрДлина(ОстатокСтроки) Цикл
                    Символ = Сред(ОстатокСтроки, КонецЧисла, 1);
                    Если НЕ (Символ >= "0" И Символ <= "9") Тогда
                        Прервать;
                    КонецЕсли;
                    КонецЧисла = КонецЧисла + 1;
                КонецЦикла;
                
                СтрокаЧисла = Сред(ОстатокСтроки, НачалоЧисла, КонецЧисла - НачалоЧисла);
                Попытка
                    limit = Число(СтрокаЧисла);
                Исключение
                    limit = 100;
                КонецПопытки;
            КонецЕсли;
        КонецЕсли;
        
        // Проверяем action
        Если action = "getOutgoingInvoices" Тогда
            
            // ✅ ИСПРАВЛЕНО: Получаем данные С ПОЗИЦИЯМИ
            МассивСчетов = ПолучитьРеальныеИсходящиеСчетаСПозициями(limit);
            
            // Формируем JSON вручную С ПОЗИЦИЯМИ
            СтрокаJSON = "{""invoices"":[";
            Для Индекс = 0 По МассивСчетов.Количество() - 1 Цикл
                Счет = МассивСчетов[Индекс];
                Если Индекс > 0 Тогда
                    СтрокаJSON = СтрокаJSON + ",";
                КонецЕсли;
                СтрокаJSON = СтрокаJSON + "{";
                СтрокаJSON = СтрокаJSON + """invoiceNumber"":""" + ОчиститьСтрокуДляJSON(Счет.invoiceNumber) + """,";
                СтрокаJSON = СтрокаJSON + """date"":""" + ОчиститьСтрокуДляJSON(Счет.date) + """,";
                СтрокаJSON = СтрокаJSON + """client"":""" + ОчиститьСтрокуДляJSON(Счет.client) + """,";
                СтрокаJSON = СтрокаJSON + """amount"":" + Формат(Счет.amount, "ЧДЦ=2; ЧРД=.; ЧГ=") + ",";
                СтрокаJSON = СтрокаJSON + """currency"":""" + ОчиститьСтрокуДляJSON(Счет.currency) + """,";
                СтрокаJSON = СтрокаJSON + """notes"":""" + ОчиститьСтрокуДляJSON(Счет.notes) + """,";
                СтрокаJSON = СтрокаJSON + """status"":""" + ОчиститьСтрокуДляJSON(Счет.status) + """,";
                
                // ✅ ДОБАВЛЯЕМ ПОЗИЦИИ
                СтрокаJSON = СтрокаJSON + """positions"":[";
                Для ИндексПоз = 0 По Счет.positions.Количество() - 1 Цикл
                    Позиция = Счет.positions[ИндексПоз];
                    Если ИндексПоз > 0 Тогда
                        СтрокаJSON = СтрокаJSON + ",";
                    КонецЕсли;
                    СтрокаJSON = СтрокаJSON + "{";
                    СтрокаJSON = СтрокаJSON + """productName"":""" + ОчиститьСтрокуДляJSON(Позиция.productName) + """,";
                    СтрокаJSON = СтрокаJSON + """quantity"":" + Формат(Позиция.quantity, "ЧДЦ=2; ЧРД=.; ЧГ=") + ",";
                    СтрокаJSON = СтрокаJSON + """price"":" + Формат(Позиция.price, "ЧДЦ=2; ЧРД=.; ЧГ=") + ",";
                    СтрокаJSON = СтрокаJSON + """total"":" + Формат(Позиция.total, "ЧДЦ=2; ЧРД=.; ЧГ=");
                    СтрокаJSON = СтрокаJSON + "}";
                КонецЦикла;
                СтрокаJSON = СтрокаJSON + "]";
                
                СтрокаJSON = СтрокаJSON + "}";
            КонецЦикла;
            СтрокаJSON = СтрокаJSON + "],";
            СтрокаJSON = СтрокаJSON + """total"":" + Формат(МассивСчетов.Количество(), "ЧГ=") + ",";
            СтрокаJSON = СтрокаJSON + """timestamp"":""" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-dd ВФ=HH:mm:ss") + """";
            СтрокаJSON = СтрокаJSON + "}";
            
            ЗаписатьВФайл(ИмяФайлаЛога, СтрокаJSON);

            // Логируем успех
            ЗаписатьВФайл(ИмяФайлаЛога, Формат(ДатаВремя, "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " - Успешно: " + МассивСчетов.Количество() + " счетов с позициями" + Символы.ПС);
            
            // Возвращаем результат
            Ответ.УстановитьТелоИзСтроки(СтрокаJSON, КодировкаТекста.UTF8);
            Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");

            ЗаписатьВФайл(ИмяФайлаЛога, "Отправлено " + МассивСчетов.Количество() + " счетов с позициями");
           
        Иначе
            // Неверный action
            СтрокаJSON = "{""error"":""Неизвестное действие""}";
            Ответ.УстановитьТелоИзСтроки(СтрокаJSON);
            Ответ.КодСостояния = 400;
        КонецЕсли;
        
    Исключение
        // Обработка ошибки
        ТекстОшибки = ОписаниеОшибки();
        
        // Логируем ошибку
        ЗаписатьВФайл(ИмяФайлаЛога, Формат(ДатаВремя, "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " - ОШИБКА: " + ТекстОшибки + Символы.ПС);
        
        // Возвращаем ошибку
        СтрокаJSON = "{""error"":""Ошибка сервера""}";
        Ответ.УстановитьТелоИзСтроки(СтрокаJSON);
        Ответ.КодСостояния = 500;
    КонецПопытки;
             
    Возврат Ответ;
    
КонецФункции

// ✅ НОВАЯ функция получения реальных исходящих счетов С ПОЗИЦИЯМИ
Функция ПолучитьРеальныеИсходящиеСчетаСПозициями(Лимит)
    
    МассивСчетов = Новый Массив;
    ИмяФайлаЛога = "c:\temp\erp_outgoing_debug.txt";
    
    Попытка
        ЗаписатьВФайл(ИмяФайлаЛога, Формат(ТекущаяДата(), "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " - Начинаем запрос счетов с позициями" + Символы.ПС);
        
        // Создаем запрос к базе данных 1С для получения исходящих счетов
        Запрос = Новый Запрос;
        Запрос.Текст = 
        "ВЫБРАТЬ ПЕРВЫЕ " + Лимит + "
        |    СчетаНаОплатуПокупателю.Ссылка КАК СсылкаДокумента,
        |    СчетаНаОплатуПокупателю.Номер КАК НомерСчета,
        |    СчетаНаОплатуПокупателю.Дата КАК ДатаСчета,
        |    СчетаНаОплатуПокупателю.Контрагент.Наименование КАК НаименованиеКонтрагента,
        |    СчетаНаОплатуПокупателю.СуммаДокумента КАК СуммаДокумента,
        |    СчетаНаОплатуПокупателю.ВалютаДокумента.Код КАК КодВалюты,
        |    СчетаНаОплатуПокупателю.Комментарий КАК Комментарий,
        |    ВЫБОР
        |        КОГДА СчетаНаОплатуПокупателю.Проведен = ИСТИНА ТОГДА ""posted""
        |        ИНАЧЕ ""draft""
        |    КОНЕЦ КАК СтатусДокумента
        |ИЗ
        |    Документ.СчетНаОплатуПокупателю КАК СчетаНаОплатуПокупателю
        |ГДЕ
        |    СчетаНаОплатуПокупателю.Проведен = ИСТИНА
        |    И СчетаНаОплатуПокупателю.ПометкаУдаления = ЛОЖЬ
        |    И СчетаНаОплатуПокупателю.Дата >= &НачалоПериода
        |УПОРЯДОЧИТЬ ПО
        |    СчетаНаОплатуПокупателю.Дата УБЫВ";
        
        // Устанавливаем параметр - последние 3 месяца
        Запрос.УстановитьПараметр("НачалоПериода", НачалоМесяца(ДобавитьМесяц(ТекущаяДата(), -3)));
        
        // Выполняем запрос
        Результат = Запрос.Выполнить();
        Выборка = Результат.Выбрать();
        
        СчетчикСчетов = 0;
        // Обрабатываем результаты
        Пока Выборка.Следующий() Цикл
            СчетчикСчетов = СчетчикСчетов + 1;
            ЗаписатьВФайл(ИмяФайлаЛога, "Обрабатываем счет " + СчетчикСчетов + ": " + Выборка.НомерСчета);
            
            СчетСтруктура = Новый Структура;
            СчетСтруктура.Вставить("invoiceNumber", СокрЛП(Выборка.НомерСчета));
            СчетСтруктура.Вставить("date", Формат(Выборка.ДатаСчета, "ДФ=yyyy-MM-dd"));
            СчетСтруктура.Вставить("client", СокрЛП(Выборка.НаименованиеКонтрагента));
            СчетСтруктура.Вставить("amount", Выборка.СуммаДокумента);
            СчетСтруктура.Вставить("currency", СокрЛП(Выборка.КодВалюты));
            СчетСтруктура.Вставить("notes", СокрЛП(Выборка.Комментарий));
            СчетСтруктура.Вставить("status", СокрЛП(Выборка.СтатусДокумента));
            
            // ✅ ГЛАВНОЕ ИСПРАВЛЕНИЕ: Получаем позиции счета
            ЗаписатьВФайл(ИмяФайлаЛога, "Получаем позиции для счета: " + Выборка.НомерСчета);
            Позиции = ПолучитьПозицииСчета(Выборка.СсылкаДокумента);
            СчетСтруктура.Вставить("positions", Позиции);
            ЗаписатьВФайл(ИмяФайлаЛога, "Найдено позиций: " + Позиции.Количество());
            
            МассивСчетов.Добавить(СчетСтруктура);
        КонецЦикла;
        
        // Логируем успешное получение данных
        ЗаписатьВФайл(ИмяФайлаЛога, 
            Формат(ТекущаяДата(), "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + 
            " - Получено из базы: " + МассивСчетов.Количество() + " реальных счетов с позициями" + Символы.ПС);
        
    Исключение
        // Если произошла ошибка с запросом, логируем и возвращаем пустой массив
        ТекстОшибки = ОписаниеОшибки();
        ЗаписатьВФайл(ИмяФайлаЛога, 
            Формат(ТекущаяДата(), "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + 
            " - ОШИБКА запроса к базе: " + ТекстОшибки + Символы.ПС);
    КонецПопытки;
    
    Возврат МассивСчетов;
    
КонецФункции

// ✅ ИСПРАВЛЕННАЯ функция получения позиций счета (исправлена таблица)
Функция ПолучитьПозицииСчета(СсылкаНаСчет)
    
    МассивПозиций = Новый Массив;
    ИмяФайлаЛога = "c:\temp\erp_outgoing_debug.txt";
    
    Попытка
        ЗаписатьВФайл(ИмяФайлаЛога, "Начинаем запрос позиций для документа...");
        
        Запрос = Новый Запрос;
        Запрос.Текст = "
        |ВЫБРАТЬ
        |    СчетаНаОплатуПокупателюТовары.Номенклатура КАК Номенклатура,
        |    СчетаНаОплатуПокупателюТовары.Номенклатура.Наименование КАК НаименованиеНоменклатуры,
        |    СчетаНаОплатуПокупателюТовары.Количество КАК Количество,
        |    СчетаНаОплатуПокупателюТовары.Цена КАК Цена,
        |    СчетаНаОплатуПокупателюТовары.Сумма КАК Сумма
        |ИЗ
        |    Документ.СчетНаОплатуПокупателю.Товары КАК СчетаНаОплатуПокупателюТовары
        |ГДЕ
        |    СчетаНаОплатуПокупателюТовары.Ссылка = &Ссылка";
        
        Запрос.УстановитьПараметр("Ссылка", СсылкаНаСчет);
        
        РезультатЗапроса = Запрос.Выполнить();
        ВыборкаПозиций = РезультатЗапроса.Выбрать();
        
        СчетчикПозиций = 0;
        Пока ВыборкаПозиций.Следующий() Цикл
            СчетчикПозиций = СчетчикПозиций + 1;
            ЗаписатьВФайл(ИмяФайлаЛога, "Позиция " + СчетчикПозиций + ": " + Строка(ВыборкаПозиций.НаименованиеНоменклатуры));
            
            СтруктураПозиции = Новый Структура;
            
            // Наименование товара/услуги
            Если ЗначениеЗаполнено(ВыборкаПозиций.НаименованиеНоменклатуры) Тогда
                СтруктураПозиции.Вставить("productName", Строка(ВыборкаПозиций.НаименованиеНоменклатуры));
            ИначеЕсли ЗначениеЗаполнено(ВыборкаПозиций.Номенклатура) Тогда
                СтруктураПозиции.Вставить("productName", Строка(ВыборкаПозиций.Номенклатура));
            Иначе
                СтруктураПозиции.Вставить("productName", "Неизвестный товар");
            КонецЕсли;
            
            // Количество
            Если ТипЗнч(ВыборкаПозиций.Количество) = Тип("Число") Тогда
                СтруктураПозиции.Вставить("quantity", ВыборкаПозиций.Количество);
            Иначе
                СтруктураПозиции.Вставить("quantity", 1);
            КонецЕсли;
            
            // Цена
            Если ТипЗнч(ВыборкаПозиций.Цена) = Тип("Число") Тогда
                СтруктураПозиции.Вставить("price", ВыборкаПозиций.Цена);
            Иначе
                СтруктураПозиции.Вставить("price", 0);
            КонецЕсли;
            
            // Сумма
            Если ТипЗнч(ВыборкаПозиций.Сумма) = Тип("Число") Тогда
                СтруктураПозиции.Вставить("total", ВыборкаПозиций.Сумма);
            Иначе
                СтруктураПозиции.Вставить("total", 0);
            КонецЕсли;
            
            МассивПозиций.Добавить(СтруктураПозиции);
            
        КонецЦикла;
        
        ЗаписатьВФайл(ИмяФайлаЛога, "Успешно получено " + МассивПозиций.Количество() + " позиций");
        
    Исключение
        // При ошибке возвращаем пустой массив
        ТекстОшибки = ОписаниеОшибки();
        ЗаписатьВФайл(ИмяФайлаЛога, "ОШИБКА получения позиций счета: " + ТекстОшибки);
        МассивПозиций = Новый Массив;
    КонецПопытки;
    
    Возврат МассивПозиций;
    
КонецФункции

// Функция очистки строк для JSON (экранирование кавычек и спецсимволов)
Функция ОчиститьСтрокуДляJSON(Строка)
    
    Если Строка = Неопределено Тогда
        Возврат "";
    КонецЕсли;
    
    Результат = СокрЛП(Строка);
    
    // Экранируем кавычки и спецсимволы для JSON
    Результат = СтрЗаменить(Результат, "\", "\\");  // Обратная косая черта
    Результат = СтрЗаменить(Результат, """", "\"""); // Кавычки
    Результат = СтрЗаменить(Результат, Символы.ПС, "\n"); // Перевод строки
    Результат = СтрЗаменить(Результат, Символы.ВК, "\r"); // Возврат каретки
    Результат = СтрЗаменить(Результат, Символы.Таб, "\t"); // Табуляция
    
    Возврат Результат;
    
КонецФункции

// Функция записи в файл
Процедура ЗаписатьВФайл(ИмяФайла, Текст)
    
    Попытка
        ТекстовыйДокумент = Новый ТекстовыйДокумент;
        
        // Читаем существующий файл если есть
        Попытка
            ТекстовыйДокумент.Прочитать(ИмяФайла, КодировкаТекста.UTF8);
        Исключение
            // Файл не существует - создаем новый
        КонецПопытки;
        
        // Добавляем новую строку
        ТекстовыйДокумент.ДобавитьСтроку(Текст);
        
        // Записываем файл
        ТекстовыйДокумент.Записать(ИмяФайла, КодировкаТекста.UTF8);
    Исключение
        // Тихо игнорируем ошибки записи в файл
    КонецПопытки;
    
КонецПроцедуры
```

## Основные исправления

1. **✅ Замена функции**: `ПолучитьРеальныеИсходящиеСчета` → `ПолучитьРеальныеИсходящиеСчетаСПозициями`
2. **✅ Добавлен вызов позицій**: `Позиции = ПолучитьПозицииСчета(Выборка.СсылкаДокумента)`
3. **✅ Исправлена таблица**: `Документ.СчетНаОплатуПокупателю.Товары` вместо `Документ.СчетНаОплату.Товары`
4. **✅ Добавлены позиции в JSON**: массив `positions` для каждого счета
5. **✅ Детальное логирование**: каждый этап получения позиций записывается в лог

## Результат

Теперь каждый счет будет содержать массив позиций:

```json
{
  "invoices": [
    {
      "invoiceNumber": "РМ00-027688",
      "date": "2025-07-11",
      "client": "ВІКОРД", 
      "amount": 9072,
      "currency": "980",
      "notes": "",
      "status": "posted",
      "positions": [
        {
          "productName": "Товар 1",
          "quantity": 2,
          "price": 4536,
          "total": 9072
        }
      ]
    }
  ]
}
```

Замените существующий код 1С этим исправленным кодом для полной поддержки позиций рахунків!
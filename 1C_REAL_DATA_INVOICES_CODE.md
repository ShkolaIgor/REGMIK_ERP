# 1С Код для реальних приходних накладних

## Код для отримання реальних накладних з бази 1С

```1c
// Обработчик HTTP-сервиса для приходных накладных
Функция invoicesПОСТ(Запрос)
    
    // Инициализация ответа
    Ответ = Новый HTTPСервисОтвет(200);
    
    // Имя файла лога
    ИмяФайлаЛога = "c:\temp\erp_invoices_debug.txt";
    ДатаВремя = ТекущаяДата();
    
    Попытка
        // Получаем тело запроса
        ТелоЗапроса = Запрос.ПолучитьТелоКакСтроку();
        
        // Логируем запрос
        ЗаписатьВФайл(ИмяФайлаЛога, Формат(ДатаВремя, "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " - Получен запрос: " + ТелоЗапроса + Символы.ПС);
        
        // Парсим JSON вручную (избегаем ПрочитатьJSON)
        action = "";
        limit = 100;
        
        // Простой парсинг action
        Если СтрНайти(ТелоЗапроса, """getInvoices""") > 0 Тогда
            action = "getInvoices";
        КонецЕсли;
        
        // Простой парсинг limit (тот же код что для исходящих)
        ПозицияLimit = СтрНайти(ТелоЗапроса, """limit"":");
        Если ПозицияLimit > 0 Тогда
            ОстатокСтроки = Сред(ТелоЗапроса, ПозицияLimit + 8);
            ПозицияЧисла = 1;
            Пока ПозицияЧисла <= СтрДлина(ОстатокСтроки) Цикл
                Символ = Сред(ОстатокСтроки, ПозицияЧисла, 1);
                Если Символ >= "0" И Символ <= "9" Тогда
                    НачалоЧисла = ПозицияЧисла;
                    Прервать;
                КонецЕсли;
                ПозицияЧисла = ПозицияЧисла + 1;
            КонецЦикла;
            
            Если НачалоЧисла > 0 Тогда
                КонецЧисла = НачалоЧисла;
                Пока КонецЧисла <= СтрДлина(ОстатокСтроки) Цикл
                    Символ = Сред(ОстатокСтроки, КонецЧисла, 1);
                    Если НЕ (Символ >= "0" И Символ <= "9") Тогда
                        Прервать;
                    КонецЕсли;
                    КонецЧисла = КонецЧисла + 1;
                КонецЦикла;
                
                СтрокаЧисла = Сред(ОстатокСтроки, НачалоЧисла, КонецЧисла - НачалоЧисла);
                Попытка
                    limit = Число(СтрокаЧисла);
                Исключение
                    limit = 100;
                КонецПопытки;
            КонецЕсли;
        КонецЕсли;
        
        // Проверяем action
        Если action = "getInvoices" Тогда
            
            // Получаем реальные данные из базы 1С
            МассивНакладных = ПолучитьРеальныеПриходныеНакладные(limit);
            
            // Формируем JSON вручную (избегаем ЗаписатьJSON)
            СтрокаJSON = "{""invoices"":[";
            Для Индекс = 0 По МассивНакладных.Количество() - 1 Цикл
                Накладная = МассивНакладных[Индекс];
                Если Индекс > 0 Тогда
                    СтрокаJSON = СтрокаJSON + ",";
                КонецЕсли;
                СтрокаJSON = СтрокаJSON + "{";
                СтрокаJSON = СтрокаJSON + """id"":""" + Накладная.id + """,";
                СтрокаJSON = СтрокаJSON + """number"":""" + Накладная.number + """,";
                СтрокаJSON = СтрокаJSON + """date"":""" + Накладная.date + """,";
                СтрокаJSON = СтрокаJSON + """supplier"":""" + Накладная.supplier + """,";
                СтрокаJSON = СтрокаJSON + """amount"":" + Формат(Накладная.amount, "ЧГ=") + ",";
                СтрокаJSON = СтрокаJSON + """currency"":""" + Накладная.currency + """,";
                СтрокаJSON = СтрокаJSON + """status"":""" + Накладная.status + """,";
                СтрокаJSON = СтрокаJSON + """exists"":" + ?(Накладная.exists, "true", "false");
                СтрокаJSON = СтрокаJSON + "}";
            КонецЦикла;
            СтрокаJSON = СтрокаJSON + "],";
            СтрокаJSON = СтрокаJSON + """total"":" + Формат(МассивНакладных.Количество(), "ЧГ=") + ",";
            СтрокаJSON = СтрокаJSON + """timestamp"":""" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-dd ВФ=HH:mm:ss") + """";
            СтрокаJSON = СтрокаJSON + "}";
            
            // Логируем успех
            ЗаписатьВФайл(ИмяФайлаЛога, Формат(ДатаВремя, "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " - Успешно: " + МассивНакладных.Количество() + " накладных" + Символы.ПС);
            
            // Возвращаем результат
            Ответ.УстановитьТелоИзСтроки(СтрокаJSON);
            
        Иначе
            // Неверный action
            СтрокаJSON = "{""error"":""Неизвестное действие""}";
            Ответ.УстановитьТелоИзСтроки(СтрокаJSON);
            Ответ.КодСостояния = 400;
        КонецЕсли;
        
    Исключение
        // Обработка ошибки
        ТекстОшибки = ОписаниеОшибки();
        
        // Логируем ошибку
        ЗаписатьВФайл(ИмяФайлаЛога, Формат(ДатаВремя, "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " - ОШИБКА: " + ТекстОшибки + Символы.ПС);
        
        // Возвращаем ошибку
        СтрокаJSON = "{""error"":""Ошибка сервера""}";
        Ответ.УстановитьТелоИзСтроки(СтрокаJSON);
        Ответ.КодСостояния = 500;
    КонецПопытки;
    
    Возврат Ответ;
    
КонецФункции

// Функция получения реальных приходных накладных из базы 1С
Функция ПолучитьРеальныеПриходныеНакладные(Лимит)
    
    МассивНакладных = Новый Массив;
    
    Попытка
        // Создаем запрос к базе данных 1С для получения приходных накладных
        Запрос = Новый Запрос;
        Запрос.Текст = 
        "ВЫБРАТЬ ПЕРВЫЕ " + Лимит + "
        |    ПоступлениеТоваровУслуг.Ссылка КАК Ссылка,
        |    ПоступлениеТоваровУслуг.НомерДокумента КАК НомерДокумента,
        |    ПоступлениеТоваровУслуг.Дата КАК ДатаДокумента,
        |    ПоступлениеТоваровУслуг.Контрагент.Наименование КАК НаименованиеПоставщика,
        |    ПоступлениеТоваровУслуг.СуммаДокумента КАК СуммаДокумента,
        |    ПоступлениеТоваровУслуг.ВалютаДокумента.Код КАК КодВалюты,
        |    ВЫБОР
        |        КОГДА ПоступлениеТоваровУслуг.Проведен = ИСТИНА ТОГДА ""posted""
        |        ИНАЧЕ ""draft""
        |    КОНЕЦ КАК СтатусДокумента
        |ИЗ
        |    Документ.ПоступлениеТоваровИУслуг КАК ПоступлениеТоваровУслуг
        |ГДЕ
        |    ПоступлениеТоваровУслуг.ПометкаУдаления = ЛОЖЬ
        |    И ПоступлениеТоваровУслуг.Дата >= &НачалоПериода
        |УПОРЯДОЧИТЬ ПО
        |    ПоступлениеТоваровУслуг.Дата УБЫВ";
        
        // Устанавливаем параметр - последние 3 месяца
        Запрос.УстановитьПараметр("НачалоПериода", НачалоМесяца(ДобавитьМесяц(ТекущаяДата(), -3)));
        
        // Выполняем запрос
        Результат = Запрос.Выполнить();
        Выборка = Результат.Выбрать();
        
        // Обрабатываем результаты
        Пока Выборка.Следующий() Цикл
            НакладнаяСтруктура = Новый Структура;
            НакладнаяСтруктура.Вставить("id", Строка(Выборка.Ссылка.УникальныйИдентификатор()));
            НакладнаяСтруктура.Вставить("number", СокрЛП(Выборка.НомерДокумента));
            НакладнаяСтруктура.Вставить("date", Формат(Выборка.ДатаДокумента, "ДФ=yyyy-MM-dd"));
            НакладнаяСтруктура.Вставить("supplier", СокрЛП(Выборка.НаименованиеПоставщика));
            НакладнаяСтруктура.Вставить("amount", Выборка.СуммаДокумента);
            НакладнаяСтруктура.Вставить("currency", СокрЛП(Выборка.КодВалюты));
            НакладнаяСтруктура.Вставить("status", СокрЛП(Выборка.СтатусДокумента));
            НакладнаяСтруктура.Вставить("exists", Ложь); // По умолчанию считаем что не существует в ERP
            
            МассивНакладных.Добавить(НакладнаяСтруктура);
        КонецЦикла;
        
        // Логируем успешное получение данных
        ЗаписатьВФайл("c:\temp\erp_invoices_debug.txt", 
            Формат(ТекущаяДата(), "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + 
            " - Получено из базы: " + МассивНакладных.Количество() + " реальных накладных" + Символы.ПС);
        
    Исключение
        // Если произошла ошибка с запросом, логируем
        ТекстОшибки = ОписаниеОшибки();
        ЗаписатьВФайл("c:\temp\erp_invoices_debug.txt", 
            Формат(ТекущаяДата(), "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + 
            " - ОШИБКА запроса к базе: " + ТекстОшибки + Символы.ПС);
    КонецПопытки;
    
    Возврат МассивНакладных;
    
КонецФункции
```

## Ключові особливості реального коду:

✅ **Запити до реальної бази 1С** - використовує документи "ПоступлениеТоваровИУслуг"
✅ **Фільтрація за періодом** - останні 3 місяці для продуктивності
✅ **Реальні поля даних** - НомерДокумента, Контрагент, СуммаДокумента
✅ **Статуси документів** - posted (проведений) / draft (чернетка)
✅ **Унікальні ідентифікатори** - УникальныйИдентификатор() для ID
✅ **Обробка помилок** - fallback на порожній масив при помилках запиту

Дата: 2025-07-11 19:20
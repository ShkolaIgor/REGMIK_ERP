# 1C Client Synchronization Setup Guide

## Налаштування синхронізації клієнтів з 1С

Цей документ містить інструкції для налаштування автоматичної синхронізації клієнтів між 1С та ERP системою.

## Архітектура синхронізації

### Процес синхронізації
1. **Виявлення змін в 1С** - система відстежує зміни в довіднику "Контрагенты"
2. **Виклик webhook** - при зміні відправляється POST запит до ERP
3. **Обробка в ERP** - система зіставляє та оновлює дані клієнта
4. **Журналювання** - результати синхронізації записуються в історію

### Типи операцій
- **create** - створення нового клієнта
- **update** - оновлення існуючого клієнта
- **delete** - деактивація клієнта (софт-видалення)

## Налаштування HTTP-сервісу в 1С

### Крок 1: Створення HTTP-сервісу

1. Відкрийте конфігурацію 1С
2. Додайте новий HTTP-сервіс з іменем "ERPClientSync"
3. Налаштуйте URL-шаблон: `{api_version}/clients`
4. Створіть метод POST для синхронізації

### Крок 2: Реалізація коду 1С

```bsl
// HTTP-сервіс для синхронізації клієнтів з ERP
// Файл: ERPClientSync.bsl

// Метод для обробки webhook'ів синхронізації клієнтів
Функция clients_POST(Запрос)
	
	Попытка
		ПараметрыЗапроса = Запрос.ПолучитьТелоКакСтроку();
		
		Если ПустаяСтрока(ПараметрыЗапроса) Тогда
			Возврат СоздатьОтветОшибки(400, "Пустые данные запроса");
		КонецЕсли;
		
		// Парсим JSON данные
		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.УстановитьСтроку(ПараметрыЗапроса);
		
		ДанныеЗапроса = ПрочитатьJSON(ЧтениеJSON);
		ЧтениеJSON.Закрыть();
		
		// Обрабатываем различные типы операций
		Если ДанныеЗапроса.Свойство("action") И ДанныеЗапроса.Свойство("clientId") Тогда
			
			Если ДанныеЗапроса.action = "sync_client" И ДанныеЗапроса.Свойство("clientData") Тогда
				// Синхронизация данных клиента
				РезультатСинхронизации = СинхронизироватьКлиентаВ1С(ДанныеЗапроса.clientData);
				Возврат СоздатьОтветУспеха(РезультатСинхронизации);
			ИначеЕсли ДанныеЗапроса.action = "get_client" Тогда
				// Получение данных клиента
				ДанныеКлиента = ПолучитьДанныеКлиента(ДанныеЗапроса.clientId);
				Возврат СоздатьОтветУспеха(ДанныеКлиента);
			Иначе
				Возврат СоздатьОтветОшибки(400, "Неизвестная операция: " + ДанныеЗапроса.action);
			КонецЕсли;
			
		Иначе
			Возврат СоздатьОтветОшибки(400, "Отсутствуют обязательные поля");
		КонецЕсли;
		
	Исключение
		СтрокаОшибки = ОписаниеОшибки();
		ЗаписатьЖурналРегистрации("ERPClientSync", 
			УровеньЖурналаРегистрации.Ошибка, 
			Метаданные.WSСсылки.ERPClientSync, 
			, 
			"Ошибка синхронизации клиентов: " + СтрокаОшибки);
		
		Возврат СоздатьОтветОшибки(500, "Внутренняя ошибка сервера");
	КонецПопытки;
	
КонецФункции

// Функция для синхронизации клиента в 1С
Функция СинхронизироватьКлиентаВ1С(ДанныеКлиента)
	
	Попытка
		НачатьТранзакцию();
		
		// Ищем существующего контрагента
		КонтрагентСсылка = НайтиКонтрагентаПоIDERP(ДанныеКлиента.erpId);
		
		Если КонтрагентСсылка = Неопределено Тогда
			// Создаем нового контрагента
			КонтрагентОбъект = Справочники.Контрагенты.СоздатьЭлемент();
			КонтрагентОбъект.Наименование = ДанныеКлиента.name;
			КонтрагентОбъект.НаименованиеПолное = ДанныеКлиента.fullName;
			КонтрагентОбъект.ИНН = ДанныеКлиента.taxCode;
			КонтрагентОбъект.ЮридическийАдрес = ДанныеКлиента.legalAddress;
			КонтрагентОбъект.ФактическийАдрес = ДанныеКлиента.physicalAddress;
			КонтрагентОбъект.Телефон = ДанныеКлиента.phone;
			КонтрагентОбъект.ЭлектроннаяПочта = ДанныеКлиента.email;
			КонтрагентОбъект.Покупатель = ДанныеКлиента.isCustomer;
			КонтрагентОбъект.Поставщик = ДанныеКлиента.isSupplier;
			КонтрагентОбъект.DНеИспользовать = НЕ ДанныеКлиента.isActive;
			
			// Добавляем ID ERP для связи
			КонтрагентОбъект.ДополнительныеРеквизиты.Добавить().Значение = ДанныеКлиента.erpId;
			
			КонтрагентОбъект.Записать();
			
			ЗафиксироватьТранзакцию();
			
			Возврат Новый Структура("success, message, clientId", 
				Истина, 
				"Контрагент успешно создан", 
				КонтрагентОбъект.Ссылка);
		Иначе
			// Обновляем существующего контрагента
			КонтрагентОбъект = КонтрагентСсылка.ПолучитьОбъект();
			КонтрагентОбъект.Наименование = ДанныеКлиента.name;
			КонтрагентОбъект.НаименованиеПолное = ДанныеКлиента.fullName;
			КонтрагентОбъект.ИНН = ДанныеКлиента.taxCode;
			КонтрагентОбъект.ЮридическийАдрес = ДанныеКлиента.legalAddress;
			КонтрагентОбъект.ФактическийАдрес = ДанныеКлиента.physicalAddress;
			КонтрагентОбъект.Телефон = ДанныеКлиента.phone;
			КонтрагентОбъект.ЭлектроннаяПочта = ДанныеКлиента.email;
			КонтрагентОбъект.Покупатель = ДанныеКлиента.isCustomer;
			КонтрагентОбъект.Поставщик = ДанныеКлиента.isSupplier;
			КонтрагентОбъект.DНеИспользовать = НЕ ДанныеКлиента.isActive;
			
			КонтрагентОбъект.Записать();
			
			ЗафиксироватьТранзакцию();
			
			Возврат Новый Структура("success, message, clientId", 
				Истина, 
				"Контрагент успешно обновлен", 
				КонтрагентОбъект.Ссылка);
		КонецЕсли;
		
	Исключение
		ОтменитьТранзакцию();
		ВызватьИсключение "Ошибка синхронизации: " + ОписаниеОшибки();
	КонецПопытки;
	
КонецФункции

// Функция для получения данных клиента
Функция ПолучитьДанныеКлиента(ClientId)
	
	Попытка
		КонтрагентСсылка = НайтиКонтрагентаПоIDERP(ClientId);
		
		Если КонтрагентСсылка = Неопределено Тогда
			Возврат Новый Структура("success, message", Ложь, "Контрагент не найден");
		КонецЕсли;
		
		КонтрагентОбъект = КонтрагентСсылка.ПолучитьОбъект();
		
		ДанныеКлиента = Новый Структура;
		ДанныеКлиента.Вставить("id", КонтрагентСсылка);
		ДанныеКлиента.Вставить("name", КонтрагентОбъект.Наименование);
		ДанныеКлиента.Вставить("fullName", КонтрагентОбъект.НаименованиеПолное);
		ДанныеКлиента.Вставить("taxCode", КонтрагентОбъект.ИНН);
		ДанныеКлиента.Вставить("legalAddress", КонтрагентОбъект.ЮридическийАдрес);
		ДанныеКлиента.Вставить("physicalAddress", КонтрагентОбъект.ФактическийАдрес);
		ДанныеКлиента.Вставить("phone", КонтрагентОбъект.Телефон);
		ДанныеКлиента.Вставить("email", КонтрагентОбъект.ЭлектроннаяПочта);
		ДанныеКлиента.Вставить("isCustomer", КонтрагентОбъект.Покупатель);
		ДанныеКлиента.Вставить("isSupplier", КонтрагентОбъект.Поставщик);
		ДанныеКлиента.Вставить("isActive", НЕ КонтрагентОбъект.DНеИспользовать);
		
		Возврат Новый Структура("success, message, clientData", 
			Истина, 
			"Данные клиента получены", 
			ДанныеКлиента);
		
	Исключение
		Возврат Новый Структура("success, message", 
			Ложь, 
			"Ошибка получения данных: " + ОписаниеОшибки());
	КонецПопытки;
	
КонецФункции

// Функция для поиска контрагента по ID ERP
Функция НайтиКонтрагентаПоIDERP(ERPID)
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
		|ВЫБРАТЬ
		|	Контрагенты.Ссылка
		|ИЗ
		|	Справочник.Контрагенты КАК Контрагенты
		|ГДЕ
		|	Контрагенты.ДополнительныеРеквизиты.Значение = &ERPID
	";
	
	Запрос.УстановитьПараметр("ERPID", ERPID);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если РезультатЗапроса.Пустой() Тогда
		Возврат Неопределено;
	Иначе
		Выборка = РезультатЗапроса.Выбрать();
		Выборка.Следующий();
		Возврат Выборка.Ссылка;
	КонецЕсли;
	
КонецФункции

// Функция для создания ответа об успехе
Функция СоздатьОтветУспеха(Данные)
	
	Ответ = Новый HTTPСервисОтвет(200);
	Ответ.УстановитьТелоИзСтроки(ПреобразоватьВJSON(Данные));
	Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
	
	Возврат Ответ;
	
КонецФункции

// Функция для создания ответа об ошибке
Функция СоздатьОтветОшибки(КодОшибки, СообщениеОшибки)
	
	ДанныеОшибки = Новый Структура;
	ДанныеОшибки.Вставить("success", Ложь);
	ДанныеОшибки.Вставить("message", СообщениеОшибки);
	ДанныеОшибки.Вставить("errorCode", КодОшибки);
	
	Ответ = Новый HTTPСервисОтвет(КодОшибки);
	Ответ.УстановитьТелоИзСтроки(ПреобразоватьВJSON(ДанныеОшибки));
	Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
	
	Возврат Ответ;
	
КонецФункции

// Функция для преобразования в JSON (совместимость с разными версиями 1С)
Функция ПреобразоватьВJSON(Данные)
	
	Попытка
		// Для 1С 8.3.15 и выше
		ЗаписьJSON = Новый ЗаписьJSON;
		ЗаписьJSON.УстановитьСтроку();
		ЗаписатьJSON(ЗаписьJSON, Данные);
		РезультатJSON = ЗаписьJSON.Закрыть();
		
		Возврат РезультатJSON;
	Исключение
		// Для старых версий 1С
		Возврат XMLСтрока(Данные);
	КонецПопытки;
	
КонецФункции
```

### Крок 3: Налаштування автоматичного виклику webhook

Створіть обработчик события для справочника "Контрагенты":

```bsl
// Обработчик события ПередЗаписью
Процедура ПередЗаписью(Отказ)
	
	// Запомним состояние объекта для сравнения
	Если НЕ ЭтоНовый() Тогда
		СтароеСостояние = Ссылка.ПолучитьОбъект();
	КонецЕсли;
	
КонецПроцедуры

// Обработчик события ПослеЗаписи
Процедура ПослеЗаписи(Отказ)
	
	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	
	// Отправляем webhook в ERP
	ОтправитьWebhookВERP(ЭтотОбъект);
	
КонецПроцедуры

// Функция для отправки webhook в ERP
Процедура ОтправитьWebhookВERP(КонтрагентОбъект)
	
	Попытка
		// Подготавливаем данные для отправки
		ДанныеДляОтправки = Новый Структура;
		ДанныеДляОтправки.Вставить("action", "create"); // или "update"
		ДанныеДляОтправки.Вставить("clientId", КонтрагентОбъект.Ссылка);
		ДанныеДляОтправки.Вставить("timestamp", ТекущаяДата());
		
		// Подготавливаем данные клиента
		ДанныеКлиента = Новый Структура;
		ДанныеКлиента.Вставить("id", КонтрагентОбъект.Ссылка);
		ДанныеКлиента.Вставить("name", КонтрагентОбъект.Наименование);
		ДанныеКлиента.Вставить("fullName", КонтрагентОбъект.НаименованиеПолное);
		ДанныеКлиента.Вставить("taxCode", КонтрагентОбъект.ИНН);
		ДанныеКлиента.Вставить("legalAddress", КонтрагентОбъект.ЮридическийАдрес);
		ДанныеКлиента.Вставить("physicalAddress", КонтрагентОбъект.ФактическийАдрес);
		ДанныеКлиента.Вставить("phone", КонтрагентОбъект.Телефон);
		ДанныеКлиента.Вставить("email", КонтрагентОбъект.ЭлектроннаяПочта);
		ДанныеКлиента.Вставить("isCustomer", КонтрагентОбъект.Покупатель);
		ДанныеКлиента.Вставить("isSupplier", КонтрагентОбъект.Поставщик);
		ДанныеКлиента.Вставить("isActive", НЕ КонтрагентОбъект.DНеИспользовать);
		
		ДанныеДляОтправки.Вставить("clientData", ДанныеКлиента);
		
		// Отправляем HTTP запрос
		HTTPСоединение = Новый HTTPСоединение("your-erp-domain.com", 443, , , , 30, Новый ЗащищенноеСоединениеOpenSSL);
		HTTPЗапрос = Новый HTTPЗапрос("/api/1c/clients/sync");
		HTTPЗапрос.Заголовки.Вставить("Content-Type", "application/json");
		HTTPЗапрос.УстановитьТелоИзСтроки(ПреобразоватьВJSON(ДанныеДляОтправки));
		
		HTTPОтвет = HTTPСоединение.ВызватьHTTPМетод("POST", HTTPЗапрос);
		
		Если HTTPОтвет.КодСостояния = 200 Тогда
			ЗаписатьЖурналРегистрации("ERPClientSync", 
				УровеньЖурналаРегистрации.Информация, 
				КонтрагентОбъект.Ссылка, 
				, 
				"Успешная синхронизация с ERP");
		Иначе
			ЗаписатьЖурналРегистрации("ERPClientSync", 
				УровеньЖурналаРегистрации.Ошибка, 
				КонтрагентОбъект.Ссылка, 
				, 
				"Ошибка синхронизации с ERP: " + HTTPОтвет.КодСостояния);
		КонецЕсли;
		
	Исключение
		ЗаписатьЖурналРегистрации("ERPClientSync", 
			УровеньЖурналаРегистрации.Ошибка, 
			КонтрагентОбъект.Ссылка, 
			, 
			"Ошибка отправки webhook: " + ОписаниеОшибки());
	КонецПопытки;
	
КонецПроцедуры
```

## Налаштування в ERP

### Webhook endpoint
URL: `https://your-erp-domain.com/api/1c/clients/sync`
Method: `POST`

### Формат даних webhook

```json
{
  "action": "create|update|delete",
  "clientId": "uuid-клиента-в-1c",
  "timestamp": "2025-01-18T10:30:00Z",
  "changeDescription": "Опис змін",
  "clientData": {
    "id": "uuid-клиента-в-1c",
    "name": "Коротка назва",
    "fullName": "Повна назва клиента",
    "taxCode": "12345678",
    "legalAddress": "Юридична адреса",
    "physicalAddress": "Фактична адреса",
    "phone": "+380123456789",
    "email": "client@example.com",
    "isActive": true,
    "isCustomer": true,
    "isSupplier": false,
    "discount": 5.0,
    "notes": "Примітки",
    "contactPersons": [
      {
        "fullName": "Контактна особа",
        "position": "Посада",
        "phone": "+380123456789",
        "email": "contact@example.com"
      }
    ]
  }
}
```

### Відповідь ERP

```json
{
  "success": true,
  "message": "Клієнт успішно створений",
  "erpClientId": 123,
  "errorCode": null,
  "details": null
}
```

## Тестування

### Тест webhook endpoint
```bash
curl -X POST https://your-erp-domain.com/api/1c/clients/sync \
  -H "Content-Type: application/json" \
  -d '{
    "action": "create",
    "clientId": "test-client-123",
    "timestamp": "2025-01-18T10:30:00Z",
    "clientData": {
      "id": "test-client-123",
      "name": "Тестовий клієнт",
      "fullName": "Тестовий клієнт ТОВ",
      "taxCode": "12345678",
      "isActive": true,
      "isCustomer": true,
      "isSupplier": false
    }
  }'
```

### Перевірка історії синхронізації
```bash
curl -X GET "https://your-erp-domain.com/api/1c/clients/sync-history?external1cId=test-client-123"
```

## Налаштування бази даних

Система автоматично створить таблицю `client_sync_history` для журналювання синхронізації.

## Моніторинг

Перевірити статус синхронізації можна:
1. В журналі 1С (подія "ERPClientSync")
2. В ERP через API `/api/1c/clients/sync-history`
3. В системних логах ERP

## Безпека

1. Використовуйте HTTPS для всіх webhook запитів
2. Додайте авторизацію через API ключі
3. Валідуйте всі вхідні дані
4. Логгуйте всі операції синхронізації

## Troubleshooting

### Поширені помилки:
1. **Timeout помилки** - збільшіть timeout HTTP запитів
2. **JSON parsing errors** - перевірте кодування даних
3. **Client not found** - перевірте ID клієнта в 1С
4. **Database errors** - перевірте структуру таблиць ERP

### Діагностика:
```bash
# Перевірка статусу webhook
curl -I https://your-erp-domain.com/api/1c/clients/sync

# Перевірка логів синхронізації
curl -X GET "https://your-erp-domain.com/api/1c/clients/sync-history?syncStatus=error"
```
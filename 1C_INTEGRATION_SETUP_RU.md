# Настройка интеграции с 1С (российская версия)

## Обзор

Система REGMIK ERP поддерживает интеграцию с российскими системами 1С для автоматического импорта накладных поставщиков. Интеграция позволяет переносить данные о приходных накладных из 1С в ERP систему с автоматическим созданием поставщиков и компонентов.

## Требования к 1С

### Поддерживаемые версии
- 1С:Предприятие 8.3
- 1С:Бухгалтерия 3.0
- 1С:Управление торговлей 11
- 1С:ERP Управление предприятием 2
- 1С:Комплексная автоматизация 2

### Необходимые компоненты
1. **HTTP-сервисы** - для обмена данными через REST API
2. **Веб-сервисы** - для публикации данных
3. **Регламентные задания** - для автоматической синхронизации

## Настройка в 1С

### 1. Создание HTTP-сервиса

#### Шаг 1: Создание HTTP-сервиса
1. Откройте конфигуратор 1С
2. Перейдите в раздел "Конфигурация" → "HTTP-сервисы"
3. Создайте новый HTTP-сервис с именем `ERPIntegration`
4. Установите корневой URL: `/erp/v1`

#### Шаг 2: Создание ресурса для накладных
```1c
// Ресурс: /invoices
// Метод: GET
// Шаблон URL: /invoices

Функция ПолучитьНакладные(Запрос)
    
    Отбор = Новый Структура;
    
    // Фильтр по дате (опционально)
    Если Запрос.ПараметрыURL.Свойство("dateFrom") Тогда
        Отбор.Вставить("ДатаОт", XMLЗначение(Тип("Дата"), Запрос.ПараметрыURL["dateFrom"]));
    КонецЕсли;
    
    Если Запрос.ПараметрыURL.Свойство("dateTo") Тогда
        Отбор.Вставить("ДатаДо", XMLЗначение(Тип("Дата"), Запрос.ПараметрыURL["dateTo"]));
    КонецЕсли;
    
    // Получение накладных
    Накладные = ПолучитьСписокНакладных(Отбор);
    
    Ответ = Новый HTTPСервисОтвет(200);
    Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
    Ответ.УстановитьТелоИзСтроки(JSONСтрока(Накладные), КодировкаТекста.UTF8);
    
    Возврат Ответ;
    
КонецФункции

Функция ПолучитьСписокНакладных(Отбор)
    
    Запрос = Новый Запрос;
    Запрос.Текст = "
        |ВЫБРАТЬ
        |    ПоступлениеТоваровУслуг.Ссылка КАК Ref,
        |    ПоступлениеТоваровУслуг.Номер КАК Number,
        |    ПоступлениеТоваровУслуг.Дата КАК Date,
        |    ПоступлениеТоваровУслуг.Контрагент КАК Supplier,
        |    ПоступлениеТоваровУслуг.СуммаДокумента КАК Amount,
        |    ПоступлениеТоваровУслуг.Валюта КАК Currency,
        |    ПоступлениеТоваровУслуг.Комментарий КАК Comment
        |ИЗ
        |    Документ.ПоступлениеТоваровУслуг КАК ПоступлениеТоваровУслуг
        |ГДЕ
        |    ПоступлениеТоваровУслуг.Проведен = ИСТИНА
        |    И ПоступлениеТоваровУслуг.ПометкаУдаления = ЛОЖЬ";
    
    Если Отбор.Свойство("ДатаОт") Тогда
        Запрос.Текст = Запрос.Текст + "
            |    И ПоступлениеТоваровУслуг.Дата >= &ДатаОт";
        Запрос.УстановитьПараметр("ДатаОт", Отбор.ДатаОт);
    КонецЕсли;
    
    Если Отбор.Свойство("ДатаДо") Тогда
        Запрос.Текст = Запрос.Текст + "
            |    И ПоступлениеТоваровУслуг.Дата <= &ДатаДо";
        Запрос.УстановитьПараметр("ДатаДо", Отбор.ДатаДо);
    КонецЕсли;
    
    Запрос.Текст = Запрос.Текст + "
        |УПОРЯДОЧИТЬ ПО
        |    ПоступлениеТоваровУслуг.Дата УБЫВ";
    
    Результат = Запрос.Выполнить();
    Выборка = Результат.Выбрать();
    
    МассивНакладных = Новый Массив;
    
    Пока Выборка.Следующий() Цикл
        
        СтруктураНакладной = Новый Структура;
        СтруктураНакладной.Вставить("id", Строка(Выборка.Ref.УникальныйИдентификатор()));
        СтруктураНакладной.Вставить("number", Выборка.Number);
        СтруктураНакладной.Вставить("date", XMLСтрока(Выборка.Date));
        СтруктураНакладной.Вставить("supplier", Строка(Выборка.Supplier));
        СтруктураНакладной.Вставить("amount", Выборка.Amount);
        СтруктураНакладной.Вставить("currency", Строка(Выборка.Currency));
        СтруктураНакладной.Вставить("comment", Выборка.Comment);
        СтруктураНакладной.Вставить("status", "new");
        
        // Получение позиций накладной
        Позиции = ПолучитьПозицииНакладной(Выборка.Ref);
        СтруктураНакладной.Вставить("items", Позиции);
        
        МассивНакладных.Добавить(СтруктураНакладной);
        
    КонецЦикла;
    
    Возврат МассивНакладных;
    
КонецФункции

Функция ПолучитьПозицииНакладной(СсылкаНакладной)
    
    Запрос = Новый Запрос;
    Запрос.Текст = "
        |ВЫБРАТЬ
        |    ПоступлениеТоваровУслугТовары.Номенклатура КАК Product,
        |    ПоступлениеТоваровУслугТовары.Количество КАК Quantity,
        |    ПоступлениеТоваровУслугТовары.Цена КАК Price,
        |    ПоступлениеТоваровУслугТовары.Сумма КАК Total,
        |    ПоступлениеТоваровУслугТовары.ЕдиницаИзмерения КАК Unit,
        |    ПоступлениеТоваровУслугТовары.Артикул КАК SKU
        |ИЗ
        |    Документ.ПоступлениеТоваровУслуг.Товары КАК ПоступлениеТоваровУслугТовары
        |ГДЕ
        |    ПоступлениеТоваровУслугТовары.Ссылка = &Ссылка";
    
    Запрос.УстановитьПараметр("Ссылка", СсылкаНакладной);
    
    Результат = Запрос.Выполнить();
    Выборка = Результат.Выбрать();
    
    МассивПозиций = Новый Массив;
    
    Пока Выборка.Следующий() Цикл
        
        СтруктураПозиции = Новый Структура;
        СтруктураПозиции.Вставить("name", Строка(Выборка.Product));
        СтруктураПозиции.Вставить("sku", Выборка.SKU);
        СтруктураПозиции.Вставить("quantity", Выборка.Quantity);
        СтруктураПозиции.Вставить("price", Выборка.Price);
        СтруктураПозиции.Вставить("total", Выборка.Total);
        СтруктураПозиции.Вставить("unit", Строка(Выборка.Unit));
        
        МассивПозиций.Добавить(СтруктураПозиции);
        
    КонецЦикла;
    
    Возврат МассивПозиций;
    
КонецФункции
```

### 2. Настройка аутентификации

#### HTTP Basic Authentication
```1c
// В модуле HTTP-сервиса
Функция ПроверитьАутентификацию(Запрос)
    
    АвторизацияЗаголовок = Запрос.Заголовки.Получить("Authorization");
    
    Если АвторизацияЗаголовок = Неопределено Тогда
        Возврат Ложь;
    КонецЕсли;
    
    // Проверка Basic Auth
    Если НЕ СтрНачинаетсяС(АвторизацияЗаголовок, "Basic ") Тогда
        Возврат Ложь;
    КонецЕсли;
    
    Кодированные = Сред(АвторизацияЗаголовок, 7);
    Декодированные = Base64Значение(Кодированные);
    Логин_Пароль = ПолучитьСтрокуИзДвоичныхДанных(Декодированные);
    
    ПозицияДвоеточия = Найти(Логин_Пароль, ":");
    Если ПозицияДвоеточия = 0 Тогда
        Возврат Ложь;
    КонецЕсли;
    
    Логин = Лев(Логин_Пароль, ПозицияДвоеточия - 1);
    Пароль = Сред(Логин_Пароль, ПозицияДвоеточия + 1);
    
    // Проверка логина и пароля
    Возврат ПроверитьПользователя(Логин, Пароль);
    
КонецФункции

Функция ПроверитьПользователя(Логин, Пароль)
    
    // Простая проверка для интеграции
    Если Логин = "integration_user" И Пароль = "secure_password_123" Тогда
        Возврат Истина;
    КонецЕсли;
    
    // Или проверка через пользователей ИБ
    Пользователи = ПользователиИнформационнойБазы.НайтиПоИмени(Логин);
    Если Пользователи <> Неопределено Тогда
        Возврат Пользователи.АутентификацияСтандартная;
    КонецЕсли;
    
    Возврат Ложь;
    
КонецФункции
```

### 3. Публикация HTTP-сервиса

1. Откройте "Администрирование" → "Интернет-поддержка пользователей"
2. Выберите вкладку "Web-сервисы"
3. Нажмите "Настроить публикацию"
4. Выберите HTTP-сервис `ERPIntegration`
5. Установите URL: `http://your-1c-server:port/base/hs/erp/v1`

### 4. Пример JSON ответа

```json
{
  "invoices": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "number": "000000123",
      "date": "2025-01-15T00:00:00",
      "supplier": "ООО \"Поставщик\"",
      "amount": 15000.00,
      "currency": "RUB",
      "comment": "Поступление товаров",
      "status": "new",
      "items": [
        {
          "name": "Винт М8х20",
          "sku": "BOLT-M8-20",
          "quantity": 100,
          "price": 5.50,
          "total": 550.00,
          "unit": "шт"
        },
        {
          "name": "Гайка М8",
          "sku": "NUT-M8",
          "quantity": 100,
          "price": 3.25,
          "total": 325.00,
          "unit": "шт"
        }
      ]
    }
  ]
}
```

## Настройка в REGMIK ERP

### 1. Создание интеграции

На странице "Интеграции" нажмите "Добавить интеграцию" и заполните:

- **Тип системы**: 1С:Предприятие
- **Системное имя**: `1c_main`
- **Отображаемое имя**: `Основная 1С база`
- **URL сервера**: `http://your-1c-server:port/base/hs/erp/v1`
- **Client ID / Логин**: `integration_user`
- **Client Secret / Пароль**: `secure_password_123`
- **Интервал синхронизации**: 60 минут

### 2. Тестирование соединения

1. После создания интеграции нажмите кнопку "Тест"
2. Система проверит доступность 1С сервера
3. При успешном подключении появится кнопка "Импорт накладных из 1C"

### 3. Импорт накладных

1. Нажмите кнопку "Импорт накладных из 1C"
2. Система покажет список доступных накладных из 1С
3. Выберите накладные для импорта
4. Нажмите "Импортировать выбранные"

## Автоматическая синхронизация

### Настройка регламентного задания в 1С

```1c
// Процедура регламентного задания
Процедура СинхронизацияС_ERP() Экспорт
    
    Попытка
        
        // URL ERP системы
        URL_ERP = "https://your-erp-domain.com/api/1c/sync";
        
        // Параметры аутентификации
        Логин = "erp_user";
        Пароль = "erp_password";
        
        // Получение новых накладных
        НовыеНакладные = ПолучитьНовыеНакладныеДляЭРП();
        
        Если НовыеНакладные.Количество() > 0 Тогда
            
            // Отправка данных в ERP
            HTTPЗапрос = Новый HTTPЗапрос("/api/1c/sync");
            HTTPЗапрос.Заголовки.Вставить("Content-Type", "application/json");
            HTTPЗапрос.Заголовки.Вставить("Authorization", "Basic " + 
                Base64Строка(ПолучитьДвоичныеДанныеИзСтроки(Логин + ":" + Пароль)));
            
            Данные = Новый Структура("invoices", НовыеНакладные);
            HTTPЗапрос.УстановитьТелоИзСтроки(JSONСтрока(Данные));
            
            HTTPСоединение = Новый HTTPСоединение("your-erp-domain.com", 443, , , , 30, 
                Новый ЗащищенноеСоединениеOpenSSL());
            
            Ответ = HTTPСоединение.ОтправитьДляОбработки(HTTPЗапрос);
            
            Если Ответ.КодСостояния = 200 Тогда
                ОтметитьНакладныеКакСинхронизированные(НовыеНакладные);
                ЗаписатьВЖурналРегистрации("Синхронизация с ERP", 
                    УровеньЖурналаРегистрации.Информация,
                    Метаданные.РегламентныеЗадания.СинхронизацияС_ERP,
                    , "Успешно синхронизировано " + НовыеНакладные.Количество() + " накладных");
            Иначе
                ВызватьИсключение("HTTP ошибка: " + Ответ.КодСостояния);
            КонецЕсли;
            
        КонецЕсли;
        
    Исключение
        ЗаписатьВЖурналРегистрации("Синхронизация с ERP", 
            УровеньЖурналаРегистрации.Ошибка,
            Метаданные.РегламентныеЗадания.СинхронизацияС_ERP,
            , ОписаниеОшибки());
    КонецПопытки;
    
КонецПроцедуры

Функция ПолучитьНовыеНакладныеДляЭРП()
    
    Запрос = Новый Запрос;
    Запрос.Текст = "
        |ВЫБРАТЬ
        |    ПоступлениеТоваровУслуг.Ссылка
        |ИЗ
        |    Документ.ПоступлениеТоваровУслуг КАК ПоступлениеТоваровУслуг
        |ГДЕ
        |    ПоступлениеТоваровУслуг.Проведен = ИСТИНА
        |    И ПоступлениеТоваровУслуг.ПометкаУдаления = ЛОЖЬ
        |    И ПоступлениеТоваровУслуг.СинхронизированоС_ERP = ЛОЖЬ
        |УПОРЯДОЧИТЬ ПО
        |    ПоступлениеТоваровУслуг.Дата";
    
    Результат = Запрос.Выполнить();
    Выборка = Результат.Выбрать();
    
    МассивНакладных = Новый Массив;
    
    Пока Выборка.Следующий() Цикл
        МассивНакладных.Добавить(Выборка.Ссылка);
    КонецЦикла;
    
    Возврат МассивНакладных;
    
КонецФункции
```

## Безопасность

### Рекомендации
1. Используйте HTTPS для всех соединений
2. Создайте отдельного пользователя в 1С только для интеграции
3. Предоставьте минимальные права доступа только к необходимым данным
4. Регулярно меняйте пароли
5. Используйте сильные пароли (минимум 12 символов)

### Права доступа в 1С
Пользователь для интеграции должен иметь права:
- Чтение справочника "Номенклатура"
- Чтение справочника "Контрагенты"
- Чтение документа "Поступление товаров и услуг"
- Доступ к HTTP-сервисам

## Мониторинг и логирование

### В 1С
- Все операции логируются в журнал регистрации
- Настройте уведомления об ошибках синхронизации

### В REGMIK ERP
- Просмотр логов синхронизации на странице "Интеграции" → вкладка "Логи"
- Уведомления об успешном/неуспешном импорте

## Troubleshooting

### Частые проблемы
1. **Ошибка 401 Unauthorized** - неверный логин/пароль
2. **Ошибка 404 Not Found** - неверный URL HTTP-сервиса
3. **Ошибка 500 Internal Server Error** - ошибка в коде 1С
4. **Timeout** - слишком долгое выполнение запроса

### Решения
- Проверьте доступность 1С сервера
- Убедитесь в правильности URL и учетных данных
- Просмотрите журнал регистрации 1С
- Проверьте настройки файрвола

## Поддержка

При возникновении проблем:
1. Проверьте доступность 1С сервера
2. Проверьте правильность логина/пароля
3. Просмотрите логи в обеих системах
4. Обратитесь к технической поддержке REGMIK ERP
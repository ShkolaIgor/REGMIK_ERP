# 1С код для отримання РЕАЛЬНИХ вихідних рахунків

## Основні зміни

✅ **Замінено тестові дані на реальні SQL запити**
✅ **Додано повне логування в c:\temp\erp_outgoing_debug.txt**
✅ **Розширено період отримання даних до 6 місяців**
✅ **Додано додаткові поля: clientTaxCode, paymentStatus, itemsCount, managerName**
✅ **Захист від помилок JSON екранування**

## Новий функціонал

### 1. Реальний SQL запрос до 1С бази
```sql
ВЫБРАТЬ ПЕРВЫЕ 100
    СчетНаОплату.Номер КАК НомерСчета,
    СчетНаОплату.Дата КАК ДатаСчета,
    СчетНаОплату.Контрагент.Наименование КАК НаименованиеКонтрагента,
    СчетНаОплату.СуммаДокумента КАК СуммаДокумента,
    ВЫБОР
        КОГДА СчетНаОплату.Валюта.Код ЕСТЬ NULL ТОГДА "UAH"
        ИНАЧЕ СчетНаОплату.Валюта.Код
    КОНЕЦ КАК КодВалюты,
    ВЫБОР
        КОГДА СчетНаОплату.Проведен ТОГДА "confirmed"
        ИНАЧЕ "draft"
    КОНЕЦ КАК Статус,
    СчетНаОплату.Ссылка КАК СсылкаДокумента
ИЗ
    Документ.СчетНаОплату КАК СчетНаОплату
ГДЕ
    СчетНаОплату.ПометкаУдаления = ЛОЖЬ
    И СчетНаОплату.Дата >= &НачалоПериода
УПОРЯДОЧИТЬ ПО
    СчетНаОплату.Дата УБЫВ,
    СчетНаОплату.Номер УБЫВ
```

### 2. Додаткові дані з документів
- **clientTaxCode** - ІПН/КПП контрагента
- **paymentStatus** - статус оплати 
- **itemsCount** - кількість позицій товарів
- **managerName** - відповідальна особа

### 3. Логування всіх операцій
Всі дії записуються в файл `c:\temp\erp_outgoing_debug.txt`:
- Початок виконання запиту
- Кількість знайдених записів
- Прогрес обробки (кожні 10 рахунків)
- Помилки та їх деталі

### 4. Безпечне JSON формування
Функція `ОчиститьСтрокуДляJSON()` екранує:
- Лапки: `"` → `\"`
- Зворотні слеші: `\` → `\\`
- Переноси рядків: `\n`, `\r`, `\t`

## Як використовувати

1. **Замініть весь код HTTP-сервісу** на код з файлу `1C_OUTGOING_INVOICES_PROCEDURE_VERSION.md`

2. **Збережіть та опублікуйте** HTTP-сервіс в 1С

3. **Протестуйте** з ERP системою через endpoint:
   ```
   GET /hs/erp/outgoing-invoices?action=getInvoices&limit=50
   ```

4. **Перевірте логи** в файлі `c:\temp\erp_outgoing_debug.txt`

## Очікуваний результат

```json
{
  "invoices": [
    {
      "invoiceNumber": "СФ-000001",
      "clientName": "ТОВ ПРИКЛАД КЛІЄНТ",
      "totalAmount": 15000.00,
      "currency": "UAH", 
      "date": "2025-07-11",
      "status": "confirmed",
      "clientTaxCode": "1234567890",
      "paymentStatus": "confirmed",
      "itemsCount": 5,
      "managerName": "Іванов І.І."
    }
  ],
  "total": 1,
  "timestamp": "2025-07-11 14:30:00"
}
```

## Діагностика

Якщо рахунки не відображаються:

1. **Перевірте логи**: `c:\temp\erp_outgoing_debug.txt`
2. **Перевірте період**: можливо немає рахунків за останні 6 місяців
3. **Перевірте назву документу**: в деяких конфігураціях може бути інша назва замість `СчетНаОплату`

## Можливі помилки та рішення

### "Таблица не найдена: Документ.СчетНаОплату"
**Рішення**: Змініть назву документу на правильну для вашої конфігурації:
- `Документ.СчетНаОплатуПокупателю`
- `Документ.СчетФактура` 
- `Документ.РасходнаяНакладная`

### "Поле не найдено: СуммаДокумента"
**Рішення**: Змініть на правильну назву поля:
- `СуммаДокумента` → `Сумма`
- `СуммаДокумента` → `ИтогоКОплате`

### Пустий результат
**Рішення**: Збільште період пошуку:
```1c
НачалоПериода = ДобавитьМесяц(ТекущаяДата(), -12); // Рік замість 6 місяців
```

Тепер код буде отримувати реальні дані з вашої 1С системи!
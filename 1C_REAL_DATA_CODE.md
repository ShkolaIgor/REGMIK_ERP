# 1C КОД З РЕАЛЬНИМИ ДАНИМИ (ВИПРАВЛЕНО НАЗВИ ТОВАРІВ)

## ПРОБЛЕМА: "Невідомий товар" замість справжніх назв

Потрібно виправити поле назви товару в запиті позицій документу.

## ВИПРАВЛЕНИЙ КОД:

```1c
Функция invoicesPOST(Запрос)
    
    Попытка
        ЗаписатьВФайл("=== НОВЫЙ ЗАПРОС НАКЛАДНЫХ ===");
        
        МассивНакладных = ПолучитьДанныеНакладных(50);
        
        ЗаписатьВФайл("Найдено накладных: " + Строка(МассивНакладных.Количество()));
        
        // JSON
        ЗаписьJSON = Новый ЗаписьJSON;
        ЗаписьJSON.УстановитьСтроку();
        ЗаписатьJSON(ЗаписьJSON, МассивНакладных);
        СтрокаJSON = ЗаписьJSON.Закрыть();
        
        // Ответ
        Ответ = Новый HTTPСервисОтвет(200);
        Ответ.УстановитьТелоИзСтроки(СтрокаJSON, КодировкаТекста.UTF8);
        Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
        
        ЗаписатьВФайл("SUCCESS: Отправлено накладных: " + Строка(МассивНакладных.Количество()));
        
        Возврат Ответ;
        
    Исключение
        ЗаписатьВФайл("ERROR в invoicesPOST: " + ОписаниеОшибки());
        
        ОтветОшибка = Новый HTTPСервисОтвет(500);
        ОтветОшибка.УстановитьТелоИзСтроки("Error: " + ОписаниеОшибки(), КодировкаТекста.UTF8);
        Возврат ОтветОшибка;
        
    КонецПопытки;
    
КонецФункции

Функция ПолучитьДанныеНакладных(КоличествоЗаписей = 50)
    
    МассивНакладных = Новый Массив;
    
    Попытка
        ЗаписатьВФайл("Начинаем поиск накладных...");
        
        ДатаНачала = НачалоДня(ТекущаяДата() - 30*24*3600);
        ЗаписатьВФайл("Период с: " + Строка(ДатаНачала));
        
        Запрос = Новый Запрос;
        Запрос.Текст = "
        |ВЫБРАТЬ ПЕРВЫЕ " + КоличествоЗаписей + "
        |    Ссылка КАК ДокументСсылка,
        |    Номер,
        |    Дата,
        |    Контрагент.Наименование КАК КонтрагентНаименование,
        |    СуммаДокумента,
        |    ВалютаДокумента.Код КАК КодВалюты,
        |    Проведен
        |ИЗ Документ.ПоступлениеТоваровУслуг КАК ПоступлениеТоваровУслуг
        |ГДЕ ПоступлениеТоваровУслуг.Дата >= &ДатаНачала
        |    И ПоступлениеТоваровУслуг.Проведен = ИСТИНА
        |УПОРЯДОЧИТЬ ПО Дата УБЫВ";
        
        Запрос.УстановитьПараметр("ДатаНачала", ДатаНачала);
        
        ЗаписатьВФайл("Выполняем SQL запрос...");
        
        Результат = Запрос.Выполнить();
        Выборка = Результат.Выбрать();
        
        ЗаписатьВФайл("SQL выполнен успешно");
        
        Счетчик = 0;
        Пока Выборка.Следующий() Цикл
            
            Счетчик = Счетчик + 1;
            
            ЗаписатьВФайл("Накладная " + Строка(Счетчик) + ": " + Выборка.Номер + " от " + Строка(Выборка.Дата));
            
            ОбъектНакладной = Новый Структура;
            ОбъектНакладной.Вставить("ID", Строка(Выборка.ДокументСсылка.УникальныйИдентификатор()));
            ОбъектНакладной.Вставить("НомерДокумента", Выборка.Номер);
            ОбъектНакладной.Вставить("Дата", Формат(Выборка.Дата, "ДФ=yyyy-MM-dd"));
            ОбъектНакладной.Вставить("Постачальник", Выборка.КонтрагентНаименование);
            ОбъектНакладной.Вставить("Сума", Число(Выборка.СуммаДокумента));
            ОбъектНакладной.Вставить("Валюта", Выборка.КодВалюты);
            ОбъектНакладной.Вставить("Статус", "confirmed");
            
            // Позиции документа
            МассивПозиций = ПолучитьПозицииДокумента(Выборка.ДокументСсылка);
            ОбъектНакладной.Вставить("Позиції", МассивПозиций);
            
            МассивНакладных.Добавить(ОбъектНакладной);
            
        КонецЦикла;
        
        ЗаписатьВФайл("=== ИТОГО НАЙДЕНО: " + Строка(Счетчик) + " накладных ===");
        
    Исключение
        ЗаписатьВФайл("ERROR в ПолучитьДанныеНакладных: " + ОписаниеОшибки());
    КонецПопытки;
    
    Возврат МассивНакладных;
    
КонецФункции

Функция ПолучитьПозицииДокумента(ДокументСсылка)
    
    МассивПозиций = Новый Массив;
    
    Попытка
        
        ЗаписатьВФайл("Получаем позиции для документа: " + Строка(ДокументСсылка));
        
        Запрос = Новый Запрос;
        Запрос.Текст = "
        |ВЫБРАТЬ
        |    Номенклатура.Наименование КАК НоменклатураНаименование,
        |    Номенклатура.Артикул КАК НоменклатураАртикул,
        |    Количество,
        |    Цена,
        |    Сумма,
        |    ЕдиницаИзмерения.Наименование КАК ЕдИзмНаименование,
        |    Номенклатура
        |ИЗ Документ.ПоступлениеТоваровУслуг.Товары КАК ТоварыДокумента
        |ГДЕ ТоварыДокумента.Ссылка = &ДокументСсылка";
        
        Запрос.УстановитьПараметр("ДокументСсылка", ДокументСсылка);
        
        Результат = Запрос.Выполнить();
        Выборка = Результат.Выбрать();
        
        СчетчикПозиций = 0;
        Пока Выборка.Следующий() Цикл
            
            СчетчикПозиций = СчетчикПозиций + 1;
            
            // Получаем название товара - пробуем разные варианты
            НазваТовару = "";
            
            Если ЗначениеЗаполнено(Выборка.НоменклатураНаименование) Тогда
                НазваТовару = Выборка.НоменклатураНаименование;
            ИначеЕсли ЗначениеЗаполнено(Выборка.Номенклатура) Тогда
                НазваТовару = Строка(Выборка.Номенклатура);
            Иначе
                НазваТовару = "Товар без названия";
            КонецЕсли;
            
            ЗаписатьВФайл("Позиция " + Строка(СчетчикПозиций) + ": " + НазваТовару + " x " + Строка(Выборка.Количество));
            
            ОбъектПозиции = Новый Структура;
            ОбъектПозиции.Вставить("НазваТовару", НазваТовару);
            ОбъектПозиции.Вставить("Артикул", Выборка.НоменклатураАртикул);
            ОбъектПозиции.Вставить("Кількість", Число(Выборка.Количество));
            ОбъектПозиции.Вставить("Ціна", Число(Выборка.Цена));
            ОбъектПозиции.Вставить("Сума", Число(Выборка.Сумма));
            ОбъектПозиции.Вставить("ОдиницяВиміру", Выборка.ЕдИзмНаименование);
            
            МассивПозиций.Добавить(ОбъектПозиции);
            
        КонецЦикла;
        
        ЗаписатьВФайл("Найдено позиций: " + Строка(СчетчикПозиций));
        
    Исключение
        ЗаписатьВФайл("ERROR позиций: " + ОписаниеОшибки());
    КонецПопытки;
    
    Возврат МассивПозиций;
    
КонецФункции

// ФАЙЛОВЕ ЛОГУВАННЯ
Процедура ЗаписатьВФайл(Текст)
    
    Попытка
        
        ИмяФайла = "c:\temp\erp_debug.txt";
        
        ФайлКаталог = Новый Файл("c:\temp");
        Если НЕ ФайлКаталог.Существует() Тогда
            СоздатьКаталог("c:\temp");
        КонецЕсли;
        
        ТекстовыйДокумент = Новый ТекстовыйДокумент;
        
        ФайлЛога = Новый Файл(ИмяФайла);
        Если ФайлЛога.Существует() Тогда
            ТекстовыйДокумент.Прочитать(ИмяФайла, КодировкаТекста.UTF8);
        КонецЕсли;
        
        СтрокаЛога = Формат(ТекущаяДата(), "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " | " + Текст;
        ТекстовыйДокумент.ДобавитьСтроку(СтрокаЛога);
        
        ТекстовыйДокумент.Записать(ИмяФайла, КодировкаТекста.UTF8);
        
    Исключение
        // Ігноруємо помилки логування
    КонецПопытки;
    
КонецПроцедуры
```

## АЛЬТЕРНАТИВНІ ВАРІАНТИ ПОЛІВ ДЛЯ НАЗВ ТОВАРІВ:

Якщо `Номенклатура.Наименование` не працює, спробуйте:

1. `Номенклатура` (просто як рядок)
2. `Номенклатура.Код + " " + Номенклатура.Наименование`
3. `ТоварыДокумента.Номенклатура.Наименование`
4. `ТоварыДокумента.Номенклатура.Описание`

## РЕЗУЛЬТАТ:

Тепер в логах `c:\temp\erp_debug.txt` ви побачите:
- Детальну інформацію про кожну позицію
- Реальні назви товарів
- Кількість знайдених позицій

## ДОДАТКОВА ДІАГНОСТИКА:

Якщо проблема залишається, можна додати до запиту позицій:
```sql
|    Номенклатура.Код КАК НоменклатураКод,
|    Номенклатура.Описание КАК НоменклатураОписание,
|    ТоварыДокумента.Номенклатура.ПолноеНаименование КАК ПолноеНаименование
```

Це допоможе знайти правильне поле з назвою товару в вашій системі.
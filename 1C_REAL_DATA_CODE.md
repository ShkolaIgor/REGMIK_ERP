# Код для отримання реальних накладних з BAF системи

## КРОК 1: Замініть тестову функцію на реальну

Замість `ПолучитьДанныеНакладных` з тестовими даними, використовуйте цю версію:

```1c
Функция ПолучитьДанныеНакладных(КоличествоЗаписей = 50)
    
    МассивНакладных = Новый Массив;
    
    Попытка
        ЗаписьЖурналаРегистрации("ERP.Real", УровеньЖурналаРегистрации.Информация,,,
            "Начинаем получение реальных накладных из базы 1C");
        
        // Дата начала - 30 дней назад
        ДатаНачала = НачалоДня(ТекущаяДата() - 30*24*3600);
        
        Запрос = Новый Запрос;
        Запрос.Текст = "
        |ВЫБРАТЬ ПЕРВЫЕ " + КоличествоЗаписей + "
        |    Ссылка КАК ДокументСсылка,
        |    Номер,
        |    Дата,
        |    Контрагент.Наименование КАК КонтрагентНаименование,
        |    СуммаДокумента,
        |    Валюта.Код КАК КодВалюты,
        |    Проведен,
        |    Статус
        |ИЗ Документ.ПоступлениеТоваровУслуг КАК ПоступлениеТоваровУслуг
        |ГДЕ ПоступлениеТоваровУслуг.Дата >= &ДатаНачала
        |    И ПоступлениеТоваровУслуг.Проведен = ИСТИНА
        |УПОРЯДОЧИТЬ ПО Дата УБЫВ";
        
        Запрос.УстановитьПараметр("ДатаНачала", ДатаНачала);
        
        Результат = Запрос.Выполнить();
        Выборка = Результат.Выбрать();
        
        Счетчик = 0;
        Пока Выборка.Следующий() Цикл
            
            Счетчик = Счетчик + 1;
            
            // Создаем объект накладной
            ОбъектНакладной = Новый Структура;
            ОбъектНакладной.Вставить("ID", Строка(Выборка.ДокументСсылка.УникальныйИдентификатор()));
            ОбъектНакладной.Вставить("НомерДокумента", Выборка.Номер);
            ОбъектНакладной.Вставить("Дата", Формат(Выборка.Дата, "ДФ=yyyy-MM-dd"));
            ОбъектНакладной.Вставить("Постачальник", Выборка.КонтрагентНаименование);
            ОбъектНакладной.Вставить("Сума", Число(Выборка.СуммаДокумента));
            ОбъектНакладной.Вставить("Валюта", Выборка.КодВалюты);
            ОбъектНакладной.Вставить("Статус", "confirmed");
            
            // Получаем позиции документа
            МассивПозиций = ПолучитьПозицииДокумента(Выборка.ДокументСсылка);
            ОбъектНакладной.Вставить("Позиції", МассивПозиций);
            
            МассивНакладных.Добавить(ОбъектНакладной);
            
        КонецЦикла;
        
        ЗаписьЖурналаРегистрации("ERP.Real", УровеньЖурналаРегистрации.Информация,,,
            "Получено реальных накладных: " + Строка(Счетчик));
        
    Исключение
        ЗаписьЖурналаРегистрации("ERP.Error", УровеньЖурналаРегистрации.Ошибка,,,
            "Ошибка получения реальных накладных: " + ОписаниеОшибки());
    КонецПопытки;
    
    Возврат МассивНакладных;
    
КонецФункции
```

## КРОК 2: Додайте функцію для отримання позицій

```1c
Функция ПолучитьПозицииДокумента(ДокументСсылка)
    
    МассивПозиций = Новый Массив;
    
    Попытка
        
        Запрос = Новый Запрос;
        Запрос.Текст = "
        |ВЫБРАТЬ
        |    Номенклатура.Наименование КАК НазваТовару,
        |    Номенклатура.Артикул КАК Артикул,
        |    Количество,
        |    Цена,
        |    Сумма,
        |    ЕдиницаИзмерения.Наименование КАК ЕдиницаИзмерения
        |ИЗ Документ.ПоступлениеТоваровУслуг.Товары КАК ТоварыДокумента
        |ГДЕ ТоварыДокумента.Ссылка = &ДокументСсылка";
        
        Запрос.УстановитьПараметр("ДокументСсылка", ДокументСсылка);
        
        Результат = Запрос.Выполнить();
        Выборка = Результат.Выбрать();
        
        Пока Выборка.Следующий() Цикл
            
            ОбъектПозиции = Новый Структура;
            ОбъектПозиции.Вставить("НазваТовару", Выборка.НазваТовару);
            ОбъектПозиции.Вставить("Артикул", Выборка.Артикул);
            ОбъектПозиции.Вставить("Кількість", Число(Выборка.Количество));
            ОбъектПозиции.Вставить("Ціна", Число(Выборка.Цена));
            ОбъектПозиции.Вставить("Сума", Число(Выборка.Сумма));
            ОбъектПозиции.Вставить("ОдиницяВиміру", Выборка.ЕдиницаИзмерения);
            
            МассивПозиций.Добавить(ОбъектПозиции);
            
        КонецЦикла;
        
    Исключение
        ЗаписьЖурналаРегистрации("ERP.Error", УровеньЖурналаРегистрации.Ошибка,,,
            "Ошибка получения позиций для " + Строка(ДокументСсылка) + ": " + ОписаниеОшибки());
    КонецПопытки;
    
    Возврат МассивПозиций;
    
КонецФункции
```

## КРОК 3: Оновіть основну функцію HTTP-сервісу

```1c
Функция invoicesPOST(Запрос)
    
    Попытка
        ЗаписьЖурналаРегистрации("ERP.Real", УровеньЖурналаРегистрации.Информация,,,
            "Получен запрос реальных накладных от ERP системы");
        
        // Получаем реальные накладные из базы
        МассивНакладных = ПолучитьДанныеНакладных(50);
        
        // Преобразуем в JSON
        ЗаписьJSON = Новый ЗаписьJSON;
        ЗаписьJSON.УстановитьСтроку();
        ЗаписатьJSON(ЗаписьJSON, МассивНакладных);
        СтрокаJSON = ЗаписьJSON.Закрыть();
        
        // Создаем ответ
        Ответ = Новый HTTPСервисОтвет(200);
        Ответ.УстановитьТелоИзСтроки(СтрокаJSON, КодировкаТекста.UTF8);
        Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
        
        ЗаписьЖурналаРегистрации("ERP.Real", УровеньЖурналаРегистрации.Информация,,,
            "Отправлено накладных: " + Строка(МассивНакладных.Количество()));
        
        Возврат Ответ;
        
    Исключение
        ЗаписьЖурналаРегистрации("ERP.Error", УровеньЖурналаРегистрации.Ошибка,,,
            "Ошибка в invoicesPOST: " + ОписаниеОшибки());
        
        ОтветОшибка = Новый HTTPСервисОтвет(500);
        ОтветОшибка.УстановитьТелоИзСтроки("Error: " + ОписаниеОшибки(), КодировкаТекста.UTF8);
        Возврат ОтветОшибка;
        
    КонецПопытки;
    
КонецФункции
```

## Виправлена помилка JSON:

❌ `СтрокаJSON = ЗаписатьJSON(ЗаписьJSON, МассивНакладных)` - неправильно  
✅ Правильний синтаксис:
```1c
ЗаписьJSON = Новый ЗаписьJSON;
ЗаписьJSON.УстановитьСтроку();
ЗаписатьJSON(ЗаписьJSON, МассивНакладных);
СтрокаJSON = ЗаписьJSON.Закрыть();
```

## Очікувані результати:

Після встановлення цього коду ERP отримає справжні накладні з BAF системи:
- Проведені документи за останні 30 днів
- Повна інформація про контрагентів  
- Детальні позиції з товарами, цінами та кількостями
- Правильне форматування дат та валют

## Альтернативні назви документів:

Якщо `Документ.ПоступлениеТоваровУслуг` не працює, спробуйте:
- `Документ.ПоступлениеТоваров`
- `Документ.ПриходнаяНакладная` 
- `Документ.ПоступлениеМатериалов`

## Налаштування фільтрів:

- **Період**: змініть `30*24*3600` для іншого періоду
- **Кількість**: змініть параметр `КоличествоЗаписей`
- **Статус**: додайте умови для конкретних статусів
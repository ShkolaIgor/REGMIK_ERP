# ВИПРАВЛЕНИЙ КОД 1C З ФАЙЛОВИМ ЛОГУВАННЯМ

## ПОВНИЙ РОБОЧИЙ КОД для HTTP-сервісу

```1c
Функция invoicesPOST(Запрос)
    
    Попытка
        // Логування в файл замість журналу
        ЗаписатьВФайл("Получен запрос накладных от ERP системы");
        
        // Получаем реальные накладные из базы
        МассивНакладных = ПолучитьДанныеНакладных(50);
        
        ЗаписатьВФайл("Найдено накладных: " + Строка(МассивНакладных.Количество()));
        
        // Преобразуем в JSON
        ЗаписьJSON = Новый ЗаписьJSON;
        ЗаписьJSON.УстановитьСтроку();
        ЗаписатьJSON(ЗаписьJSON, МассивНакладных);
        СтрокаJSON = ЗаписьJSON.Закрыть();
        
        ЗаписатьВФайл("JSON создан, длина: " + Строка(СтрДлина(СтрокаJSON)));
        
        // Создаем ответ
        Ответ = Новый HTTPСервисОтвет(200);
        Ответ.УстановитьТелоИзСтроки(СтрокаJSON, КодировкаТекста.UTF8);
        Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
        
        ЗаписатьВФайл("Ответ отправлен успешно");
        
        Возврат Ответ;
        
    Исключение
        ЗаписатьВФайл("ОШИБКА в invoicesPOST: " + ОписаниеОшибки());
        
        ОтветОшибка = Новый HTTPСервисОтвет(500);
        ОтветОшибка.УстановитьТелоИзСтроки("Error: " + ОписаниеОшибки(), КодировкаТекста.UTF8);
        Возврат ОтветОшибка;
        
    КонецПопытки;
    
КонецФункции

Функция ПолучитьДанныеНакладных(КоличествоЗаписей = 50)
    
    МассивНакладных = Новый Массив;
    
    Попытка
        ЗаписатьВФайл("Начинаем получение реальных накладных");
        
        // Дата начала - 30 дней назад
        ДатаНачала = НачалоДня(ТекущаяДата() - 30*24*3600);
        ЗаписатьВФайл("Дата начала: " + Строка(ДатаНачала));
        
        Запрос = Новый Запрос;
        Запрос.Текст = "
        |ВЫБРАТЬ ПЕРВЫЕ " + КоличествоЗаписей + "
        |    Ссылка КАК ДокументСсылка,
        |    Номер,
        |    Дата,
        |    Контрагент.Наименование КАК КонтрагентНаименование,
        |    СуммаДокумента,
        |    ВалютаДокумента.Код КАК КодВалюты,
        |    Проведен,
        |    Статус
        |ИЗ Документ.ПоступлениеТоваровУслуг КАК ПоступлениеТоваровУслуг
        |ГДЕ ПоступлениеТоваровУслуг.Дата >= &ДатаНачала
        |    И ПоступлениеТоваровУслуг.Проведен = ИСТИНА
        |УПОРЯДОЧИТЬ ПО Дата УБЫВ";
        
        Запрос.УстановитьПараметр("ДатаНачала", ДатаНачала);
        
        ЗаписатьВФайл("Выполняем запрос к базе...");
        
        Результат = Запрос.Выполнить();
        Выборка = Результат.Выбрать();
        
        ЗаписатьВФайл("Запрос выполнен, обрабатываем результаты...");
        
        Счетчик = 0;
        Пока Выборка.Следующий() Цикл
            
            Счетчик = Счетчик + 1;
            
            ЗаписатьВФайл("Обрабатываем накладную " + Строка(Счетчик) + ": " + Выборка.Номер);
            
            // Создаем объект накладной
            ОбъектНакладной = Новый Структура;
            ОбъектНакладной.Вставить("ID", Строка(Выборка.ДокументСсылка.УникальныйИдентификатор()));
            ОбъектНакладной.Вставить("НомерДокумента", Выборка.Номер);
            ОбъектНакладной.Вставить("Дата", Формат(Выборка.Дата, "ДФ=yyyy-MM-dd"));
            ОбъектНакладной.Вставить("Постачальник", Выборка.КонтрагентНаименование);
            ОбъектНакладной.Вставить("Сума", Число(Выборка.СуммаДокумента));
            ОбъектНакладной.Вставить("Валюта", Выборка.КодВалюты);
            ОбъектНакладной.Вставить("Статус", "confirmed");
            
            // Получаем позиции документа
            МассивПозиций = ПолучитьПозицииДокумента(Выборка.ДокументСсылка);
            ОбъектНакладной.Вставить("Позиції", МассивПозиций);
            
            МассивНакладных.Добавить(ОбъектНакладной);
            
        КонецЦикла;
        
        ЗаписатьВФайл("ИТОГО получено накладных: " + Строка(Счетчик));
        
    Исключение
        ЗаписатьВФайл("ОШИБКА получения накладных: " + ОписаниеОшибки());
    КонецПопытки;
    
    Возврат МассивНакладных;
    
КонецФункции

Функция ПолучитьПозицииДокумента(ДокументСсылка)
    
    МассивПозиций = Новый Массив;
    
    Попытка
        
        Запрос = Новый Запрос;
        Запрос.Текст = "
        |ВЫБРАТЬ
        |    Номенклатура.Наименование КАК НазваТовару,
        |    Номенклатура.Артикул КАК Артикул,
        |    Количество,
        |    Цена,
        |    Сумма,
        |    ЕдиницаИзмерения.Наименование КАК ЕдиницаИзмерения
        |ИЗ Документ.ПоступлениеТоваровУслуг.Товары КАК ТоварыДокумента
        |ГДЕ ТоварыДокумента.Ссылка = &ДокументСсылка";
        
        Запрос.УстановитьПараметр("ДокументСсылка", ДокументСсылка);
        
        Результат = Запрос.Выполнить();
        Выборка = Результат.Выбрать();
        
        Пока Выборка.Следующий() Цикл
            
            ОбъектПозиции = Новый Структура;
            ОбъектПозиции.Вставить("НазваТовару", Выборка.НазваТовару);
            ОбъектПозиции.Вставить("Артикул", Выборка.Артикул);
            ОбъектПозиции.Вставить("Кількість", Число(Выборка.Количество));
            ОбъектПозиции.Вставить("Ціна", Число(Выборка.Цена));
            ОбъектПозиции.Вставить("Сума", Число(Выборка.Сумма));
            ОбъектПозиции.Вставить("ОдиницяВиміру", Выборка.ЕдиницаИзмерения);
            
            МассивПозиций.Добавить(ОбъектПозиции);
            
        КонецЦикла;
        
    Исключение
        ЗаписатьВФайл("ОШИБКА получения позиций: " + ОписаниеОшибки());
    КонецПопытки;
    
    Возврат МассивПозиций;
    
КонецФункции

// ФУНКЦИЯ ЛОГУВАННЯ В ФАЙЛ
Процедура ЗаписатьВФайл(Текст)
    
    Попытка
        
        ИмяФайла = "c:\temp\erp_debug.txt";
        
        // Создаем директорию если не существует
        ФайлКаталог = Новый Файл("c:\temp");
        Если НЕ ФайлКаталог.Существует() Тогда
            СоздатьКаталог("c:\temp");
        КонецЕсли;
        
        ТекстовыйДокумент = Новый ТекстовыйДокумент;
        
        // Читаем существующий файл если есть
        ФайлЛога = Новый Файл(ИмяФайла);
        Если ФайлЛога.Существует() Тогда
            ТекстовыйДокумент.Прочитать(ИмяФайла, КодировкаТекста.UTF8);
        КонецЕсли;
        
        // Добавляем новую запись
        СтрокаЛога = Формат(ТекущаяДата(), "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " | " + Текст;
        ТекстовыйДокумент.ДобавитьСтроку(СтрокаЛога);
        
        // Записываем в файл
        ТекстовыйДокумент.Записать(ИмяФайла, КодировкаТекста.UTF8);
        
    Исключение
        // Если файловое логирование не работает, игнорируем
    КонецПопытки;
    
КонецПроцедуры
```

## АЛЬТЕРНАТИВНЫЕ НАЗВАНИЯ ДОКУМЕНТОВ

Если `Документ.ПоступлениеТоваровУслуг` не работает, попробуйте:

1. `Документ.ПоступлениеТоваров`
2. `Документ.ПриходнаяНакладная` 
3. `Документ.ПоступлениеМатериалов`
4. `Документ.Поступление`

## ФАЙЛ ЛОГОВ

Логи будут записываться в: `c:\temp\erp_debug.txt`

Если папка `c:\temp` недоступна, измените на:
- `ИмяФайла = ПолучитьИмяВременногоФайла("txt");`

## ДИАГНОСТИКА

После установки кода проверьте файл `c:\temp\erp_debug.txt` - там будет видно:
- Сколько накладных найдено
- Какие ошибки возникают
- Какие запросы выполняются
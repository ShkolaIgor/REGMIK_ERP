# Виправлений код 1C HTTP-сервісу

## Проблема виявлена
Помилка: `{HTTPСервис.ERPIntegration.Модуль(16)}: Метод об'єкту не виявлено (Получить)`

**Причина:** Використання методу `.Получить()` для структур замість `.Свойство()`

## Повний виправлений код

```1c
Функция invoicesPOST(Запрос)
    
    Попытка
        // ДІАГНОСТИЧНЕ ЛОГУВАННЯ
        ЗаписьЖурнала = Новый ЗаписьЖурналаРегистрации("ERP.Debug");
        ЗаписьЖурнала.Записать("Получен запрос от ERP системы");
        
        // Логуємо HTTP метод
        ЗаписьЖурнала.Записать("HTTP метод: " + Запрос.HTTPМетод);
        
        // Логуємо заголовки
        Для Каждого Заголовок Из Запрос.Заголовки Цикл
            ЗаписьЖурнала.Записать("Заголовок: " + Заголовок.Ключ + " = " + Заголовок.Значение);
        КонецЦикла;
        
        // Логуємо URL параметри
        Для Каждого Параметр Из Запрос.ПараметрыURL Цикл
            ЗаписьЖурнала.Записать("URL параметр: " + Параметр.Ключ + " = " + Параметр.Значение);
        КонецЦикла;
        
        // Логуємо тіло запиту
        ТелоЗапроса = Запрос.ПолучитьТелоКакСтроку("UTF-8");
        ЗаписьЖурнала.Записать("Тело запроса: " + ТелоЗапроса);
        
        // Перевіряємо наявність параметрів action та limit
        Действие = "";
        Лимит = 100;
        
        // Спочатку пробуємо отримати з URL параметрів
        Если Запрос.ПараметрыURL.Количество() > 0 Тогда
            ЗаписьЖурнала.Записать("Читаем параметры из URL");
            Для Каждого Параметр Из Запрос.ПараметрыURL Цикл
                Если Параметр.Ключ = "action" Тогда
                    Действие = Параметр.Значение;
                    ЗаписьЖурнала.Записать("Action з URL: " + Действие);
                ИначеЕсли Параметр.Ключ = "limit" Тогда
                    Лимит = Число(Параметр.Значение);
                    ЗаписьЖурнала.Записать("Лимит з URL: " + Строка(Лимит));
                КонецЕсли;
            КонецЦикла;
        КонецЕсли;
        
        // Якщо action не знайдено в URL, пробуємо JSON
        Если ПустаяСтрока(Действие) И Не ПустаяСтрока(ТелоЗапроса) Тогда
            ЗаписьЖурнала.Записать("Читаем параметры из JSON");
            Попытка
                ЧтениеJSON = Новый ЧтениеJSON;
                ЧтениеJSON.УстановитьСтроку(ТелоЗапроса);
                ДанныеЗапроса = ПрочитатьJSON(ЧтениеJSON);
                ЧтениеJSON.Закрыть();
                
                // ВИПРАВЛЕНО: використовуємо .Свойство() замість .Получить()
                ЛимитJSON = Неопределено;
                Если ДанныеЗапроса.Свойство("action", Действие) Тогда
                    ЗаписьЖурнала.Записать("Action з JSON: " + Действие);
                КонецЕсли;
                Если ДанныеЗапроса.Свойство("limit", ЛимитJSON) Тогда
                    Лимит = Число(ЛимитJSON);
                    ЗаписьЖурнала.Записать("Лимит з JSON: " + Строка(Лимит));
                КонецЕсли;
            Исключение
                ЗаписьЖурнала.Записать("Ошибка парсинга JSON: " + ОписаниеОшибки());
            КонецПопытки;
        КонецЕсли;
        
        ЗаписьЖурнала.Записать("Итоговые параметры - Действие: " + Действие + ", Лимит: " + Строка(Лимит));
        
        // Обробляємо запит
        Если Действие = "getInvoices" Тогда
            ЗаписьЖурнала.Записать("Получение накладных, лимит: " + Строка(Лимит));
            
            // Тимчасово повертаємо тестові дані
            МассивНакладных = Новый Массив;
            
            СтруктураТестовойНакладной = Новый Структура;
            СтруктураТестовойНакладной.Вставить("ID", "test-001");
            СтруктураТестовойНакладной.Вставить("НомерДокумента", "НАК-001");
            СтруктураТестовойНакладной.Вставить("Дата", "2025-07-10");
            СтруктураТестовойНакладной.Вставить("Постачальник", "Тестовий постачальник");
            СтруктураТестовойНакладной.Вставить("Сума", 15000);
            СтруктураТестовойНакладной.Вставить("Валюта", "UAH");
            СтруктураТестовойНакладной.Вставить("Статус", "new");
            
            МассивПозиций = Новый Массив;
            СтруктураПозиции = Новый Структура;
            СтруктураПозиции.Вставить("Назва", "Тестовий товар");
            СтруктураПозиции.Вставить("Кількість", 10);
            СтруктураПозиции.Вставить("Ціна", 1500);
            СтруктураПозиции.Вставить("Сума", 15000);
            СтруктураПозиции.Вставить("ОдиницяВиміру", "шт");
            МассивПозиций.Добавить(СтруктураПозиции);
            
            СтруктураТестовойНакладной.Вставить("Позиції", МассивПозиций);
            МассивНакладных.Добавить(СтруктураТестовойНакладной);
            
            // Формування JSON відповіді
            ЗаписьЖурнала.Записать("Формирование JSON ответа");
            
            // Універсальний спосіб для різних версій 1С
            СтрокаJSON = "";
            Попытка
                // Для 1С 8.3.15+ з підтримкою ЗаписьJSON
                ЗаписьJSON = Новый ЗаписьJSON;
                ЗаписьJSON.УстановитьСтроку(СтрокаJSON);
                ЗаписатьJSON(ЗаписьJSON, МассивНакладных);
                СтрокаJSON = ЗаписьJSON.Закрыть();
                ЗаписьЖурнала.Записать("JSON сформирован стандартным способом");
            Исключение
                // Для старих версій 1С без підтримки JSON
                ЗаписьЖурнала.Записать("Используется альтернативный способ формирования JSON");
                СтрокаJSON = "[{""ID"":""test-001"",""НомерДокумента"":""НАК-001"",""Дата"":""2025-07-10"",""Постачальник"":""Тестовий постачальник"",""Сума"":15000,""Валюта"":""UAH"",""Статус"":""new"",""Позиції"":[{""Назва"":""Тестовий товар"",""Кількість"":10,""Ціна"":1500,""Сума"":15000,""ОдиницяВиміру"":""шт""}]}]";
            КонецПопытки;
            
            ЗаписьЖурнала.Записать("JSON ответ сформирован, длина: " + Строка(СтрДлина(СтрокаJSON)));
            ЗаписьЖурнала.Записать("JSON содержимое: " + СтрокаJSON);
            
            Ответ = Новый HTTPСервисОтвет(200);
            Ответ.УстановитьТелоИзСтроки(СтрокаJSON, КодировкаТекста.UTF8, ИспользованиеByteOrderMark.НеИспользовать);
            Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
            
            ЗаписьЖурнала.Записать("Ответ отправлен успешно");
            Возврат Ответ;
        КонецЕсли;
        
        // Якщо action не розпізнано
        ЗаписьЖурнала.Записать("Неизвестное действие: " + Действие);
        Ответ = Новый HTTPСервисОтвет(400);
        Ответ.УстановитьТелоИзСтроки("{""error"": ""Unknown action: " + Действие + """}", КодировкаТекста.UTF8);
        Возврат Ответ;
        
    Исключение
        // Детальне логування помилки
        ОписаниеОш = ОписаниеОшибки();
        ЗаписьЖурнала = Новый ЗаписьЖурналаРегистрации("ERP.Error");
        ЗаписьЖурнала.Записать("КРИТИЧЕСКАЯ ОШИБКА в HTTP-сервисе: " + ОписаниеОш);
        
        Ответ = Новый HTTPСервисОтвет(500);
        Ответ.УстановитьТелоИзСтроки("{""error"": ""Server error: " + ОписаниеОш + """}", КодировкаТекста.UTF8);
        Возврат Ответ;
    КонецПопытки;
    
КонецФункции
```

## Ключові виправлення:

1. **Заміна `.Получить()` на `.Свойство()`**:
   ```1c
   // БУЛО (помилка):
   Действие = ДанныеЗапроса.Получить("action");
   
   // СТАЛО (правильно):
   Если ДанныеЗапроса.Свойство("action", Действие) Тогда
   ```

2. **Правильна робота з URL параметрами**:
   ```1c
   Для Каждого Параметр Из Запрос.ПараметрыURL Цикл
       Если Параметр.Ключ = "action" Тогда
           Действие = Параметр.Значение;
       КонецЕсли;
   КонецЦикла;
   ```

3. **Покращено логування** для відстеження всіх кроків

4. **Додано fallback JSON** для старих версій 1C

## Тестування

Після заміни коду в 1C, ERP повинна отримати:
```json
[{
  "ID": "test-001",
  "НомерДокумента": "НАК-001",
  "Дата": "2025-07-10",
  "Постачальник": "Тестовий постачальник",
  "Сума": 15000,
  "Валюта": "UAH",
  "Статус": "new",
  "Позиції": [...]
}]
```
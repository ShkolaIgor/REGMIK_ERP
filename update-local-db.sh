#!/bin/bash

# REGMIK ERP - –õ–æ–∫–∞–ª—å–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
# –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —Ü–µ–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö –ø—ñ—Å–ª—è –∑–º—ñ–Ω

echo "üîÑ REGMIK ERP - –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ª–æ–∫–∞–ª—å–Ω–æ—ó –±–∞–∑–∏ –¥–∞–Ω–∏—Ö"
echo "=============================================="

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —ñ—Å–Ω—É—î .env —Ñ–∞–π–ª
if [ ! -f .env ]; then
    echo "‚ùå –§–∞–π–ª .env –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –°—Ç–≤–æ—Ä—ñ—Ç—å –π–æ–≥–æ –∑ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è–º–∏ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö."
    exit 1
fi

# –°—Ç–≤–æ—Ä—é—î–º–æ backup –±–∞–∑–∏ –¥–∞–Ω–∏—Ö (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
echo "üíæ –°—Ç–≤–æ—Ä—é—î–º–æ backup –±–∞–∑–∏ –¥–∞–Ω–∏—Ö..."
BACKUP_NAME="backup_$(date +%Y%m%d_%H%M%S).sql"
if command -v pg_dump &> /dev/null && [ ! -z "$DATABASE_URL" ]; then
    pg_dump "$DATABASE_URL" > "$BACKUP_NAME"
    echo "‚úÖ Backup —Å—Ç–≤–æ—Ä–µ–Ω–æ: $BACKUP_NAME"
else
    echo "‚ö†Ô∏è  pg_dump –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π –∞–±–æ DATABASE_URL –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
fi

# –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ —Å—Ö–µ–º—É –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
echo "üîÑ –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è —Å—Ö–µ–º–∏ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö..."
npm run db:push

if [ $? -eq 0 ]; then
    echo "‚úÖ –°—Ö–µ–º–∞ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö —É—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–∞"
else
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ —Å—Ö–µ–º–∏ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö"
    exit 1
fi

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –±–∞–∑–∏
echo "üîç –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö..."
node -e "
const { Pool } = require('@neondatabase/serverless');
const pool = new Pool({ connectionString: process.env.DATABASE_URL });
pool.query('SELECT NOW() as current_time')
  .then(result => {
    console.log('‚úÖ –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö —É—Å–ø—ñ—à–Ω–µ');
    console.log('‚è∞ –ß–∞—Å —Å–µ—Ä–≤–µ—Ä–∞:', result.rows[0].current_time);
    process.exit(0);
  })
  .catch(err => {
    console.log('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö:', err.message);
    process.exit(1);
  });
"

echo ""
echo "üéâ –û–Ω–æ–≤–ª–µ–Ω–Ω—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "üîß –ö–æ—Ä–∏—Å–Ω—ñ –∫–æ–º–∞–Ω–¥–∏:"
echo "   npm run db:push          # —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è —Å—Ö–µ–º–∏"
echo "   npm run db:studio        # –≤–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±–∞–∑–∏ –¥–∞–Ω–∏—Ö"
echo "   npm run dev              # –∑–∞–ø—É—Å–∫ –¥–æ–¥–∞—Ç–∫–∞"
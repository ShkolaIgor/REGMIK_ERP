# Фільтрація по рахунку обліку 202 в 1С

## Оновлений код 1С з фільтрацією по рахунку 202

```1c
// Функція для отримання накладних з фільтрацією по рахунку обліку 202
Функция ПолучитьНакладныеСФильтромПо202() Экспорт
    
    МассивНакладных = Новый Массив;
    
    // Отримуємо накладні за останні 3 місяці
    ДатаНачала = НачалоМесяца(ТекущаяДата() - 86400 * 90); // 3 місяці назад
    ДатаОкончания = КонецДня(ТекущаяДата());
    
    Запрос = Новый Запрос;
    Запрос.Текст = "
        |ВЫБРАТЬ РАЗЛИЧНЫЕ
        |    Документ.Ссылка КАК СсылкаДокумента,
        |    Документ.Номер КАК НомерДокумента,
        |    Документ.Дата КАК ДатаДокумента,
        |    Документ.Контрагент КАК Контрагент,
        |    Документ.Контрагент.Наименование КАК НаименованиеКонтрагента,
        |    Документ.Контрагент.ИНН КАК ИННКонтрагента,
        |    Документ.СуммаДокумента КАК СуммаДокумента,
        |    Документ.ВалютаДокумента.Код КАК КодВалюты,
        |    Документ.Проведен КАК Проведен
        |ИЗ
        |    Документ.ПоступлениеТоваровИУслуг КАК Документ
        |        ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПоступлениеТоваровИУслуг.Товары КАК Товары
        |        ПО Документ.Ссылка = Товары.Ссылка
        |        И Товары.СчетУчетаБУ.Код = ""202""
        |ГДЕ
        |    Документ.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
        |    И Документ.ПометкаУдаления = ЛОЖЬ
        |    И Документ.Проведен = ИСТИНА
        |УПОРЯДОЧИТЬ ПО
        |    Документ.Дата УБЫВ";
    
    Запрос.УстановитьПараметр("ДатаНачала", ДатаНачала);
    Запрос.УстановитьПараметр("ДатаОкончания", ДатаОкончания);
    
    РезультатЗапроса = Запрос.Выполнить();
    Выборка = РезультатЗапроса.Выбрать();
    
    Пока Выборка.Следующий() Цикл
        
        СтруктураНакладной = Новый Структура;
        СтруктураНакладной.Вставить("id", Строка(Выборка.СсылкаДокумента.УникальныйИдентификатор()));
        СтруктураНакладной.Вставить("number", Выборка.НомерДокумента);
        СтруктураНакладной.Вставить("date", Формат(Выборка.ДатаДокумента, "ДФ=yyyy-MM-dd"));
        СтруктураНакладной.Вставить("supplierName", Выборка.НаименованиеКонтрагента);
        СтруктураНакладной.Вставить("supplierTaxCode", Выборка.ИННКонтрагента);
        СтруктураНакладной.Вставить("amount", Выборка.СуммаДокумента);
        СтруктураНакладной.Вставить("currency", Выборка.КодВалюты);
        СтруктураНакладной.Вставить("status", ?(Выборка.Проведен, "posted", "draft"));
        СтруктураНакладной.Вставить("hasAccount202", Истина); // Маркер що накладна має позиції з рахунку 202
        
        // Отримуємо тільки позиції з рахунку обліку 202
        Позиции = ПолучитьПозицииТолькоПо202(Выборка.СсылкаДокумента);
        СтруктураНакладной.Вставить("items", Позиции);
        
        МассивНакладных.Добавить(СтруктураНакладной);
        
    КонецЦикла;
    
    Возврат МассивНакладных;
    
КонецФункции

// Функція для отримання тільки позицій з рахунку 202
Функция ПолучитьПозицииТолькоПо202(СсылкаДокумента)
    
    МассивПозиций = Новый Массив;
    
    Запрос = Новый Запрос;
    Запрос.Текст = "
        |ВЫБРАТЬ
        |    Товары.Номенклатура КАК Номенклатура,
        |    Товары.Номенклатура.Наименование КАК НаименованиеТовара,
        |    Товары.Номенклатура.Артикул КАК АртикулТовара,
        |    Товары.Номенклатура.Код КАК КодТовара,
        |    Товары.Количество КАК Количество,
        |    Товары.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
        |    Товары.ЕдиницаИзмерения.Наименование КАК НаименованиеЕдиницыИзмерения,
        |    Товары.Цена КАК Цена,
        |    Товары.Сумма КАК Сумма,
        |    Товары.СчетУчетаБУ КАК СчетУчетаБУ,
        |    Товары.СчетУчетаБУ.Код КАК КодСчетаУчета
        |ИЗ
        |    Документ.ПоступлениеТоваровИУслуг.Товары КАК Товары
        |ГДЕ
        |    Товары.Ссылка = &СсылкаДокумента
        |    И Товары.СчетУчетаБУ.Код = ""202""
        |УПОРЯДОЧИТЬ ПО
        |    Товары.НомерСтроки";
    
    Запрос.УстановитьПараметр("СсылкаДокумента", СсылкаДокумента);
    
    РезультатЗапроса = Запрос.Выполнить();
    ВыборкаПозиций = РезультатЗапроса.Выбрать();
    
    Пока ВыборкаПозиций.Следующий() Цикл
        
        СтруктураПозиции = Новый Структура;
        
        // Отримуємо найдовшу назву товару з доступних полів
        НазваТовара = "";
        Если ЗначениеЗаполнено(ВыборкаПозиций.НаименованиеТовара) Тогда
            НазваТовара = ВыборкаПозиций.НаименованиеТовара;
        ИначеЕсли ЗначениеЗаполнено(ВыборкаПозиций.КодТовара) Тогда
            НазваТовара = ВыборкаПозиций.КодТовара;
        Иначе
            НазваТовара = "Товар без назви";
        КонецЕсли;
        
        СтруктураПозиции.Вставить("name", НазваТовара);
        СтруктураПозиции.Вставить("originalName", ВыборкаПозиций.НаименованиеТовара);
        СтруктураПозиции.Вставить("sku", ВыборкаПозиций.АртикулТовара);
        СтруктураПозиции.Вставить("code", ВыборкаПозиций.КодТовара);
        СтруктураПозиции.Вставить("quantity", ВыборкаПозиций.Количество);
        СтруктураПозиции.Вставить("unit", ВыборкаПозиций.НаименованиеЕдиницыИзмерения);
        СтруктураПозиции.Вставить("price", ВыборкаПозиций.Цена);
        СтруктураПозиции.Вставить("total", ВыборкаПозиций.Сумма);
        СтруктураПозиции.Вставить("accountCode", ВыборкаПозиций.КодСчетаУчета); // Код рахунку обліку
        
        МассивПозиций.Добавить(СтруктураПозиции);
        
    КонецЦикла;
    
    Возврат МассивПозиций;
    
КонецФункции

// Оновлена основна функція обробника HTTP-сервісу
Функция ПолучитьРеальныеВходящиеНакладныеСФильтром202(ПараметрыЗапроса)
    
    Попытка
        
        // Отримуємо накладні з фільтрацією по рахунку 202
        МассивНакладных = ПолучитьНакладныеСФільтромПо202();
        
        // Формуємо JSON відповідь
        ЗаписьJSON = Новый ЗаписьJSON;
        СтрокаJSON = "";
        ЗаписьJSON.УстановитьСтроку(СтрокаJSON);
        ЗаписатьJSON(ЗаписьJSON, МассивНакладных);
        СтрокаJSON = ЗаписьJSON.Закрыть();
        
        Лог = "Отримано накладних з рахунком 202: " + МассивНакладных.Количество() + Символы.ПС + СтрокаJSON;
        ЗаписатьВФайл("c:\temp\erp_202_filter.txt", Лог);
        
        Возврат СтрокаJSON;
        
    Исключение
        
        ТекстОшибки = ОписаниеОшибки();
        ЗаписатьВФайл("c:\temp\erp_202_error.txt", "Помилка фільтрації по 202: " + ТекстОшибки);
        Возврат "[]"; // Повертаємо порожній масив у разі помилки
        
    КонецПопытки;
    
КонецФункции
```

## Налаштування HTTP-сервісу

Додайте новий метод до HTTP-сервісу в 1С:

1. Відкрийте HTTP-сервіс "erp" 
2. Додайте новий URL-шаблон: `/invoices-202`
3. Метод: `GET`
4. Обробник: `ПолучитьРеальныеВходящиеНакладныеСФільтром202`

## Тестування

URL для тестування: `http://ваш-сервер:порт/hs/erp/invoices-202`

Цей код буде повертати тільки накладні, які мають товарні позиції на рахунку обліку 202, і в кожній накладній будуть показані тільки позиції з цим рахунком обліку.
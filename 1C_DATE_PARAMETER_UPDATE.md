# 1C Code Update: Date Parameter Support

## Problem
Current 1C code uses hardcoded date range (last 3 months) but ERP system sends date period parameters that need to be processed.

## Solution
Update the 1C HTTP service to accept and process date parameters from ERP requests.

## Updated 1C Code

```1c
// Ресурс: /invoices
// Метод: POST
// Шаблон URL: /invoices     

Функция invoices_POST(Запрос)
    
    ИмяФайлаЛога = "c:\temp\erp_icoming_debug.txt";  
    
    Попытка
        // Парсинг параметров из тела запроса
        ТелоЗапроса = Запрос.ПолучитьТелоКакСтроку();
        
        // Параметры по умолчанию (последние 3 месяца)
        ДатаНачала = НачалоМесяца(ТекущаяДата() - 86400 * 90);
        ДатаОкончания = КонецДня(ТекущаяДата());
        
        // Попытка распарсить JSON с параметрами
        Если НЕ ПустаяСтрока(ТелоЗапроса) Тогда
            Попытка
                ЧтениеJSON = Новый ЧтениеJSON;
                ЧтениеJSON.УстановитьСтроку(ТелоЗапроса);
                ПараметрыЗапроса = ПрочитатьJSON(ЧтениеJSON);
                ЧтениеJSON.Закрыть();
                
                // Обработка параметров периода
                Если ПараметрыЗапроса.Свойство("period") Тогда
                    Период = ПараметрыЗапроса.period;
                    
                    Если Период = "today" Тогда
                        ДатаНачала = НачалоДня(ТекущаяДата());
                        ДатаОкончания = КонецДня(ТекущаяДата());
                    ИначеЕсли Период = "last3days" Тогда
                        ДатаНачала = НачалоДня(ТекущаяДата() - 2*86400);
                        ДатаОкончания = КонецДня(ТекущаяДата());
                    ИначеЕсли Период = "last5days" Тогда
                        ДатаНачала = НачалоДня(ТекущаяДата() - 4*86400);
                        ДатаОкончания = КонецДня(ТекущаяДата());
                    ИначеЕсли Период = "last7days" Тогда
                        ДатаНачала = НачалоДня(ТекущаяДата() - 6*86400);
                        ДатаОкончания = КонецДня(ТекущаяДата());
                    ИначеЕсли Период = "last30days" Тогда
                        ДатаНачала = НачалоДня(ТекущаяДата() - 29*86400);
                        ДатаОкончания = КонецДня(ТекущаяДата());
                    ИначеЕсли Период = "last90days" Тогда
                        ДатаНачала = НачалоДня(ТекущаяДата() - 89*86400);
                        ДатаОкончания = КонецДня(ТекущаяДата());
                    КонецЕсли;
                КонецЕсли;
                
                // Обработка пользовательских дат
                Если ПараметрыЗапроса.Свойство("dateFrom") И НЕ ПустаяСтрока(ПараметрыЗапроса.dateFrom) Тогда
                    ДатаНачала = Дата(ПараметрыЗапроса.dateFrom);
                КонецЕсли;
                
                Если ПараметрыЗапроса.Свойство("dateTo") И НЕ ПустаяСтрока(ПараметрыЗапроса.dateTo) Тогда
                    ДатаОкончания = КонецДня(Дата(ПараметрыЗапроса.dateTo));
                КонецЕсли;
                
                // Логирование полученных параметров
                ЗаписатьВФайл(ИмяФайлаЛога, "Параметры запроса: " + ТелоЗапроса);
                ЗаписатьВФайл(ИмяФайлаЛога, "Период: " + Формат(ДатаНачала, "ДФ=dd.MM.yyyy") + " - " + Формат(ДатаОкончания, "ДФ=dd.MM.yyyy"));
                
            Исключение
                ЗаписатьВФайл(ИмяФайлаЛога, "Ошибка парсинга параметров: " + ОписаниеОшибки());
                // Используем параметры по умолчанию
            КонецПопытки;
        КонецЕсли;
        
        // Получение накладных с учетом периода
        МассивНакладных = ПолучитьНакладныеСФільтромПо202(ДатаНачала, ДатаОкончания);
        
        ЗаписатьВФайл(ИмяФайлаЛога, "Найдено накладных: " + Строка(МассивНакладных.Количество()));
        
        // JSON
        ЗаписьJSON = Новый ЗаписьJSON;
        ЗаписьJSON.УстановитьСтроку();
        ЗаписатьJSON(ЗаписьJSON, МассивНакладных);
        СтрокаJSON = ЗаписьJSON.Закрыть();
        
        // Ответ
        Ответ = Новый HTTPСервисОтвет(200);
        Ответ.УстановитьТелоИзСтроки(СтрокаJSON, КодировкаТекста.UTF8);
        Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
        
        ЗаписатьВФайл(ИмяФайлаЛога, "SUCCESS: Отправлено накладных: " + Строка(МассивНакладных.Количество()));
        
        Возврат Ответ;
        
    Исключение
        ЗаписатьВФайл(ИмяФайлаЛога, "ERROR в invoices_POST: " + ОписаниеОшибки());
        
        ОтветОшибка = Новый HTTPСервисОтвет(500);
        ОтветОшибка.УстановитьТелоИзСтроки("Error: " + ОписаниеОшибки(), КодировкаТекста.UTF8);
        Возврат ОтветОшибка;
        
    КонецПопытки;
    
КонецФункции

// Обновленная функция для получения накладных с параметрами даты
Функция ПолучитьНакладныеСФільтромПо202(ДатаНачала, ДатаОкончания) Экспорт
    
    МассивНакладных = Новый Массив;
    
    Запрос = Новый Запрос;
    Запрос.Текст = "
        |ВЫБРАТЬ РАЗЛИЧНЫЕ
        |    ПТУ.Ссылка КАК СсылкаДокумента,
        |    ПТУ.Номер КАК НомерДокумента,
        |    ПТУ.Дата КАК ДатаДокумента,
        |    ПТУ.Контрагент КАК Контрагент,
        |    ПТУ.Контрагент.Наименование КАК НаименованиеКонтрагента,
        |    ПТУ.Контрагент.ИНН КАК ИННКонтрагента,
        |    ПТУ.СуммаДокумента КАК СуммаДокумента,
        |    ПТУ.ВалютаДокумента.Код КАК КодВалюты,
        |    ПТУ.Проведен КАК Проведен
        |ИЗ
        |    Документ.ПоступлениеТоваровУслуг КАК ПТУ
        |        ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПоступлениеТоваровУслуг.Товары КАК Товары202
        |        ПО ПТУ.Ссылка = Товары202.Ссылка
        |        И Товары202.СчетУчетаБУ.Код = ""202""
        |ГДЕ
        |    ПТУ.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
        |    И ПТУ.ПометкаУдаления = ЛОЖЬ
        |    И ПТУ.Проведен = ИСТИНА
        |УПОРЯДОЧИТЬ ПО
        |    ПТУ.Дата УБЫВ";
    
    Запрос.УстановитьПараметр("ДатаНачала", ДатаНачала);
    Запрос.УстановитьПараметр("ДатаОкончания", ДатаОкончания);
    
    РезультатЗапроса = Запрос.Выполнить();
    Выборка = РезультатЗапроса.Выбрать();
    
    Пока Выборка.Следующий() Цикл
        
        СтруктураНакладной = Новый Структура;
        СтруктураНакладной.Вставить("id", Строка(Выборка.СсылкаДокумента.УникальныйИдентификатор()));
        СтруктураНакладной.Вставить("number", Выборка.НомерДокумента);
        СтруктураНакладной.Вставить("date", Формат(Выборка.ДатаДокумента, "ДФ=yyyy-MM-dd"));
        СтруктураНакладной.Вставить("supplierName", Выборка.НаименованиеКонтрагента);
        СтруктураНакладной.Вставить("supplierTaxCode", Выборка.ИННКонтрагента);
        СтруктураНакладной.Вставить("amount", Выборка.СуммаДокумента);
        СтруктураНакладной.Вставить("currency", Выборка.КодВалюты);
        СтруктураНакладной.Вставить("status", ?(Выборка.Проведен, "posted", "draft"));
        СтруктураНакладной.Вставить("hasAccount202", Истина);
        
        // Получаем только позиции с рахунку учета 202
        Позиции = ПолучитьПозицииТолькоПо202(Выборка.СсылкаДокумента);
        СтруктураНакладной.Вставить("items", Позиции);
        
        МассивНакладных.Добавить(СтруктураНакладной);
        
    КонецЦикла;
    
    Возврат МассивНакладных;
    
КонецФункции
```

## Аналогичное обновление для outgoing-invoices

```1c
// Ресурс: /outgoing-invoices
// Метод: POST
// Шаблон URL: /outgoing-invoices

Функция outgoing_invoices_POST(Запрос)
    
    ИмяФайлаЛога = "c:\temp\erp_outgoing_debug.txt";  
    
    Попытка
        // Парсинг параметров из тела запроса
        ТелоЗапроса = Запрос.ПолучитьТелоКакСтроку();
        
        // Параметры по умолчанию (последние 3 месяца)
        ДатаНачала = НачалоМесяца(ТекущаяДата() - 86400 * 90);
        ДатаОкончания = КонецДня(ТекущаяДата());
        
        // Обработка параметров периода (аналогично входящим накладным)
        Если НЕ ПустаяСтрока(ТелоЗапроса) Тогда
            Попытка
                ЧтениеJSON = Новый ЧтениеJSON;
                ЧтениеJSON.УстановитьСтроку(ТелоЗапроса);
                ПараметрыЗапроса = ПрочитатьJSON(ЧтениеJSON);
                ЧтениеJSON.Закрыть();
                
                // Обработка параметров периода (тот же код что и выше)
                Если ПараметрыЗапроса.Свойство("period") Тогда
                    Период = ПараметрыЗапроса.period;
                    
                    Если Период = "today" Тогда
                        ДатаНачала = НачалоДня(ТекущаяДата());
                        ДатаОкончания = КонецДня(ТекущаяДата());
                    ИначеЕсли Период = "last3days" Тогда
                        ДатаНачала = НачалоДня(ТекущаяДата() - 2*86400);
                        ДатаОкончания = КонецДня(ТекущаяДата());
                    ИначеЕсли Период = "last5days" Тогда
                        ДатаНачала = НачалоДня(ТекущаяДата() - 4*86400);
                        ДатаОкончания = КонецДня(ТекущаяДата());
                    ИначеЕсли Период = "last7days" Тогда
                        ДатаНачала = НачалоДня(ТекущаяДата() - 6*86400);
                        ДатаОкончания = КонецДня(ТекущаяДата());
                    ИначеЕсли Период = "last30days" Тогда
                        ДатаНачала = НачалоДня(ТекущаяДата() - 29*86400);
                        ДатаОкончания = КонецДня(ТекущаяДата());
                    ИначеЕсли Период = "last90days" Тогда
                        ДатаНачала = НачалоДня(ТекущаяДата() - 89*86400);
                        ДатаОкончания = КонецДня(ТекущаяДата());
                    КонецЕсли;
                КонецЕсли;
                
                // Обработка пользовательских дат
                Если ПараметрыЗапроса.Свойство("dateFrom") И НЕ ПустаяСтрока(ПараметрыЗапроса.dateFrom) Тогда
                    ДатаНачала = Дата(ПараметрыЗапроса.dateFrom);
                КонецЕсли;
                
                Если ПараметрыЗапроса.Свойство("dateTo") И НЕ ПустаяСтрока(ПараметрыЗапроса.dateTo) Тогда
                    ДатаОкончания = КонецДня(Дата(ПараметрыЗапроса.dateTo));
                КонецЕсли;
                
                ЗаписатьВФайл(ИмяФайлаЛога, "Параметры запроса: " + ТелоЗапроса);
                ЗаписатьВФайл(ИмяФайлаЛога, "Период: " + Формат(ДатаНачала, "ДФ=dd.MM.yyyy") + " - " + Формат(ДатаОкончания, "ДФ=dd.MM.yyyy"));
                
            Исключение
                ЗаписатьВФайл(ИмяФайлаЛога, "Ошибка парсинга параметров: " + ОписаниеОшибки());
            КонецПопытки;
        КонецЕсли;
        
        // Получение вихідних рахунків с учетом периода
        МассивСчетов = ПолучитьВихідніРахунки(ДатаНачала, ДатаОкончания);
        
        ЗаписатьВФайл(ИмяФайлаЛога, "Найдено рахунків: " + Строка(МассивСчетов.Количество()));
        
        // JSON
        ЗаписьJSON = Новый ЗаписьJSON;
        ЗаписьJSON.УстановитьСтроку();
        ЗаписатьJSON(ЗаписьJSON, МассивСчетов);
        СтрокаJSON = ЗаписьJSON.Закрыть();
        
        // Ответ
        Ответ = Новый HTTPСервисОтвет(200);
        Ответ.УстановитьТелоИзСтроки(СтрокаJSON, КодировкаТекста.UTF8);
        Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
        
        Возврат Ответ;
        
    Исключение
        ЗаписатьВФайл(ИмяФайлаЛога, "ERROR в outgoing_invoices_POST: " + ОписаниеОшибки());
        
        ОтветОшибка = Новый HTTPСервисОтвет(500);
        ОтветОшибка.УстановитьТелоИзСтроки("Error: " + ОписаниеОшибки(), КодировкаТекста.UTF8);
        Возврат ОтветОшибка;
        
    КонецПопытки;
    
КонецФункции

// Обновленная функция для получения вихідних рахунків с параметрами даты
Функция ПолучитьВихідніРахунки(ДатаНачала, ДатаОкончания) Экспорт
    
    МассивСчетов = Новый Массив;
    
    Запрос = Новый Запрос;
    Запрос.Текст = "
        |ВЫБРАТЬ
        |    Счет.Ссылка КАК СсылкаДокумента,
        |    Счет.Номер КАК НомерДокумента,
        |    Счет.Дата КАК ДатаДокумента,
        |    Счет.Контрагент.Наименование КАК КлиентНазвание,
        |    Счет.Контрагент.ИНН КАК КлиентИНН,
        |    Счет.СуммаДокумента КАК СуммаДокумента,
        |    Счет.ВалютаДокумента.Код КАК КодВалюты,
        |    Счет.Проведен КАК Проведен
        |ИЗ
        |    Документ.СчетНаОплатуПокупателю КАК Счет
        |ГДЕ
        |    Счет.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
        |    И Счет.ПометкаУдаления = ЛОЖЬ
        |    И Счет.Проведен = ИСТИНА
        |УПОРЯДОЧИТЬ ПО
        |    Счет.Дата УБЫВ";
    
    Запрос.УстановитьПараметр("ДатаНачала", ДатаНачала);
    Запрос.УстановитьПараметр("ДатаОкончания", ДатаОкончания);
    
    РезультатЗапроса = Запрос.Выполнить();
    Выборка = РезультатЗапроса.Выбрать();
    
    Пока Выборка.Следующий() Цикл
        
        СтруктураСчета = Новый Структура;
        СтруктураСчета.Вставить("id", Строка(Выборка.СсылкаДокумента.УникальныйИдентификатор()));
        СтруктураСчета.Вставить("number", Выборка.НомерДокумента);
        СтруктураСчета.Вставить("date", Формат(Выборка.ДатаДокумента, "ДФ=yyyy-MM-dd"));
        СтруктураСчета.Вставить("clientName", Выборка.КлиентНазвание);
        СтруктураСчета.Вставить("clientTaxCode", Выборка.КлиентИНН);
        СтруктураСчета.Вставить("total", Выборка.СуммаДокумента);
        СтруктураСчета.Вставить("currency", Выборка.КодВалюты);
        СтруктураСчета.Вставить("status", ?(Выборка.Проведен, "posted", "draft"));
        
        // Получаем позиции счета
        Позиции = ПолучитьПозицииСчета(Выборка.СсылкаДокумента);
        СтруктураСчета.Вставить("positions", Позиции);
        
        МассивСчетов.Добавить(СтруктураСчета);
        
    КонецЦикла;
    
    Возврат МассивСчетов;
    
КонецФункции
```

## Что нужно изменить в 1C

1. **Обновить функцию `invoices_POST`** - добавить парсинг параметров даты из тела запроса
2. **Обновить функцию `ПолучитьНакладныеСФільтромПо202`** - добавить параметры ДатаНачала и ДатаОкончания
3. **Обновить функцию `outgoing_invoices_POST`** - добавить аналогичный парсинг параметров
4. **Обновить функцию `ПолучитьВихідніРахунки`** - добавить параметры даты

## Поддерживаемые параметры

- `period`: "today", "last3days", "last5days", "last7days", "last30days", "last90days"
- `dateFrom`: дата в формате "yyyy-MM-dd"
- `dateTo`: дата в формате "yyyy-MM-dd"

## Пример запроса от ERP

```json
{
  "period": "last5days"
}
```

или

```json
{
  "dateFrom": "2025-07-01",
  "dateTo": "2025-07-17"
}
```

Пользовательские даты имеют приоритет над предустановленными периодами.
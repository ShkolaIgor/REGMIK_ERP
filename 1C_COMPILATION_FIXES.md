# 1С Виправлення Помилок Компіляції WebhookIntegration

## Огляд помилок

Ваші помилки:
1. **Дублікат функції**: `ЗаписатьJSON` визначена двічі
2. **Неправильний виклик**: Виклик процедури як функції

## ✅ ВИПРАВЛЕНИЙ КОД

Використовуйте цей виправлений код для модуля `WebhookIntegration`:

```1c
// ==============================================
// МОДУЛЬ: WebhookIntegration (Загальний модуль)
// ==============================================

// Функція для відправки webhook'а
Функция ОтправитьWebhook(URL, Данные)
    Попытка
        HTTPСоединение = Новый HTTPСоединение("your-erp-domain.com", 443,,,, 30, Новый ЗащищенноеСоединениеOpenSSL);
        Запрос = Новый HTTPЗапрос(URL);
        Запрос.УстановитьТелоИзСтроки(Данные, КодировкаТекста.UTF8);
        Запрос.Заголовки.Вставить("Content-Type", "application/json");
        Запрос.Заголовки.Вставить("User-Agent", "1C-Enterprise/8.3");
        
        Ответ = HTTPСоединение.ОтправитьДляОбработки(Запрос);
        
        Если Ответ.КодСостояния = 200 Тогда
            Возврат Истина;
        Иначе
            ЗаписатьЛог("Ошибка webhook: " + Ответ.КодСостояния + " - " + Ответ.ПолучитьТелоКакСтроку());
            Возврат Ложь;
        КонецЕсли;
    Исключение
        ЗаписатьЛог("Исключение webhook: " + ОписаниеОшибки());
        Возврат Ложь;
    КонецПопытки;
КонецФункции

// Функция логирования
Функция ЗаписатьЛог(Сообщение)
    Попытка
        Файл = Новый ЗаписьТекста("c:\temp\webhook_log.txt", КодировкаТекста.UTF8,, Истина);
        Файл.ЗаписатьСтроку(ТекущаяДата() + ": " + Сообщение);
        Файл.Закрыть();
    Исключение
        // Игнорируем ошибки логирования
    КонецПопытки;
КонецФункции

// ✅ ВИПРАВЛЕНО: Функция для создания JSON (без дублирования)
Функция СоздатьJSON(Данные)
    Попытка
        // Для 1С 8.3.15 и новее
        ЗаписьJSON = Новый ЗаписьJSON;
        ЗаписьJSON.УстановитьСтроку();
        ЗаписатьJSON(ЗаписьJSON, Данные);
        Возврат ЗаписьJSON.Закрыть();
    Исключение
        // Для более старых версий 1С
        Попытка
            Возврат ОбщегоНазначения.ОбъектВСтрокуJSON(Данные);
        Исключение
            ЗаписатьЛог("Ошибка создания JSON: " + ОписаниеОшибки());
            Возврат "";
        КонецПопытки;
    КонецПопытки;
КонецФункции

// Функция для отправки данных клиента
Функция ОтправитьДанныеКлиента(Контрагент, Действие)
    Данные = Новый Структура;
    Данные.Вставить("action", Действие);
    
    ДанныеКлиента = Новый Структура;
    ДанныеКлиента.Вставить("Код", Контрагент.Код);
    ДанныеКлиента.Вставить("Наименование", Контрагент.Наименование);
    ДанныеКлиента.Вставить("ИНН", Контрагент.ИНН);
    ДанныеКлиента.Вставить("Телефон", Контрагент.Телефон);
    ДанныеКлиента.Вставить("Email", Контрагент.Email);
    ДанныеКлиента.Вставить("Адрес", Контрагент.ЮридическийАдрес);
    
    Данные.Вставить("clientData", ДанныеКлиента);
    
    // ✅ ВИПРАВЛЕНО: Используем СоздатьJSON вместо ЗаписатьJSON
    JSONСтрока = "";
    Попытка
        JSONСтрока = СоздатьJSON(Данные);
    Исключение
        ЗаписатьЛог("Ошибка JSON клиента: " + ОписаниеОшибки());
        Возврат Ложь;
    КонецПопытки;
    
    Если ПустаяСтрока(JSONСтрока) Тогда
        ЗаписатьЛог("Пустой JSON для клиента");
        Возврат Ложь;
    КонецЕсли;
    
    Возврат ОтправитьWebhook("/api/webhook/1c/clients", JSONСтрока);
КонецФункции

// Функция для отправки данных накладной
Функция ОтправитьДанныеНакладной(Накладная, Действие)
    Данные = Новый Структура;
    Данные.Вставить("action", Действие);
    
    ДанныеНакладной = Новый Структура;
    ДанныеНакладной.Вставить("СсылкаДокумента", Строка(Накладная.Ссылка));
    ДанныеНакладной.Вставить("НомерДокумента", Накладная.Номер);
    ДанныеНакладной.Вставить("ДатаДокумента", Накладная.Дата);
    ДанныеНакладной.Вставить("Постачальник", Накладная.Контрагент.Наименование);
    ДанныеНакладной.Вставить("СуммаДокумента", Накладная.СуммаДокумента);
    ДанныеНакладной.Вставить("КодВалюты", Накладная.ВалютаДокумента.Код);
    
    // Позиции товаров
    Позиции = Новый Массив;
    Для Каждого СтрокаТовара Из Накладная.Товары Цикл
        Позиция = Новый Структура;
        Позиция.Вставить("НаименованиеТовара", СтрокаТовара.Номенклатура.Наименование);
        Позиция.Вставить("КодТовара", СтрокаТовара.Номенклатура.Код);
        Позиция.Вставить("Количество", СтрокаТовара.Количество);
        Позиция.Вставить("Цена", СтрокаТовара.Цена);
        Позиция.Вставить("Сумма", СтрокаТовара.Сумма);
        Позиции.Добавить(Позиция);
    КонецЦикла;
    
    ДанныеНакладной.Вставить("positions", Позиции);
    Данные.Вставить("invoiceData", ДанныеНакладной);
    
    // ✅ ВИПРАВЛЕНО: Используем СоздатьJSON вместо ЗаписатьJSON
    JSONСтрока = "";
    Попытка
        JSONСтрока = СоздатьJSON(Данные);
    Исключение
        ЗаписатьЛог("Ошибка JSON накладной: " + ОписаниеОшибки());
        Возврат Ложь;
    КонецПопытки;
    
    Если ПустаяСтрока(JSONСтрока) Тогда
        ЗаписатьЛог("Пустой JSON для накладной");
        Возврат Ложь;
    КонецЕсли;
    
    Возврат ОтправитьWebhook("/api/webhook/1c/invoices", JSONСтрока);
КонецФункции

// Функция для отправки данных вихідного рахунку
Функция ОтправитьДанныеВихідногоРахунку(Рахунок, Действие)
    Данные = Новый Структура;
    Данные.Вставить("action", Действие);
    
    ДанныеРахунку = Новый Структура;
    ДанныеРахунку.Вставить("СсылкаДокумента", Строка(Рахунок.Ссылка));
    ДанныеРахунку.Вставить("НомерДокумента", Рахунок.Номер);
    ДанныеРахунку.Вставить("ДатаДокумента", Рахунок.Дата);
    ДанныеРахунку.Вставить("Клиент", Рахунок.Контрагент.Наименование);
    ДанныеРахунку.Вставить("СуммаДокумента", Рахунок.СуммаДокумента);
    ДанныеРахунку.Вставить("КодВалюты", Рахунок.ВалютаДокумента.Код);
    
    // Позиции товаров
    Позиции = Новый Массив;
    Для Каждого СтрокаТовара Из Рахунок.Товары Цикл
        Позиция = Новый Структура;
        Позиция.Вставить("НаименованиеТовара", СтрокаТовара.Номенклатура.Наименование);
        Позиция.Вставить("КодТовара", СтрокаТовара.Номенклатура.Код);
        Позиция.Вставить("Количество", СтрокаТовара.Количество);
        Позиция.Вставить("Цена", СтрокаТовара.Цена);
        Позиция.Вставить("Сумма", СтрокаТовара.Сумма);
        Позиции.Добавить(Позиция);
    КонецЦикла;
    
    ДанныеРахунку.Вставить("positions", Позиции);
    Данные.Вставить("invoiceData", ДанныеРахунку);
    
    // ✅ ВИПРАВЛЕНО: Используем СоздатьJSON вместо ЗаписатьJSON
    JSONСтрока = "";
    Попытка
        JSONСтрока = СоздатьJSON(Данные);
    Исключение
        ЗаписатьЛог("Ошибка JSON вихідного рахунку: " + ОписаниеОшибки());
        Возврат Ложь;
    КонецПопытки;
    
    Если ПустаяСтрока(JSONСтрока) Тогда
        ЗаписатьЛог("Пустой JSON для вихідного рахунку");
        Возврат Ложь;
    КонецЕсли;
    
    Возврат ОтправитьWebhook("/api/webhook/1c/outgoing-invoices", JSONСтрока);
КонецФункции
```

## 🔧 Кроки виправлення

### 1. Видаліть старий модуль
1. Відкрийте 1С Конфігуратор
2. Знайдіть модуль `WebhookIntegration`
3. Видаліть його повністю

### 2. Створіть новий модуль
1. Правий клік на "Общие модули"
2. "Создать" → "Общий модуль"
3. Назва: `WebhookIntegration`
4. Установите флажки:
   - ✅ Сервер
   - ✅ Внешнее соединение
   - ✅ Безопасный режим

### 3. Вставте виправлений код
Скопіюйте повний код з цього файлу в новий модуль.

### 4. Замініть URL
Замініть `your-erp-domain.com` на реальний домен вашої ERP системи.

### 5. Перевірте компіляцію
1. Ctrl+F7 для перевірки синтаксису
2. Переконайтеся що немає помилок
3. Збережіть модуль

## ✅ Що виправлено

1. **Дублікат функції**: Замінено `ЗаписатьJSON` на `СоздатьJSON`
2. **Виклики функції**: Всі виклики тепер використовують `СоздатьJSON(Данные)`
3. **Перевірка JSON**: Додана перевірка на пустий JSON
4. **Перетворення посилань**: Додано `Строка()` для посилань документів
5. **Обробка помилок**: Покращена обробка помилок JSON

## 📝 Додаткові перевірки

Після створення модуля переконайтеся:
- ✅ Модуль компілюється без помилок
- ✅ Всі функції мають різні назви  
- ✅ Логування працює (перевірте c:\temp\webhook_log.txt)
- ✅ HTTP-з'єднання доступне

## 🚀 Наступні кроки

Після успішної компіляції модуля додайте обробники подій у документи згідно з основною документацією.
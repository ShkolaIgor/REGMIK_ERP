# Діагностика з'єднання з 1С - ПОВНЕ РІШЕННЯ

## Проблема
- ERP система отримує fallback дані замість реальних з 1С
- Сервер повертає 404 помилку для endpoint /hs/erp/invoices
- Потрібно налаштувати HTTP-сервіс в 1С правильно

## Діагностика проведена:
```bash
# Спробували GET запит - отримали 404
curl -X GET "https://baf.regmik.ua/hs/erp/invoices"

# Спробували POST запит з авторизацією - отримали 404
curl -X POST "https://baf.regmik.ua/hs/erp/invoices" \
  -H "Authorization: Basic $(echo -n 'Школа І.М.:1' | base64)" \
  -H "Content-Type: application/json" -d '{}'
```

## РІШЕННЯ: Налаштування HTTP-сервіса в 1С

### 1. Створіть HTTP-сервіс "erp" в 1С
1. Відкрийте Конфігуратор 1С
2. Конфігурация → HTTP-сервисы → Новый
3. Назва: `erp`
4. URL шаблон: `/hs/erp`
5. Корневой URL: `/hs/erp`

### 2. Створіть методи HTTP-сервіса
Додайте метод `invoices` з кодом:

```1c
Функция invoicesPOST(Запрос)
    // Ваш існуючий код функції ПолучитьТоварныеНакладные()
    Попытка
        МассивНакладных = ПолучитьТоварныеНакладные();
        
        // Конвертуємо в JSON
        ЗаписьJSON = Новый ЗаписьJSON;
        СтрокаJSON = "";
        ЗаписьJSON.УстановитьСтроку(СтрокаJSON);
        ЗаписатьJSON(ЗаписьJSON, МассивНакладных);
        РезультатJSON = ЗаписьJSON.Закрыть();
        
        // Створюємо відповідь
        Ответ = Новый HTTPСервисОтвет(200);
        Ответ.УстановитьТелоИзСтроки(РезультатJSON, "application/json", "utf-8");
        Возврат Ответ;
        
    Исключение
        // Логування помилки
        ТекстОшибки = "Помилка HTTP-сервіса: " + ОписаниеОшибки();
        ЗаписатьВФайл("c:\temp\erp_http_error.txt", ТекстОшибки);
        
        // Повертаємо помилку
        Ответ = Новый HTTPСервисОтвет(500);
        Ответ.УстановитьТелоИзСтроки(ТекстОшибки, "text/plain", "utf-8");
        Возврат Ответ;
    КонецПопытки;
КонецФункции

// Ваша існуюча функція (з вашого коду)
Функция ПолучитьТоварныеНакладные()
    ИмяФайлаЛога = "c:\temp\erp_icoming_debug.txt";  

    Попытка
        Запрос = Новый Запрос;
        Запрос.Текст = "
        |ВЫБРАТЬ
        |    Док.Ссылка КАК СсылкаДокумента,
        |    Док.Номер КАК НомерДокумента,
        |    Док.Дата КАК ДатаДокумента,
        |    ВЫБОР
        |        КОГДА Контрагенты.Наименование <> """"
        |        ТОГДА Контрагенты.Наименование
        |        ИНАЧЕ ""Постачальник не вказано""
        |    КОНЕЦ КАК Постачальник,
        |    Док.СуммаДокумента КАК СуммаДокумента,
        |    Валюты.Код КАК КодВалюты
        |ИЗ
        |    Документ.ПоступлениеТоваровУслуг КАК Док
        |    ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагенты
        |        ПО Док.Контрагент = Контрагенты.Ссылка
        |    ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Валюты КАК Валюты
        |        ПО Док.ВалютаДокумента = Валюты.Ссылка
        |ГДЕ
        |    Док.Дата >= &ДатаНачала
        |    И Док.Проведен = ИСТИНА
        |    И ЕСТЬNULL(Док.ПометкаУдаления, ЛОЖЬ) = ЛОЖЬ
        |    // ФІЛЬТР: тільки документи з товарними позиціями
        |    И Док.Ссылка В (
        |        ВЫБРАТЬ РАЗЛИЧНЫЕ
        |            ТабличнаяЧасть.Ссылка
        |        ИЗ
        |            Документ.ПоступлениеТоваровУслуг.Товары КАК ТабличнаяЧасть
        |        ГДЕ
        |            ТабличнаяЧасть.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар)
        |    )
        |УПОРЯДОЧИТЬ ПО
        |    Док.Дата УБЫВ
        |";
        
        // Останні 3 місяці для оптимізації
        ДатаНачала = ТекущаяДата() - 90*24*3600;
        Запрос.УстановитьПараметр("ДатаНачала", ДатаНачала);
        
        Результат = Запрос.Выполнить();
        Выборка = Результат.Выбрать();
        
        МассивНакладных = Новый Массив;
        
        Пока Выборка.Следующий() Цикл
            // Отримуємо тільки товарні позиції
            ТоварныеПозиции = ПолучитьТоварныеПозицииНакладной(Выборка.СсылкаДокумента);
            
            // Пропускаємо якщо немає товарних позицій
            Если ТоварныеПозиции.Количество() = 0 Тогда
                Продолжить;
            КонецЕсли;
            
            Накладная = Новый Структура;
            Накладная.Вставить("НомерДокумента", Выборка.НомерДокумента);
            Накладная.Вставить("ДатаДокумента", Формат(Выборка.ДатаДокумента, "ДФ=yyyy-MM-dd"));
            Накладная.Вставить("Постачальник", Выборка.Постачальник);
            Накладная.Вставить("СуммаДокумента", Выборка.СуммаДокумента);
            Накладная.Вставить("КодВалюты", Выборка.КодВалюты);
            Накладная.Вставить("Позиції", ТоварныеПозиции);
            Накладная.Вставить("КількістьТоварів", ТоварныеПозиции.Количество());
            
            МассивНакладных.Добавить(Накладная);
        КонецЦикла;
        
        Возврат МассивНакладных;
        
    Исключение
        ЗаписатьВФайл(ИмяФайлаЛога, "ERROR накладных: " + ОписаниеОшибки());
        Возврат Новый Массив;
    КонецПопытки;
КонецФункции

Функция ПолучитьТоварныеПозицииНакладной(СсылкаДокумента)
    Попытка
        Запрос = Новый Запрос;
        Запрос.Текст = "
        |ВЫБРАТЬ
        |    ТабличнаяЧасть.Номенклатура.Наименование КАК НаименованиеТовара,
        |    ТабличнаяЧасть.Количество КАК Количество,
        |    ТабличнаяЧасть.Цена КАК Цена,
        |    ТабличнаяЧасть.Сумма КАК Сумма,
        |    ТабличнаяЧасть.Номенклатура.Код КАК КодТовара,
        |    ТабличнаяЧасть.НомерСтроки КАК НомерСтроки
        |ИЗ
        |    Документ.ПоступлениеТоваровУслуг.Товары КАК ТабличнаяЧасть
        |ГДЕ
        |    ТабличнаяЧасть.Ссылка = &СсылкаДокумента
        |    // ТІЛЬКИ ТОВАРИ (не послуги)
        |    И ТабличнаяЧасть.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар)
        |УПОРЯДОЧИТЬ ПО
        |    ТабличнаяЧасть.НомерСтроки
        |";
        
        Запрос.УстановитьПараметр("СсылкаДокумента", СсылкаДокумента);
        Результат = Запрос.Выполнить();
        Выборка = Результат.Выбрать();
        
        МассивПозиций = Новый Массив;
        
        Пока Выборка.Следующий() Цикл
            Позиция = Новый Структура;
            Позиция.Вставить("НаименованиеТовара", Выборка.НаименованиеТовара);
            Позиция.Вставить("КодТовара", Выборка.КодТовара);
            Позиция.Вставить("Количество", Выборка.Количество);
            Позиция.Вставить("Цена", Выборка.Цена);
            Позиция.Вставить("Сумма", Выборка.Сумма);
            Позиция.Вставить("НомерСтроки", Выборка.НомерСтроки);
            
            МассивПозиций.Добавить(Позиция);
        КонецЦикла;
        
        Возврат МассивПозиций;
        
    Исключение
        Возврат Новый Массив;
    КонецПопытки;
КонецФункции
```

### 3. Налаштування аутентифікації
1. В HTTP-сервісі увімкніть Basic-аутентифікацію
2. Користувач: `Школа І.М.`
3. Пароль: `1`

### 4. Публікація на веб-сервері
1. Перейдіть в Администрирование → Публикация на веб-сервере
2. Опублікуйте HTTP-сервіс "erp"
3. Перевірте, що сервіс доступний за адресою: `https://baf.regmik.ua/hs/erp/invoices`

### 5. Тестування
Після налаштування, протестуйте в браузері:
```
https://baf.regmik.ua/hs/erp/invoices
```

## СТАТУС
❌ HTTP-сервіс "erp" не налаштовано в 1С
❌ Endpoint /hs/erp/invoices повертає 404
✅ ERP система готова отримувати реальні дані
✅ Код обробки відповідає вашій структурі 1С

## НАСТУПНІ КРОКИ
1. Налаштуйте HTTP-сервіс в 1С згідно з інструкцією вище
2. Після налаштування система автоматично почне отримувати реальні дані замість fallback
3. Перевірте логи в c:\temp\erp_http_error.txt при проблемах
# Налаштування інтеграції з 1С

## Огляд

Система REGMIK ERP підтримує інтеграцію з системами 1С для автоматичного імпорту накладних постачальників. Інтеграція дозволяє переносити дані про приходні накладні з 1С в ERP систему з автоматичним створенням постачальників та компонентів.

## Вимоги до 1С

### Підтримувані версії
- 1С:Підприємство 8.3
- 1С:Бухгалтерія 3.0
- 1С:Управління торгівлею 11
- 1С:ERP Управління підприємством 2

### Необхідні компоненти
1. **HTTP-сервіси** - для обміну даними через REST API
2. **Веб-сервіси** - для публікації даних
3. **Регламентні завдання** - для автоматичної синхронізації

## Налаштування в 1С

### 1. Створення HTTP-сервісу

#### Крок 1: Створення HTTP-сервісу
1. Відкрийте конфігуратор 1С
2. Перейдіть в розділ "Конфігурація" → "HTTP-сервіси"
3. Створіть новий HTTP-сервіс з ім'ям `ERPIntegration`
4. Встановіть кореневий URL: `/erp/v1`

#### Крок 2: Створення ресурсу для накладних
```1c
// Ресурс: /invoices
// Метод: GET
// Шаблон URL: /invoices

Функция ПолучитьНакладные(Запрос)
    
    Відбір = Новий Структура;
    
    // Фільтр по даті (опціонально)
    Если Запрос.ПараметрыURL.Свойство("dateFrom") Тогда
        Відбір.Вставить("ДатаОт", XMLЗначение(Тип("Дата"), Запрос.ПараметрыURL["dateFrom"]));
    КінецьЯкщо;
    
    Если Запрос.ПараметрыURL.Свойство("dateTo") Тогда
        Відбір.Вставить("ДатаДо", XMLЗначение(Тип("Дата"), Запрос.ПараметрыURL["dateTo"]));
    КінецьЯкщо;
    
    // Отримання накладних
    Накладні = ПолучитиСписокНакладних(Відбір);
    
    Відповідь = Новий HTTPСервісОтвет(200);
    Відповідь.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
    Відповідь.УстановитьТелоИзСтроки(JSONСтрока(Накладні), КодировкаТекста.UTF8);
    
    Возврат Відповідь;
    
КінецьФункції

Функция ПолучитиСписокНакладних(Відбір)
    
    Запрос = Новий Запрос;
    Запрос.Текст = "
        |ВЫБРАТЬ
        |    ПоступленияТоваровУслуг.Ссылка КАК Ref,
        |    ПоступленияТоваровУслуг.Номер КАК Number,
        |    ПоступленияТоваровУслуг.Дата КАК Date,
        |    ПоступленияТоваровУслуг.Контрагент КАК Supplier,
        |    ПоступленияТоваровУслуг.СуммаДокумента КАК Amount,
        |    ПоступленияТоваровУслуг.Валюта КАК Currency,
        |    ПоступленияТоваровУслуг.Комментарий КАК Comment
        |ИЗ
        |    Документ.ПоступленияТоваровУслуг КАК ПоступленияТоваровУслуг
        |ГДЕ
        |    ПоступленияТоваровУслуг.Проведен = ИСТИНА
        |    И ПоступленияТоваровУслуг.ПометкаУдаления = ЛОЖЬ";
    
    Если Відбір.Свойство("ДатаОт") Тогда
        Запрос.Текст = Запрос.Текст + "
            |    И ПоступленияТоваровУслуг.Дата >= &ДатаОт";
        Запрос.УстановитьПараметр("ДатаОт", Відбір.ДатаОт);
    КінецьЯкщо;
    
    Если Відбір.Свойство("ДатаДо") Тогда
        Запрос.Текст = Запрос.Текст + "
            |    И ПоступленияТоваровУслуг.Дата <= &ДатаДо";
        Запрос.УстановитьПараметр("ДатаДо", Відбір.ДатаДо);
    КінецьЯкщо;
    
    Запрос.Текст = Запрос.Текст + "
        |УПОРЯДОЧИТЬ ПО
        |    ПоступленияТоваровУслуг.Дата УБЫВ";
    
    Результат = Запрос.Выполнить();
    Выборка = Результат.Выбрать();
    
    МассивНакладних = Новий Массив;
    
    Пока Выборка.Следующий() Цикл
        
        СтруктураНакладної = Новий Структура;
        СтруктураНакладної.Вставить("id", Строка(Выборка.Ref.УникальныйИдентификатор()));
        СтруктураНакладної.Вставить("number", Выборка.Number);
        СтруктураНакладної.Вставить("date", XMLСтрока(Выборка.Date));
        СтруктураНакладної.Вставить("supplier", Строка(Выборка.Supplier));
        СтруктураНакладної.Вставить("amount", Выборка.Amount);
        СтруктураНакладної.Вставить("currency", Строка(Выборка.Currency));
        СтруктураНакладної.Вставить("comment", Выборка.Comment);
        СтруктураНакладної.Вставить("status", "new");
        
        // Отримання позицій накладної
        Позиції = ПолучитиПозиціїНакладної(Выборка.Ref);
        СтруктураНакладної.Вставить("items", Позиції);
        
        МассивНакладних.Добавить(СтруктураНакладної);
        
    КінецьЦиклу;
    
    Возврат МассивНакладних;
    
КінецьФункції

Функция ПолучитиПозиціїНакладної(СсылкаНакладної)
    
    Запрос = Новий Запрос;
    Запрос.Текст = "
        |ВЫБРАТЬ
        |    ПоступленияТоваровУслугТовары.Номенклатура КАК Product,
        |    ПоступленияТоваровУслугТовары.Количество КАК Quantity,
        |    ПоступленияТоваровУслугТовары.Цена КАК Price,
        |    ПоступленияТоваровУслугТовары.Сумма КАК Total,
        |    ПоступленияТоваровУслугТовары.ЕдиницаИзмерения КАК Unit
        |ИЗ
        |    Документ.ПоступленияТоваровУслуг.Товары КАК ПоступленияТоваровУслугТовары
        |ГДЕ
        |    ПоступленияТоваровУслугТовары.Ссылка = &Ссылка";
    
    Запрос.УстановитьПараметр("Ссылка", СсылкаНакладної);
    
    Результат = Запрос.Выполнить();
    Выборка = Результат.Выбрать();
    
    МассивПозицій = Новий Массив;
    
    Пока Выборка.Следующий() Цикл
        
        СтруктураПозиції = Новий Структура;
        СтруктураПозиції.Вставить("name", Строка(Выборка.Product));
        СтруктураПозиції.Вставить("quantity", Выборка.Quantity);
        СтруктураПозиції.Вставить("price", Выборка.Price);
        СтруктураПозиції.Вставить("total", Выборка.Total);
        СтруктураПозиції.Вставить("unit", Строка(Выборка.Unit));
        
        МассивПозицій.Добавить(СтруктураПозиції);
        
    КінецьЦиклу;
    
    Возврат МассивПозицій;
    
КінецьФункції
```

### 2. Налаштування аутентифікації

#### HTTP Basic Authentication
```1c
// В модулі HTTP-сервісу
Функция ПроверитьАутентификацию(Запрос)
    
    АвторизацияЗаголовок = Запрос.Заголовки.Получить("Authorization");
    
    Если АвторизацияЗаголовок = Неопределено Тогда
        Возврат Ложь;
    КінецьЯкщо;
    
    // Перевірка Basic Auth
    Если НЕ СтрНачинаетсяС(АвторизацияЗаголовок, "Basic ") Тогда
        Возврат Ложь;
    КінецьЯкщо;
    
    Кодовані = Сред(АвторизацияЗаголовок, 7);
    Декодовані = Base64Значение(Кодовані);
    Логін_Пароль = ПолучитьСтрокуИзДвоичныхДанных(Декодовані);
    
    ПозицияДвоеточия = Найти(Логін_Пароль, ":");
    Если ПозицияДвоеточия = 0 Тогда
        Возврат Ложь;
    КінецьЯкщо;
    
    Логін = Лев(Логін_Пароль, ПозицияДвоеточия - 1);
    Пароль = Сред(Логін_Пароль, ПозицияДвоеточия + 1);
    
    // Перевірка логіну та паролю
    Возврат ПроверитьПользователя(Логін, Пароль);
    
КінецьФункції
```

### 3. Публікація HTTP-сервісу

1. Відкрийте "Администрирование" → "Интернет-поддержка пользователей"
2. Виберіть вкладку "Web-сервисы"
3. Натисніть "Настроить публикацию"
4. Виберіть HTTP-сервіс `ERPIntegration`
5. Встановіть URL: `http://your-1c-server:port/base/hs/erp/v1`

## Налаштування в REGMIK ERP

### 1. Створення інтеграції

На сторінці "Інтеграції" натисніть "Додати інтеграцію" та заповніть:

- **Тип системи**: 1С:Підприємство
- **Системне ім'я**: `1c_main`
- **Відображуване ім'я**: `Основна 1С база`
- **URL сервера**: `http://your-1c-server:port/base/hs/erp/v1`
- **Client ID / Логін**: логін користувача 1С
- **Client Secret / Пароль**: пароль користувача 1С
- **Інтервал синхронізації**: 60 хвилин

### 2. Тестування з'єднання

1. Після створення інтеграції натисніть кнопку "Тест"
2. Система перевірить доступність 1С сервера
3. При успішному підключенні з'явиться кнопка "Імпорт накладних з 1C"

### 3. Імпорт накладних

1. Натисніть кнопку "Імпорт накладних з 1C"
2. Система покаже список доступних накладних з 1С
3. Виберіть накладні для імпорту
4. Натисніть "Імпортувати обрані"

## Автоматична синхронізація

### Налаштування регламентного завдання в 1С

```1c
// Процедура регламентного завдання
Процедура СинхронізаціяЗ_ERP() Экспорт
    
    Попытка
        
        // URL ERP системи
        URL_ERP = "https://your-erp-domain.com/api/1c/sync";
        
        // Параметри аутентифікації
        Логін = "erp_user";
        Пароль = "erp_password";
        
        // Отримання нових накладних
        НовіНакладні = ПолучитиНовіНакладніДляЭРП();
        
        Если НовіНакладні.Количество() > 0 Тогда
            
            // Відправка даних в ERP
            HTTPЗапрос = Новий HTTPЗапрос("/api/1c/sync");
            HTTPЗапрос.Заголовки.Вставить("Content-Type", "application/json");
            HTTPЗапрос.Заголовки.Вставить("Authorization", "Basic " + 
                Base64Строка(ПолучитьДвоичныеДанныеИзСтроки(Логін + ":" + Пароль)));
            
            Данні = Новый Структура("invoices", НовіНакладні);
            HTTPЗапрос.УстановитьТелоИзСтроки(JSONСтрока(Данні));
            
            HTTPСоединение = Новый HTTPСоединение("your-erp-domain.com", 443, , , , 30, 
                Новый ЗащищенноеСоединениеOpenSSL());
            
            Ответ = HTTPСоединение.ОтправитьДляОбработки(HTTPЗапрос);
            
            Если Ответ.КодСостояния = 200 Тогда
                ОтметитьНакладніКакСинхронізовані(НовіНакладні);
                ЗаписатьВЖурналРегистрации("Синхронізація з ERP", 
                    УровеньЖурналаРегистрации.Информация,
                    Метаданные.РегламентныеЗадания.СинхронізаціяЗ_ERP,
                    , "Успішно синхронізовано " + НовіНакладні.Количество() + " накладних");
            Иначе
                ВызватьИсключение("HTTP помилка: " + Ответ.КодСостояния);
            КінецьЯкщо;
            
        КінецьЯкщо;
        
    Исключение
        ЗаписатьВЖурналРегистрации("Синхронізація з ERP", 
            УровеньЖурналаРегистрации.Ошибка,
            Метаданные.РегламентныеЗадания.СинхронізаціяЗ_ERP,
            , ОписаниеОшибки());
    КінецьПопытки;
    
КінецьПроцедуры
```

## Безпека

### Рекомендації
1. Використовуйте HTTPS для всіх з'єднань
2. Створіть окремого користувача в 1С тільки для інтеграції
3. Надайте мінімальні права доступу тільки до необхідних даних
4. Регулярно змінюйте паролі
5. Використовуйте сильні паролі (мінімум 12 символів)

### Права доступу в 1С
Користувач для інтеграції повинен мати права:
- Читання довідника "Номенклатура"
- Читання довідника "Контрагенти"
- Читання документа "Поступления товаров и услуг"
- Доступ до HTTP-сервісів

## Моніторинг та логування

### В 1С
- Усі операції логуються в журнал регистрации
- Налаштуйте сповіщення про помилки синхронізації

### В REGMIK ERP
- Перегляд логів синхронізації на сторінці "Інтеграції" → вкладка "Логи"
- Сповіщення про успішний/неуспішний імпорт

## Підтримка

При виникненні проблем:
1. Перевірте доступність 1С сервера
2. Перевірте правильність логіну/паролю
3. Переглядьте логи в обох системах
4. Зверніться до технічної підтримки REGMIK ERP
#!/bin/bash

# Ð¨Ð²Ð¸Ð´ÐºÐµ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ ÑƒÐ¿Ñ€Ð°Ð²Ð»Ñ–Ð½Ð½Ñ Ð²Ð°Ð»ÑŽÑ‚Ð°Ð¼Ð¸ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½
# ÐšÐ¾Ð¿Ñ–ÑŽÑ” Ñ‚Ñ–Ð»ÑŒÐºÐ¸ Ð·Ð¼Ñ–Ð½ÐµÐ½Ñ– Ñ„Ð°Ð¹Ð»Ð¸ Ð±ÐµÐ· Ð¿Ð¾Ð²Ð½Ð¾Ñ— Ð·Ð±Ñ–Ñ€ÐºÐ¸

set -e

echo "ðŸš€ Ð¨Ð²Ð¸Ð´ÐºÐµ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ð¸ ÑƒÐ¿Ñ€Ð°Ð²Ð»Ñ–Ð½Ð½Ñ Ð²Ð°Ð»ÑŽÑ‚Ð°Ð¼Ð¸..."

# ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ñ‰Ð¾ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ”Ñ‚ÑŒÑÑ Ð· Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ñ— Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ñ–Ñ—
if [ ! -f "package.json" ]; then
    echo "âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ°: Ð—Ð°Ð¿ÑƒÑÑ‚Ñ–Ñ‚ÑŒ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð· ÐºÐ¾Ñ€ÐµÐ½ÐµÐ²Ð¾Ñ— Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ñ–Ñ— Ð¿Ñ€Ð¾ÐµÐºÑ‚Ñƒ"
    exit 1
fi

# Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ Ð¿Ð°ÐºÐµÑ‚Ñƒ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ
UPDATE_DIR="currency-quick-update-$(date +%Y%m%d-%H%M%S)"
mkdir -p "$UPDATE_DIR"

# ÐšÐ¾Ð¿Ñ–ÑŽÐ²Ð°Ð½Ð½Ñ Ð·Ð¼Ñ–Ð½ÐµÐ½Ð¸Ñ… Ñ„Ð°Ð¹Ð»Ñ–Ð²
echo "ðŸ“‹ ÐšÐ¾Ð¿Ñ–ÑŽÐ²Ð°Ð½Ð½Ñ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ… Ñ„Ð°Ð¹Ð»Ñ–Ð²..."
cp client/src/pages/currencies.tsx "$UPDATE_DIR/"
cp package.json "$UPDATE_DIR/"

# Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¸ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ñ–Ð¹ Ð´Ð»Ñ Ñ€Ð¾Ð·Ð³Ð¾Ñ€Ñ‚Ð°Ð½Ð½Ñ
mkdir -p "$UPDATE_DIR/client/src/pages"
cp client/src/pages/currencies.tsx "$UPDATE_DIR/client/src/pages/"

# Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ ÑÐºÑ€Ð¸Ð¿Ñ‚Ñƒ Ñ€Ð¾Ð·Ð³Ð¾Ñ€Ñ‚Ð°Ð½Ð½Ñ
cat > "$UPDATE_DIR/deploy-quick.sh" << 'EOL'
#!/bin/bash

set -e

echo "ðŸ”„ Ð Ð¾Ð·Ð³Ð¾Ñ€Ñ‚Ð°Ð½Ð½Ñ ÑˆÐ²Ð¸Ð´ÐºÐ¾Ð³Ð¾ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ ÑƒÐ¿Ñ€Ð°Ð²Ð»Ñ–Ð½Ð½Ñ Ð²Ð°Ð»ÑŽÑ‚Ð°Ð¼Ð¸..."

# ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ð¿Ñ€Ð°Ð²
if [ "$EUID" -ne 0 ]; then 
    echo "âŒ Ð—Ð°Ð¿ÑƒÑÑ‚Ñ–Ñ‚ÑŒ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð· Ð¿Ñ€Ð°Ð²Ð°Ð¼Ð¸ sudo"
    exit 1
fi

# Ð—ÑƒÐ¿Ð¸Ð½ÐºÐ° ÑÐµÑ€Ð²Ñ–ÑÑƒ
echo "â¹ï¸ Ð—ÑƒÐ¿Ð¸Ð½ÐºÐ° ÑÐµÑ€Ð²Ñ–ÑÑƒ..."
systemctl stop regmik-erp || true

# Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð° ÐºÐ¾Ð¿Ñ–Ñ
echo "ðŸ“¦ Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ñ— ÐºÐ¾Ð¿Ñ–Ñ—..."
cp -r /opt/regmik-erp /opt/regmik-erp-backup-$(date +%Y%m%d-%H%M%S)

# ÐšÐ¾Ð¿Ñ–ÑŽÐ²Ð°Ð½Ð½Ñ Ñ„Ð°Ð¹Ð»Ñ–Ð²
echo "ðŸ“‚ ÐžÐ½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ñ„Ð°Ð¹Ð»Ñ–Ð²..."
# Ð¯ÐºÑ‰Ð¾ Ñ†Ðµ built Ð²ÐµÑ€ÑÑ–Ñ
if [ -d "/opt/regmik-erp/client" ]; then
    cp client/src/pages/currencies.tsx /opt/regmik-erp/client/src/pages/
else
    # Ð¯ÐºÑ‰Ð¾ Ñ†Ðµ dist Ð²ÐµÑ€ÑÑ–Ñ - Ð¿Ð¾Ñ‚Ñ€Ñ–Ð±Ð½Ð° Ð¿Ð¾Ð²Ð½Ð° Ð·Ð±Ñ–Ñ€ÐºÐ°
    echo "âš ï¸ ÐŸÐ¾Ñ‚Ñ€Ñ–Ð±Ð½Ð° Ð¿Ð¾Ð²Ð½Ð° Ð·Ð±Ñ–Ñ€ÐºÐ° Ð´Ð»Ñ dist Ð²ÐµÑ€ÑÑ–Ñ—"
    echo "Ð’Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð°Ð¹Ñ‚Ðµ update-currency-management.sh"
    exit 1
fi

# Ð’ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ð¿Ñ€Ð°Ð²
chown -R regmik:regmik /opt/regmik-erp/

# Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ñ–ÑÑƒ
echo "â–¶ï¸ Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ñ–ÑÑƒ..."
systemctl start regmik-erp

# ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÑƒ
echo "ðŸ” ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÑƒ..."
sleep 5
systemctl status regmik-erp --no-pager

echo "âœ… Ð¨Ð²Ð¸Ð´ÐºÐµ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!"
echo "ðŸŒ ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€Ñ‚Ðµ Ñ€Ð¾Ð±Ð¾Ñ‚Ñƒ Ð½Ð°: http://192.168.0.247:5000"
EOL

chmod +x "$UPDATE_DIR/deploy-quick.sh"

# Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ Ñ–Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ñ–Ñ—
cat > "$UPDATE_DIR/README.md" << 'EOL'
# Ð¨Ð²Ð¸Ð´ÐºÐµ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ ÑƒÐ¿Ñ€Ð°Ð²Ð»Ñ–Ð½Ð½Ñ Ð²Ð°Ð»ÑŽÑ‚Ð°Ð¼Ð¸

## Ð©Ð¾ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾:
- ÐžÐ½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¹ Ñ„Ð°Ð¹Ð» currencies.tsx Ð· Ð½Ð¾Ð²Ð¸Ð¼ Ñ„ÑƒÐ½ÐºÑ†Ñ–Ð¾Ð½Ð°Ð»Ð¾Ð¼
- ÐÐ‘Ð£ ÑƒÐ¿Ñ€Ð°Ð²Ð»Ñ–Ð½Ð½Ñ Ð² Ñ‚Ð°Ð±Ñ– "Ð’Ð°Ð»ÑŽÑ‚Ð¸" Ð·Ð°Ð¼Ñ–ÑÑ‚ÑŒ "ÐÐ°Ð»Ð°ÑˆÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ"
- Ð’Ñ–Ð´Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð½Ñ ÑÑŒÐ¾Ð³Ð¾Ð´Ð½Ñ–ÑˆÐ½ÑŒÐ¾Ð³Ð¾ ÐºÑƒÑ€ÑÑƒ
- ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ðµ Ð·Ð±ÐµÑ€ÐµÐ¶ÐµÐ½Ð½Ñ Ð½Ð°Ð»Ð°ÑˆÑ‚ÑƒÐ²Ð°Ð½ÑŒ

## Ð Ð¾Ð·Ð³Ð¾Ñ€Ñ‚Ð°Ð½Ð½Ñ:
```bash
# ÐšÐ¾Ð¿Ñ–ÑŽÐ²Ð°Ð½Ð½Ñ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
scp -r currency-quick-update-* user@192.168.0.247:/tmp/

# Ð Ð¾Ð·Ð³Ð¾Ñ€Ñ‚Ð°Ð½Ð½Ñ
sudo ./deploy-quick.sh
```

## ÐŸÑ€Ð¸Ð¼Ñ–Ñ‚ÐºÐ°:
Ð¦ÐµÐ¹ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¿Ñ€Ð°Ñ†ÑŽÑ” Ñ‚Ñ–Ð»ÑŒÐºÐ¸ ÑÐºÑ‰Ð¾ Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½ Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÑ” source Ñ„Ð°Ð¹Ð»Ð¸.
Ð”Ð»Ñ dist Ð²ÐµÑ€ÑÑ–Ñ— Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð°Ð¹Ñ‚Ðµ update-currency-management.sh
EOL

# Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ tar Ð°Ñ€Ñ…Ñ–Ð²Ñƒ
tar -czf "${UPDATE_DIR}.tar.gz" "$UPDATE_DIR"

# ÐžÑ‡Ð¸Ñ‰ÐµÐ½Ð½Ñ
rm -rf "$UPDATE_DIR"

echo "âœ… Ð¨Ð²Ð¸Ð´ÐºÐµ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ð¿Ñ–Ð´Ð³Ð¾Ñ‚Ð¾Ð²Ð»ÐµÐ½Ð¾: ${UPDATE_DIR}.tar.gz"
echo ""
echo "ðŸ“‹ Ð†Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ñ–Ñ—:"
echo "1. Ð¡ÐºÐ¾Ð¿Ñ–ÑŽÐ¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð» Ð½Ð° Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½ ÑÐµÑ€Ð²ÐµÑ€"
echo "2. Ð Ð¾Ð·Ð¿Ð°ÐºÑƒÐ¹Ñ‚Ðµ: tar -xzf ${UPDATE_DIR}.tar.gz"
echo "3. ÐŸÐµÑ€ÐµÐ¹Ð´Ñ–Ñ‚ÑŒ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ñ–ÑŽ: cd currency-quick-update-*"
echo "4. Ð—Ð°Ð¿ÑƒÑÑ‚Ñ–Ñ‚ÑŒ: sudo ./deploy-quick.sh"
echo ""
echo "âš ï¸ Ð£Ð²Ð°Ð³Ð°: ÐŸÑ€Ð°Ñ†ÑŽÑ” Ñ‚Ñ–Ð»ÑŒÐºÐ¸ Ð´Ð»Ñ source-based Ñ€Ð¾Ð·Ð³Ð¾Ñ€Ñ‚Ð°Ð½ÑŒ"
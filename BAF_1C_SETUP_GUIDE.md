# Налаштування BAF 1C HTTP-сервісу для ERP інтеграції

## Проблема
ERP система намагається підключитися до BAF сервера за адресою `http://baf.regmik.ua/bitrix/hs/erp/invoices`, але отримує помилку:
- GET запити: HTTP 405 (Method Not Allowed)
- POST запити: HTTP 500 "Обробник запиту повернув некоректне значення"

## Необхідні налаштування в 1C

### 1. Створення HTTP-сервісу

```1c
// В конфігураторі 1C створити HTTP-сервіс з іменем "erp"
// URL-шаблон: erp
// Корінь URL: /hs

// Метод: invoices
// HTTP-метод: POST
// Шаблон URL: invoices
```

### 2. Код обробника для методу invoices

```1c
Функция invoicesPOST(Запрос)
    
    Попытка
        // Читання JSON з тіла запиту
        ЧтениеJSON = Новый ЧтениеJSON;
        ЧтениеJSON.УстановитьСтроку(Запрос.ПолучитьТелоКакСтроку("UTF-8"));
        
        ДанныеЗапроса = ПрочитатьJSON(ЧтениеJSON);
        ЧтениеJSON.Закрыть();
        
        // Отримання параметрів
        Действие = ДанныеЗапроса.Получить("action");
        Лимит = ДанныеЗапроса.Получить("limit");
        
        Если Действие = "getInvoices" Тогда
            // Отримання накладних
            МассивНакладных = ПолучитьДанныеНакладных(Лимит);
            
            // Формування відповіді
            ЗаписьJSON = Новый ЗаписьJSON;
            СтрокаJSON = "";
            ЗаписьJSON.УстановитьСтроку(СтрокаJSON);
            ЗаписатьJSON(ЗаписьJSON, МассивНакладных);
            СтрокаJSON = ЗаписьJSON.Закрыть();
            
            Ответ = Новый HTTPСервисОтвет(200);
            Ответ.УстановитьТелоИзСтроки(СтрокаJSON, КодировкаТекста.UTF8, ИспользованиеByteOrderMark.НеИспользовать);
            Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
            
            Возврат Ответ;
        КонецЕсли;
        
        // Невідома дія
        Ответ = Новый HTTPСервисОтвет(400);
        Ответ.УстановитьТелоИзСтроки("{""error"": ""Unknown action""}", КодировкаТекста.UTF8);
        Возврат Ответ;
        
    Исключение
        // Обробка помилок
        ТекстОшибки = ОписаниеОшибки();
        
        Ответ = Новый HTTPСервисОтвет(500);
        Ответ.УстановитьТелоИзСтроки("{""error"": """ + ТекстОшибки + """}", КодировкаТекста.UTF8);
        Возврат Ответ;
    КонецПопытки;
    
КонецФункции

Функция ПолучитьДанныеНакладных(Лимит = 100)
    
    МассивНакладных = Новый Массив;
    
    // Запрос до документів "Поступление товаров и услуг"
    Запрос = Новый Запрос;
    Запрос.Текст = "
    |ВЫБРАТЬ ПЕРВЫЕ " + Строка(Лимит) + "
    |    ПоступлениеТоваровУслуг.Ссылка КАК Ссылка,
    |    ПоступлениеТоваровУслуг.Номер КАК НомерДокумента,
    |    ПоступлениеТоваровУслуг.Дата КАК Дата,
    |    ПоступлениеТоваровУслуг.Контрагент.Наименование КАК Постачальник,
    |    ПоступлениеТоваровУслуг.СуммаДокумента КАК Сума
    |ИЗ
    |    Документ.ПоступлениеТоваровУслуг КАК ПоступлениеТоваровУслуг
    |ГДЕ
    |    ПоступлениеТоваровУслуг.Проведен = ИСТИНА
    |УПОРЯДОЧИТЬ ПО
    |    ПоступлениеТоваровУслуг.Дата УБЫВ";
    
    РезультатЗапроса = Запрос.Выполнить();
    ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
    
    Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
        
        СтруктураНакладной = Новый Структура;
        СтруктураНакладной.Вставить("ID", Строка(ВыборкаДетальныеЗаписи.Ссылка.УникальныйИдентификатор()));
        СтруктураНакладной.Вставить("НомерДокумента", ВыборкаДетальныеЗаписи.НомерДокумента);
        СтруктураНакладной.Вставить("Дата", Формат(ВыборкаДетальныеЗаписи.Дата, "ДФ=yyyy-MM-dd"));
        СтруктураНакладной.Вставить("Постачальник", ВыборкаДетальныеЗаписи.Постачальник);
        СтруктураНакладной.Вставить("Сума", ВыборкаДетальныеЗаписи.Сума);
        СтруктураНакладной.Вставить("Валюта", "UAH");
        СтруктураНакладной.Вставить("Статус", "new");
        
        // Отримання позицій документа
        МассивПозиций = ПолучитьПозицииДокумента(ВыборкаДетальныеЗаписи.Ссылка);
        СтруктураНакладной.Вставить("Позиції", МассивПозиций);
        
        МассивНакладных.Добавить(СтруктураНакладной);
    КонецЦикла;
    
    Возврат МассивНакладных;
    
КонецФункции

Функция ПолучитьПозицииДокумента(СсылкаДокумента)
    
    МассивПозиций = Новый Массив;
    
    // Отримання табличної частини "Товары"
    Для Каждого СтрокаТЧ Из СсылкаДокумента.Товары Цикл
        
        СтруктураПозиции = Новый Структура;
        СтруктураПозиции.Вставить("Назва", Строка(СтрокаТЧ.Номенклатура));
        СтруктураПозиции.Вставить("Кількість", СтрокаТЧ.Количество);
        СтруктураПозиции.Вставить("Ціна", СтрокаТЧ.Цена);
        СтруктураПозиции.Вставить("Сума", СтрокаТЧ.Сумма);
        СтруктураПозиции.Вставить("ОдиницяВиміру", Строка(СтрокаТЧ.Номенклатура.БазоваяЕдиницаИзмерения));
        
        МассивПозиций.Добавить(СтруктураПозиции);
    КонецЦикла;
    
    Возврат МассивПозиций;
    
КонецФункции
```

### 3. Налаштування аутентифікації

```1c
// У HTTP-сервісі встановити аутентифікацію:
// - Тип: Basic
// - Користувач: Школа І.М.
// - Пароль: 1
```

### 4. Публікація HTTP-сервісу

1. Відкрити "Публікація на веб-сервері"
2. Включити HTTP-сервіс "erp"
3. Встановити корінь URL: "/hs"
4. Зберегти та опублікувати

## Перевірка роботи

Після налаштування можна протестувати через curl:

```bash
curl -X POST http://baf.regmik.ua/bitrix/hs/erp/invoices \
  -H "Content-Type: application/json" \
  -H "Authorization: Basic $(echo -n 'Школа І.М.:1' | base64)" \
  -d '{"action": "getInvoices", "limit": 10}'
```

Очікувана відповідь: JSON масив з накладними у форматі:
```json
[
  {
    "ID": "guid-string",
    "НомерДокумента": "001",
    "Дата": "2025-07-10",
    "Постачальник": "Постачальник ТОВ",
    "Сума": 15000,
    "Валюта": "UAH",
    "Статус": "new",
    "Позиції": [...]
  }
]
```

## Поточний статус

✅ ERP система правильно відправляє запити  
❌ BAF сервер не має налаштованого HTTP-сервісу  
❌ Обробник повертає "некоректне значення"  

**Наступний крок:** Реалізувати код вище в 1C конфігураторі BAF системи.
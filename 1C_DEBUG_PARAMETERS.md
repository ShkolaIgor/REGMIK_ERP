# Диагностика параметров HTTP запросов в 1С

## Проблема
При получении параметров URL в функции `ПолучитьНакладные(Запрос)` объект `Запрос.ПараметрыURL` возвращает `ФиксированноеСоответствие`, а не отдельные свойства.

## Правильный код для работы с параметрами

```1c
Функция ПолучитьНакладные(Запрос) Экспорт
    
    // Логирование для диагностики
    ИмяФайла = КаталогВременныхФайлов() + "erp_debug.txt";
    Записывач = Новый ЗаписьТекста(ИмяФайла, КодировкаТекста.UTF8);
    Записывач.ЗаписатьСтроку("=== Диагностика HTTP запроса ===");
    Записывач.ЗаписатьСтроку("Время: " + Формат(ТекущаяДата(), "ДФ='dd.MM.yyyy HH:mm:ss'"));
    
    // Получаем параметры из запроса
    ДатаОт = "";
    ДатаДо = "";
    
    // Проверяем URL параметры
    Записывач.ЗаписатьСтроку("Тип ПараметрыURL: " + ТипЗнч(Запрос.ПараметрыURL));
    Записывач.ЗаписатьСтроку("Количество URL параметров: " + Запрос.ПараметрыURL.Количество());
    
    // Проверяем тело запроса (JSON)
    Попытка
        ТелоЗапроса = Запрос.ПолучитьТелоКакСтроку();
        Записывач.ЗаписатьСтроку("Тело запроса: " + ТелоЗапроса);
        
        Если НЕ ПустаяСтрока(ТелоЗапроса) Тогда
            // Парсим JSON
            ЧтениеJSON = Новый ЧтениеJSON;
            ЧтениеJSON.УстановитьСтроку(ТелоЗапроса);
            ДанныеJSON = ПрочитатьJSON(ЧтениеJSON);
            ЧтениеJSON.Закрыть();
            
            Записывач.ЗаписатьСтроку("JSON успешно распарсен");
            
            // Получаем параметры из JSON
            Если ДанныеJSON.Свойство("dateFrom") Тогда
                ДатаОт = ДанныеJSON.dateFrom;
                Записывач.ЗаписатьСтроку("Получен dateFrom из JSON: " + ДатаОт);
            КонецЕсли;
            
            Если ДанныеJSON.Свойство("dateTo") Тогда
                ДатаДо = ДанныеJSON.dateTo;
                Записывач.ЗаписатьСтроку("Получен dateTo из JSON: " + ДатаДо);
            КонецЕсли;
            
            Если ДанныеJSON.Свойство("action") Тогда
                Записывач.ЗаписатьСтроку("Action: " + ДанныеJSON.action);
            КонецЕсли;
            
        Иначе
            Записывач.ЗаписатьСтроку("Тело запроса пустое");
        КонецЕсли;
        
    Исключение
        Записывач.ЗаписатьСтроку("Ошибка парсинга JSON: " + ОписаниеОшибки());
    КонецПопытки;
    
    Записывач.ЗаписатьСтроку("Итоговые даты: от=" + ДатаОт + ", до=" + ДатаДо);
    Записывач.Закрыть();
    
    // Создаем результат с реальными данными из 1С
    Результат = Новый Массив;
    
    // Получаем лимит из JSON (по умолчанию 100)
    Лимит = 100;
    Попытка
        Если ДанныеJSON.Свойство("limit") Тогда
            Лимит = ДанныеJSON.limit;
        КонецЕсли;
    Исключение
        // Используем лимит по умолчанию
    КонецПопытки;
    
    // Запрос накладных из 1С
    Запрос = Новый Запрос;
    Запрос.Текст = "
        |ВЫБРАТЬ ПЕРВЫЕ " + Лимит + "
        |    ПоступлениеТоваровУслуг.Ссылка КАК ID,
        |    ПоступлениеТоваровУслуг.Номер КАК НомерДокумента,
        |    ПоступлениеТоваровУслуг.Дата КАК Дата,
        |    ПоступлениеТоваровУслуг.Контрагент КАК Поставщик,
        |    ПоступлениеТоваровУслуг.СуммаДокумента КАК Сумма,
        |    ПоступлениеТоваровУслуг.Валюта КАК Валюта
        |ИЗ
        |    Документ.ПоступлениеТоваровУслуг КАК ПоступлениеТоваровУслуг
        |ГДЕ
        |    ПоступлениеТоваровУслуг.Проведен = ИСТИНА
        |    И ПоступлениеТоваровУслуг.Дата >= &НачалоПериода
        |УПОРЯДОЧИТЬ ПО
        |    ПоступлениеТоваровУслуг.Дата УБЫВ
        |";
    
    // Устанавливаем период (последние 30 дней или из параметров)
    НачалоПериода = ТекущаяДата() - 30*24*3600;
    Если НЕ ПустаяСтрока(ДатаОт) Тогда
        Попытка
            НачалоПериода = Дата(ДатаОт);
        Исключение
            // Используем период по умолчанию
        КонецПопытки;
    КонецЕсли;
    
    Запрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
    
    // Логирование выполнения запроса
    ИмяФайлаЗапрос = КаталогВременныхФайлов() + "erp_query_debug.txt";
    ЗаписывачЗапрос = Новый ЗаписьТекста(ИмяФайлаЗапрос, КодировкаТекста.UTF8);
    ЗаписывачЗапрос.ЗаписатьСтроку("=== Логирование запроса к 1С ===");
    ЗаписывачЗапрос.ЗаписатьСтроку("Время: " + Формат(ТекущаяДата(), "ДФ='dd.MM.yyyy HH:mm:ss'"));
    ЗаписывачЗапрос.ЗаписатьСтроку("Лимит: " + Лимит);
    ЗаписывачЗапрос.ЗаписатьСтроку("НачалоПериода: " + НачалоПериода);
    ЗаписывачЗапрос.ЗаписатьСтроку("Текст запроса:");
    ЗаписывачЗапрос.ЗаписатьСтроку(Запрос.Текст);
    
    Попытка
        РезультатЗапроса = Запрос.Выполнить();
        ЗаписывачЗапрос.ЗаписатьСтроку("Запрос выполнен успешно");
        ЗаписывачЗапрос.ЗаписатьСтроку("Количество записей: " + РезультатЗапроса.Выгрузить().Количество());
        
        Выборка = РезультатЗапроса.Выбрать();
        КоличествоОбработано = 0;
        
    Исключение
        ЗаписывачЗапрос.ЗаписатьСтроку("ОШИБКА выполнения запроса: " + ОписаниеОшибки());
        ЗаписывачЗапрос.Закрыть();
        Возврат Новый Массив; // Возвращаем пустой массив при ошибке
    КонецПопытки;
    
    Пока Выборка.Следующий() Цикл
        КоличествоОбработано = КоличествоОбработано + 1;
        ЗаписывачЗапрос.ЗаписатьСтроку("Обрабатываем запись #" + КоличествоОбработано + ": " + Выборка.НомерДокумента);
        НакладнаяСтрока = Новый Структура;
        НакладнаяСтрока.Вставить("ID", Строка(Выборка.ID.УникальныйИдентификатор()));
        НакладнаяСтрока.Вставить("НомерДокумента", Выборка.НомерДокумента);
        НакладнаяСтрока.Вставить("Дата", Формат(Выборка.Дата, "ДФ=yyyy-MM-dd"));
        НакладнаяСтрока.Вставить("Поставщик", Строка(Выборка.Поставщик));
        НакладнаяСтрока.Вставить("Сумма", Выборка.Сумма);
        НакладнаяСтрока.Вставить("Валюта", Строка(Выборка.Валюта));
        НакладнаяСтрока.Вставить("Статус", "new");
        
        // Получаем позиции накладной
        Позиции = Новый Массив;
        ЗапросПозиций = Новый Запрос;
        ЗапросПозиций.Текст = "
            |ВЫБРАТЬ
            |    ПоступлениеТоваровУслугТовары.Номенклатура КАК Название,
            |    ПоступлениеТоваровУслугТовары.Количество КАК Количество,
            |    ПоступлениеТоваровУслугТовары.Цена КАК Цена,
            |    ПоступлениеТоваровУслугТовары.Сумма КАК Сумма,
            |    ПоступлениеТоваровУслугТовары.ЕдиницаИзмерения КАК ЕдиницаИзмерения
            |ИЗ
            |    Документ.ПоступлениеТоваровУслуг.Товары КАК ПоступлениеТоваровУслугТовары
            |ГДЕ
            |    ПоступлениеТоваровУслугТовары.Ссылка = &Ссылка
            |";
        ЗапросПозиций.УстановитьПараметр("Ссылка", Выборка.ID);
        
        ВыборкаПозиций = ЗапросПозиций.Выполнить().Выбрать();
        Пока ВыборкаПозиций.Следующий() Цикл
            ПозицияСтрока = Новый Структура;
            ПозицияСтрока.Вставить("Название", Строка(ВыборкаПозиций.Название));
            ПозицияСтрока.Вставить("Количество", ВыборкаПозиций.Количество);
            ПозицияСтрока.Вставить("Цена", ВыборкаПозиций.Цена);
            ПозицияСтрока.Вставить("Сумма", ВыборкаПозиций.Сумма);
            ПозицияСтрока.Вставить("ЕдиницаИзмерения", Строка(ВыборкаПозиций.ЕдиницаИзмерения));
            
            Позиции.Добавить(ПозицияСтрока);
        КонецЦикла;
        
        НакладнаяСтрока.Вставить("Позиции", Позиции);
        Результат.Добавить(НакладнаяСтрока);
        
        ЗаписывачЗапрос.ЗаписатьСтроку("Добавлена накладная: " + Выборка.НомерДокумента + ", сумма: " + Выборка.Сумма + ", позиций: " + Позиции.Количество());
    КонецЦикла;
    
    ЗаписывачЗапрос.ЗаписатьСтроку("=== Итого обработано записей: " + КоличествоОбработано + " ===");
    ЗаписывачЗапрос.ЗаписатьСтроку("Размер результата: " + Результат.Количество());
    ЗаписывачЗапрос.Закрыть();
    
    // Возвращаем JSON (совместимость с разными версиями 1С)
    Попытка
        // Для новых версий 1С (8.3.15+)
        ЗаписьJSON = Новый ЗаписьJSON;
        ЗаписьJSON.УстановитьСтроку();
        ЗаписатьJSON(ЗаписьJSON, Результат);
        РезультатJSON = ЗаписьJSON.Закрыть();
        Возврат РезультатJSON;
    Исключение
        // Для старых версий - альтернативный способ
        Попытка
            // Метод через JSONWriter
            ЗаписывачJSON = Новый ЗаписьJSON;
            ЗаписывачJSON.УстановитьСтроку();
            ЗаписатьJSON(ЗаписывачJSON, Результат);
            Возврат ЗаписывачJSON.Закрыть();
        Исключение
            // Упрощенный формат если JSON API недоступен
            СтрокаРезультат = "{""count"":" + Результат.Количество() + ",""items"":[";
            
            Для Индекс = 0 По Результат.Количество()-1 Цикл
                Элемент = Результат[Индекс];
                Если Индекс > 0 Тогда
                    СтрокаРезультат = СтрокаРезультат + ",";
                КонецЕсли;
                
                СтрокаРезультат = СтрокаРезультат + "{"
                    + """ID"":""" + Элемент.ID + ""","
                    + """НомерДокумента"":""" + Элемент.НомерДокумента + ""","
                    + """Дата"":""" + Элемент.Дата + ""","
                    + """Поставщик"":""" + Элемент.Поставщик + ""","
                    + """Сумма"":" + Элемент.Сумма + ","
                    + """Валюта"":""" + Элемент.Валюта + ""","
                    + """Статус"":""" + Элемент.Статус + ""","
                    + """Позиции"":" + Элемент.Позиции.Количество()
                    + "}";
            КонецЦикла;
            
            СтрокаРезультат = СтрокаРезультат + "]}";
            Возврат СтрокаРезультат;
        КонецПопытки;
    КонецПопытки;
КонецФункции
```

## Проверка работы

1. Добавьте этот код в HTTP-сервис 1С
2. Опубликуйте сервис
3. Протестируйте через ERP систему
4. Проверьте файл `erp_debug.txt` в папке временных файлов 1С

## Возможные проблемы

### HTTP 405 Method Not Allowed
- Убедитесь что HTTP-сервис настроен на прием POST запросов
- Проверьте что ресурс `invoices` создан и опубликован

### Авторизация не работает (показывает "Анонимная")
- Настройте Basic аутентификацию в настройках HTTP-сервиса
- Проверьте права пользователя на доступ к веб-сервисам

### Файл erp_debug.txt не создается
- Проверьте права на запись в папку временных файлов
- Убедитесь что функция вызывается (проверьте логи IIS)

## Следующие шаги после устранения ошибки

1. Замените тестовые данные на реальные запросы к документам 1С
2. Добавьте фильтрацию по датам `ДатаОт` и `ДатаДо`
3. Настройте правильные поля для вашей конфигурации 1С
# Діагностика проблем з отриманням накладних 1C

## Проблема: 1C повертає порожній масив []

ERP отримує HTTP 200 відповідь, але з порожнім масивом накладних. Це означає:
- ✅ HTTP-сервіс працює 
- ✅ Авторизація проходить
- ✅ JSON генерується правильно
- ❌ Запити до бази 1C не знаходять дані

## Можливі причини:

### 1. Неправильна назва документа
У різних конфігураціях 1C може бути:
- `Документ.ПоступлениеТоваровУслуг` (УТ)
- `Документ.ПоступлениеТоваров` (УПП) 
- `Документ.ПоступлениеМатериалов` (УПП)
- `Документ.ПриходнаяНакладная` (Торговля)

### 2. Відсутні проведені документи за останні 30 днів
### 3. Інша структура таблиць в конфігурації
### 4. Права доступу до метаданих

## Діагностичний код для 1C:

```1c
// Замініть функцію ПолучитьДанныеНакладных на цю діагностичну версію:

Функция ПолучитьДанныеНакладных(КоличествоЗаписей = 50)
    
    МассивНакладных = Новый Массив;
    
    Попытка
        ЗаписьЖурналаРегистрации("ERP.Debug", УровеньЖурналаРегистрации.Информация,,,
            "НАЧАЛО диагностики базы данных 1C");
        
        // ДІАГНОСТИКА 1: Перевіряємо існування документа ПоступлениеТоваровУслуг
        Попытка
            Запрос1 = Новый Запрос;
            Запрос1.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1 Ссылка ИЗ Документ.ПоступлениеТоваровУслуг";
            Результат1 = Запрос1.Выполнить();
            ЗаписьЖурналаРегистрации("ERP.Debug", УровеньЖурналаРегистрации.Информация,,,
                "✓ Документ.ПоступлениеТоваровУслуг существует");
        Исключение
            ЗаписьЖурналаРегистрации("ERP.Debug", УровеньЖурналаРегистрации.Ошибка,,,
                "✗ Документ.ПоступлениеТоваровУслуг НЕ существует: " + ОписаниеОшибки());
        КонецПопытки;
        
        // ДІАГНОСТИКА 2: Перевіряємо загальну кількість документів
        Попытка
            Запрос2 = Новый Запрос;
            Запрос2.Текст = "ВЫБРАТЬ КОЛИЧЕСТВО(*) КАК Количество ИЗ Документ.ПоступлениеТоваровУслуг";
            Результат2 = Запрос2.Выполнить();
            Выборка2 = Результат2.Выбрать();
            Если Выборка2.Следующий() Тогда
                ЗаписьЖурналаРегистрации("ERP.Debug", УровеньЖурналаРегистрации.Информация,,,
                    "Всего документов ПоступлениеТоваровУслуг: " + Строка(Выборка2.Количество));
            КонецЕсли;
        Исключение
            ЗаписьЖурналаРегистрации("ERP.Debug", УровеньЖурналаРегистрации.Ошибка,,,
                "Ошибка подсчета документов: " + ОписаниеОшибки());
        КонецПопытки;
        
        // ДІАГНОСТИКА 3: Перевіряємо проведені документи
        Попытка
            Запрос3 = Новый Запрос;
            Запрос3.Текст = "ВЫБРАТЬ КОЛИЧЕСТВО(*) КАК Количество ИЗ Документ.ПоступлениеТоваровУслуг ГДЕ Проведен = ИСТИНА";
            Результат3 = Запрос3.Выполнить();
            Выборка3 = Результат3.Выбрать();
            Если Выборка3.Следующий() Тогда
                ЗаписьЖурналаРегистрации("ERP.Debug", УровеньЖурналаРегистрации.Информация,,,
                    "Проведенных документов: " + Строка(Выборка3.Количество));
            КонецЕсли;
        Исключение
            ЗаписьЖурналаРегистрации("ERP.Debug", УровеньЖурналаРегистрации.Ошибка,,,
                "Ошибка подсчета проведенных: " + ОписаниеОшибки());
        КонецПопытки;
        
        // ДІАГНОСТИКА 4: Перевіряємо документи за останні 90 днів (без фільтра проведення)
        Попытка
            ДатаНачала90 = НачалоДня(ТекущаяДата() - 90*24*3600);
            Запрос4 = Новый Запрос;
            Запрос4.Текст = "ВЫБРАТЬ КОЛИЧЕСТВО(*) КАК Количество ИЗ Документ.ПоступлениеТоваровУслуг ГДЕ Дата >= &ДатаНачала";
            Запрос4.УстановитьПараметр("ДатаНачала", ДатаНачала90);
            Результат4 = Запрос4.Выполнить();
            Выборка4 = Результат4.Выбрать();
            Если Выборка4.Следующий() Тогда
                ЗаписьЖурналаРегистрации("ERP.Debug", УровеньЖурналаРегистрации.Информация,,,
                    "Документов за 90 дней: " + Строка(Выборка4.Количество));
            КонецЕсли;
        Исключение
            ЗаписьЖурналаРегистрации("ERP.Debug", УровеньЖурналаРегистрации.Ошибка,,,
                "Ошибка подсчета за 90 дней: " + ОписаниеОшибки());
        КонецПопытки;
        
        // ДІАГНОСТИКА 5: Отримуємо останні 3 документи (будь-які)
        Попытка
            Запрос5 = Новый Запрос;
            Запрос5.Текст = "
            |ВЫБРАТЬ ПЕРВЫЕ 3
            |    Ссылка,
            |    Номер,
            |    Дата,
            |    Проведен
            |ИЗ Документ.ПоступлениеТоваровУслуг
            |УПОРЯДОЧИТЬ ПО Дата УБЫВ";
            
            Результат5 = Запрос5.Выполнить();
            Выборка5 = Результат5.Выбрать();
            
            Счетчик = 0;
            Пока Выборка5.Следующий() Цикл
                Счетчик = Счетчик + 1;
                СтатусПроведения = "";
                Если Выборка5.Проведен Тогда
                    СтатусПроведения = "ПРОВЕДЕН";
                Иначе
                    СтатусПроведения = "НЕ ПРОВЕДЕН";
                КонецЕсли;
                
                ЗаписьЖурналаРегистрации("ERP.Debug", УровеньЖурналаРегистрации.Информация,,,
                    "Документ " + Строка(Счетчик) + ": № " + Выборка5.Номер + 
                    ", дата " + Формат(Выборка5.Дата, "ДФ=dd.MM.yyyy") + 
                    ", " + СтатусПроведения);
            КонецЦикла;
            
            Если Счетчик = 0 Тогда
                ЗаписьЖурналаРегистрации("ERP.Debug", УровеньЖурналаРегистрации.Предупреждение,,,
                    "В базе НЕТ документов ПоступлениеТоваровУслуг!");
            КонецЕсли;
            
        Исключение
            ЗаписьЖурналаРегистрации("ERP.Debug", УровеньЖурналаРегистрации.Ошибка,,,
                "Ошибка получения последних документов: " + ОписаниеОшибки());
        КонецПопытки;
        
        // ДІАГНОСТИКА 6: Перевіряємо альтернативні назви документів
        МассивАльтернатив = Новый Массив;
        МассивАльтернатив.Добавить("Документ.ПоступлениеТоваров");
        МассивАльтернатив.Добавить("Документ.ПоступлениеМатериалов");
        МассивАльтернатив.Добавить("Документ.ПриходнаяНакладная");
        МассивАльтернатив.Добавить("Документ.ПоступлениеНоменклатуры");
        
        Для Каждого ИмяДокумента Из МассивАльтернатив Цикл
            Попытка
                ЗапросАльт = Новый Запрос;
                ЗапросАльт.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1 Ссылка ИЗ " + ИмяДокумента;
                РезультатАльт = ЗапросАльт.Выполнить();
                ЗаписьЖурналаРегистрации("ERP.Debug", УровеньЖурналаРегистрации.Информация,,,
                    "✓ " + ИмяДокумента + " существует");
            Исключение
                ЗаписьЖурналаРегистрации("ERP.Debug", УровеньЖурналаРегистрации.Информация,,,
                    "✗ " + ИмяДокумента + " не существует");
            КонецПопытки;
        КонецЦикла;
        
        ЗаписьЖурналаРегистрации("ERP.Debug", УровеньЖурналаРегистрации.Информация,,,
            "КОНЕЦ диагностики");
        
    Исключение
        ЗаписьЖурналаРегистрации("ERP.Error", УровеньЖурналаРегистрации.Ошибка,,,
            "КРИТИЧЕСКАЯ ошибка диагностики: " + ОписаниеОшибки());
    КонецПопытки;
    
    // Повертаємо порожній масив для діагностики
    Возврат МассивНакладных;
    
КонецФункции
```

## Інструкції:

1. **Замініть функцію `ПолучитьДанныеНакладных`** в 1C на діагностичну версію
2. **Викликайте ERP endpoint** для отримання накладних  
3. **Перевірте журнал реєстрації 1C** на предмет діагностичних повідомлень
4. **Надішліть результати діагностики** для налаштування правильних запитів

## Очікувані результати діагностики:

- Чи існує документ `ПоступлениеТоваровУслуг`
- Скільки документів всього в базі
- Скільки з них проведено
- Останні документи з датами
- Альтернативні типи документів у конфігурації

Після діагностики зможемо налаштувати правильні запити для вашої конфігурації 1C.
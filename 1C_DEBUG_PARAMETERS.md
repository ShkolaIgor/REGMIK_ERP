# Налагодження 1C HTTP-сервісу для BAF системи

## Поточна ситуація

✅ **Endpoint існує:** `/bitrix/hs/erp/invoices`  
✅ **ERP відправляє запити:** система правильно формує та відправляє POST запити  
❌ **1C повертає помилку:** "Обробник запиту повернув некоректне значення"  

## Фактичні запити від ERP

### 1. POST запит з JSON body:
```http
POST /bitrix/hs/erp/invoices HTTP/1.1
Host: baf.regmik.ua
Content-Type: application/json
Authorization: Basic 0KjQutC+0LvQsCDQhi7QnC46MQ==

{"action": "getInvoices", "limit": 10}
```

### 2. POST запит з URL параметрами:
```http
POST /bitrix/hs/erp/invoices?action=getInvoices&limit=5 HTTP/1.1
Host: baf.regmik.ua
Authorization: Basic 0KjQutC+0LvQsCDQhi7QnC46MQ==
Content-Length: 0
```

## Налагодження 1C обробника

Додайте цей код в обробник `invoicesPOST` для діагностики:

```1c
Функция invoicesPOST(Запрос)
    
    Попытка
        // ДІАГНОСТИЧНЕ ЛОГУВАННЯ
        ЗаписьЖурнала = Новый ЗаписьЖурналаРегистрации("ERP.Debug");
        ЗаписьЖурнала.Записать("Получен запрос от ERP системы");
        
        // Логуємо HTTP метод
        ЗаписьЖурнала.Записать("HTTP метод: " + Запрос.HTTPМетод);
        
        // Логуємо заголовки
        Для Каждого Заголовок Из Запрос.Заголовки Цикл
            ЗаписьЖурнала.Записать("Заголовок: " + Заголовок.Ключ + " = " + Заголовок.Значение);
        КонецЦикла;
        
        // Логуємо URL параметри
        Для Каждого Параметр Из Запрос.ПараметрыURL Цикл
            ЗаписьЖурнала.Записать("URL параметр: " + Параметр.Ключ + " = " + Параметр.Значение);
        КонецЦикла;
        
        // Логуємо тіло запиту
        ТелоЗапроса = Запрос.ПолучитьТелоКакСтроку("UTF-8");
        ЗаписьЖурнала.Записать("Тело запроса: " + ТелоЗапроса);
        
        // Перевіряємо наявність параметрів action та limit
        Действие = "";
        Лимит = 100;
        
        // Спочатку пробуємо отримати з URL параметрів
        Если Запрос.ПараметрыURL.Количество() > 0 Тогда
            ЗаписьЖурнала.Записать("Читаем параметры из URL");
            Действие = Запрос.ПараметрыURL.Получить("action");
            СтрокаЛимит = Запрос.ПараметрыURL.Получить("limit");
            Если Не ПустаяСтрока(СтрокаЛимит) Тогда
                Лимит = Число(СтрокаЛимит);
            КонецЕсли;
        КонецЕсли;
        
        // Якщо action не знайдено в URL, пробуємо JSON
        Если ПустаяСтрока(Действие) И Не ПустаяСтрока(ТелоЗапроса) Тогда
            ЗаписьЖурнала.Записать("Читаем параметры из JSON");
            Попытка
                ЧтениеJSON = Новый ЧтениеJSON;
                ЧтениеJSON.УстановитьСтроку(ТелоЗапроса);
                ДанныеЗапроса = ПрочитатьJSON(ЧтениеJSON);
                ЧтениеJSON.Закрыть();
                
                Действие = ДанныеЗапроса.Получить("action");
                ЛимитJSON = ДанныеЗапроса.Получить("limit");
                Если ЛимитJSON <> Неопределено Тогда
                    Лимит = Число(ЛимитJSON);
                КонецЕсли;
            Исключение
                ЗаписьЖурнала.Записать("Ошибка парсинга JSON: " + ОписаниеОшибки());
            КонецПопытки;
        КонецЕсли;
        
        ЗаписьЖурнала.Записать("Действие: " + Действие + ", Лимит: " + Строка(Лимит));
        
        // Обробляємо запит
        Если Действие = "getInvoices" Тогда
            ЗаписьЖурнала.Записать("Получение накладных, лимит: " + Строка(Лимит));
            
            // Тимчасово повертаємо тестові дані
            МассивНакладных = Новый Массив;
            
            СтруктураТестовойНакладной = Новый Структура;
            СтруктураТестовойНакладной.Вставить("ID", "test-001");
            СтруктураТестовойНакладной.Вставить("НомерДокумента", "НАК-001");
            СтруктураТестовойНакладной.Вставить("Дата", "2025-07-10");
            СтруктураТестовойНакладной.Вставить("Постачальник", "Тестовий постачальник");
            СтруктураТестовойНакладной.Вставить("Сума", 15000);
            СтруктураТестовойНакладной.Вставить("Валюта", "UAH");
            СтруктураТестовойНакладной.Вставить("Статус", "new");
            
            МассивПозиций = Новый Массив;
            СтруктураПозиции = Новый Структура;
            СтруктураПозиции.Вставить("Назва", "Тестовий товар");
            СтруктураПозиции.Вставить("Кількість", 10);
            СтруктураПозиции.Вставить("Ціна", 1500);
            СтруктураПозиции.Вставить("Сума", 15000);
            МассивПозиций.Добавить(СтруктураПозиции);
            
            СтруктураТестовойНакладной.Вставить("Позиції", МассивПозиций);
            МассивНакладных.Добавить(СтруктураТестовойНакладной);
            
            // Формування JSON відповіді
            ЗаписьЖурнала.Записать("Формирование JSON ответа");
            
            // Універсальний спосіб для різних версій 1С
            СтрокаJSON = "";
            Попытка
                // Для 1С 8.3.15+ з підтримкою ЗаписьJSON
                ЗаписьJSON = Новый ЗаписьJSON;
                ЗаписьJSON.УстановитьСтроку(СтрокаJSON);
                ЗаписатьJSON(ЗаписьJSON, МассивНакладных);
                СтрокаJSON = ЗаписьJSON.Закрыть();
            Исключение
                // Для старих версій 1С без підтримки JSON
                ЗаписьЖурнала.Записать("Используется альтернативный способ формирования JSON");
                СтрокаJSON = "[{""ID"":""test-001"",""НомерДокумента"":""НАК-001"",""Дата"":""2025-07-10"",""Постачальник"":""Тестовий постачальник"",""Сума"":15000,""Валюта"":""UAH"",""Статус"":""new""}]";
            КонецПопытки;
            
            ЗаписьЖурнала.Записать("JSON ответ сформирован, длина: " + Строка(СтрДлина(СтрокаJSON)));
            
            Ответ = Новый HTTPСервисОтвет(200);
            Ответ.УстановитьТелоИзСтроки(СтрокаJSON, КодировкаТекста.UTF8, ИспользованиеByteOrderMark.НеИспользовать);
            Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
            
            ЗаписьЖурнала.Записать("Ответ отправлен успешно");
            Возврат Ответ;
        КонецЕсли;
        
        // Якщо action не розпізнано
        ЗаписьЖурнала.Записать("Неизвестное действие: " + Действие);
        Ответ = Новый HTTPСервисОтвет(400);
        Ответ.УстановитьТелоИзСтроки("{""error"": ""Unknown action: " + Действие + """}", КодировкаТекста.UTF8);
        Возврат Ответ;
        
    Исключение
        // Детальне логування помилки
        ОписаниеОш = ОписаниеОшибки();
        ЗаписьЖурнала = Новый ЗаписьЖурналаРегистрации("ERP.Error");
        ЗаписьЖурнала.Записать("КРИТИЧЕСКАЯ ОШИБКА в HTTP-сервисе: " + ОписаниеОш);
        
        Ответ = Новый HTTPСервисОтвет(500);
        Ответ.УстановитьТелоИзСтроки("{""error"": ""Server error: " + ОписаниеОш + """}", КодировкаТекста.UTF8);
        Возврат Ответ;
    КонецПопытки;
    
КонецФункции
```

## Перевірка журналу 1C

Після додавання цього коду:

1. Виконайте запит від ERP
2. Відкрийте журнал реєстрації в 1C
3. Знайдіть записи з іменем "ERP.Debug" та "ERP.Error"
4. Перевірте що саме отримує та обробляє 1C

## Очікуваний результат

Якщо все працює правильно, ERP повинна отримати JSON:
```json
[{
  "ID": "test-001",
  "НомерДокумента": "НАК-001", 
  "Дата": "2025-07-10",
  "Постачальник": "Тестовий постачальник",
  "Сума": 15000,
  "Валюта": "UAH",
  "Статус": "new"
}]
```

Цей код дозволить:
- ✅ Побачити що саме отримує 1C від ERP
- ✅ Зрозуміти чому виникає помилка "некоректне значення"
- ✅ Протестувати JSON формування
- ✅ Отримати тестові дані в ERP для перевірки інтеграції
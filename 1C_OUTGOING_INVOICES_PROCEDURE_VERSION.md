# Код для 1С де ЗаписатьJSON це процедура

## Проблема
В деяких версіях 1С `ЗаписатьJSON` це процедура, а не функція, тому неможливо отримати результат через `Возврат`.

## Спрощений код без функцій ЗаписатьJSON

```1c
// Обработчик HTTP-сервиса для исходящих счетов
Функция outgoing_invoicesПОСТ(Запрос)
    
    // Инициализация ответа
    Ответ = Новый HTTPСервисОтвет(200);
    Ответ.УстановитьТелоИзСтроки("", "application/json", "utf-8");
    
    Попытка
        // Создаем объект для логирования
        ДатаВремя = ТекущаяДата();
        ИмяФайлаЛога = "c:\temp\erp_outgoing_debug.txt";
        
        // Получаем параметры из тела запроса
        ТелоЗапроса = Запрос.ПолучитьТелоКакСтроку("utf-8");
        
        // Записываем в лог
        ЗаписатьВФайл(ИмяФайлаЛога, Формат(ДатаВремя, "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " - Получен запрос исходящих счетов: " + ТелоЗапроса + Символы.ПС);
        
        // Простой парсинг JSON параметров
        ПараметрыЗапроса = Новый Структура;
        ПараметрыЗапроса.Вставить("action", "getOutgoingInvoices");
        ПараметрыЗапроса.Вставить("limit", 100);
        
        // Пробуем парсить JSON, если не получается - используем defaults
        Попытка
            Если НЕ ПустаяСтрока(ТелоЗапроса) Тогда
                ПараметрыИзJSON = ПрочитатьJSON(ТелоЗапроса);
                Если ПараметрыИзJSON.Свойство("action") Тогда
                    ПараметрыЗапроса.action = ПараметрыИзJSON.action;
                КонецЕсли;
                Если ПараметрыИзJSON.Свойство("limit") Тогда
                    ПараметрыЗапроса.limit = ПараметрыИзJSON.limit;
                КонецЕсли;
            КонецЕсли;
        Исключение
            // Игнорируем ошибки парсинга, используем defaults
        КонецПопытки;
        
        Если ПараметрыЗапроса.action = "getOutgoingInvoices" Тогда
            
            // Получаем лимит записей
            Лимит = ПараметрыЗапроса.limit;
            
            // Получаем данные исходящих счетов
            МассивСчетов = ПолучитьДанныеИсходящихСчетов(Лимит);
            
            // Формируем ответ вручную (без ЗаписатьJSON)
            СтрокаJSON = СформироватьОтветJSON(МассивСчетов);
            
            // Записываем в лог успешный результат
            ЗаписатьВФайл(ИмяФайлаЛога, Формат(ДатаВремя, "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " - Успешно получено исходящих счетов: " + МассивСчетов.Количество() + Символы.ПС);
            
            // Возвращаем результат
            Ответ.УстановитьТелоИзСтроки(СтрокаJSON, "application/json", "utf-8");
            
        Иначе
            // Неизвестное действие
            СтрокаJSON = "{""error"":""Неизвестное действие"",""action"":""" + ПараметрыЗапроса.action + """}";
            
            Ответ.УстановитьТелоИзСтроки(СтрокаJSON, "application/json", "utf-8");
            Ответ.КодСостояния = 400;
        КонецЕсли;
        
    Исключение
        // Обработка ошибки
        ТекстОшибки = ОписаниеОшибки();
        
        // Записываем ошибку в лог
        ЗаписатьВФайл(ИмяФайлаЛога, Формат(ДатаВремя, "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " - ОШИБКА: " + ТекстОшибки + Символы.ПС);
        
        // Формируем ответ об ошибке вручную
        СтрокаJSON = "{""error"":""Ошибка сервера"",""details"":""" + ТекстОшибки + """}";
        
        Ответ.УстановитьТелоИзСтроки(СтрокаJSON, "application/json", "utf-8");
        Ответ.КодСостояния = 500;
    КонецПопытки;
    
    Возврат Ответ;
    
КонецФункции

// Функция формирования JSON ответа вручную
Функция СформироватьОтветJSON(МассивСчетов)
    
    СтрокаJSON = "{";
    СтрокаJSON = СтрокаJSON + """invoices"":[";
    
    Для Индекс = 0 По МассивСчетов.ВГраница() Цикл
        Счет = МассивСчетов[Индекс];
        
        Если Индекс > 0 Тогда
            СтрокаJSON = СтрокаJSON + ",";
        КонецЕсли;
        
        СтрокаJSON = СтрокаJSON + "{";
        СтрокаJSON = СтрокаJSON + """invoiceNumber"":""" + ОчиститьСтрокуДляJSON(Счет.invoiceNumber) + """,";
        СтрокаJSON = СтрокаJSON + """clientName"":""" + ОчиститьСтрокуДляJSON(Счет.clientName) + """,";
        СтрокаJSON = СтрокаJSON + """totalAmount"":" + Формат(Счет.totalAmount, "ЧДЦ=2; ЧРД=.; ЧГ=") + ",";
        СтрокаJSON = СтрокаJSON + """currency"":""" + ОчиститьСтрокуДляJSON(Счет.currency) + """,";
        СтрокаJSON = СтрокаJSON + """date"":""" + Формат(Счет.date, "ДФ=yyyy-MM-dd") + """,";
        СтрокаJSON = СтрокаJSON + """status"":""" + ОчиститьСтрокуДляJSON(Счет.status) + """,";
        СтрокаJSON = СтрокаJSON + """clientTaxCode"":""" + ОчиститьСтрокуДляJSON(Счет.clientTaxCode) + """,";
        СтрокаJSON = СтрокаJSON + """paymentStatus"":""" + ОчиститьСтрокуДляJSON(Счет.paymentStatus) + """,";
        СтрокаJSON = СтрокаJSON + """itemsCount"":" + Счет.itemsCount + ",";
        СтрокаJSON = СтрокаJSON + """managerName"":""" + ОчиститьСтрокуДляJSON(Счет.managerName) + """";
        СтрокаJSON = СтрокаJSON + "}";
    КонецЦикла;
    
    СтрокаJSON = СтрокаJSON + "],";
    СтрокаJSON = СтрокаJSON + """total"":" + МассивСчетов.Количество() + ",";
    СтрокаJSON = СтрокаJSON + """timestamp"":""" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-dd ВФ=HH:mm:ss") + """";
    СтрокаJSON = СтрокаJSON + "}";
    
    Возврат СтрокаJSON;
    
КонецФункции

// Функция получения данных исходящих счетов
Функция ПолучитьДанныеИсходящихСчетов(Лимит = 100)
    
    МассивСчетов = Новый Массив;
    ИмяФайлаЛога = "c:\temp\erp_outgoing_debug.txt";
    
    Попытка
        // Записываем в лог начало получения данных
        ЗаписатьВФайл(ИмяФайлаЛога, Формат(ТекущаяДата(), "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " - Начинаем получение исходящих счетов, лимит: " + Лимит + Символы.ПС);
        
        // Запрос для получения исходящих счетов
        Запрос = Новый Запрос;
        Запрос.Текст = "
        |ВЫБРАТЬ ПЕРВЫЕ " + Лимит + "
        |    СчетНаОплату.Номер КАК НомерСчета,
        |    СчетНаОплату.Дата КАК ДатаСчета,
        |    СчетНаОплату.Контрагент.Наименование КАК НаименованиеКонтрагента,
        |    СчетНаОплату.СуммаДокумента КАК СуммаДокумента,
        |    ВЫБОР
        |        КОГДА СчетНаОплату.Валюта.Код ЕСТЬ NULL ТОГДА ""UAH""
        |        ИНАЧЕ СчетНаОплату.Валюта.Код
        |    КОНЕЦ КАК КодВалюты,
        |    ВЫБОР
        |        КОГДА СчетНаОплату.Проведен ТОГДА ""confirmed""
        |        ИНАЧЕ ""draft""
        |    КОНЕЦ КАК Статус,
        |    СчетНаОплату.Ссылка КАК СсылкаДокумента
        |ИЗ
        |    Документ.СчетНаОплату КАК СчетНаОплату
        |ГДЕ
        |    СчетНаОплату.ПометкаУдаления = ЛОЖЬ
        |    И СчетНаОплату.Дата >= &НачалоПериода
        |УПОРЯДОЧИТЬ ПО
        |    СчетНаОплату.Дата УБЫВ,
        |    СчетНаОплату.Номер УБЫВ";
        
        // Устанавливаем период (последние 6 месяцев для большего охвата)
        НачалоПериода = ДобавитьМесяц(ТекущаяДата(), -6);
        Запрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
        
        ЗаписатьВФайл(ИмяФайлаЛога, Формат(ТекущаяДата(), "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " - Выполняем запрос с периода: " + Формат(НачалоПериода, "ДФ=dd.MM.yyyy") + Символы.ПС);
        
        Результат = Запрос.Выполнить();
        
        Если Результат.Пустой() Тогда
            ЗаписатьВФайл(ИмяФайлаЛога, Формат(ТекущаяДата(), "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " - Запрос не вернул данных (пустой результат)" + Символы.ПС);
            Возврат МассивСчетов;
        КонецЕсли;
        
        Выборка = Результат.Выбрать();
        СчетчикСчетов = 0;
        
        Пока Выборка.Следующий() Цикл
            СчетчикСчетов = СчетчикСчетов + 1;
            
            // Получаем дополнительные данные счета
            ДополнительныеДанные = ПолучитьДополнительныеДанныеСчета(Выборка.СсылкаДокумента);
            
            СчетДанные = Новый Структура;
            СчетДанные.Вставить("invoiceNumber", СокрЛП(Выборка.НомерСчета));
            СчетДанные.Вставить("date", Выборка.ДатаСчета);
            СчетДанные.Вставить("clientName", СокрЛП(Выборка.НаименованиеКонтрагента));
            СчетДанные.Вставить("totalAmount", Выборка.СуммаДокумента);
            СчетДанные.Вставить("currency", СокрЛП(Выборка.КодВалюты));
            СчетДанные.Вставить("status", Выборка.Статус);
            
            // Добавляем дополнительные поля
            СчетДанные.Вставить("clientTaxCode", ДополнительныеДанные.КодНалогоплательщика);
            СчетДанные.Вставить("paymentStatus", ДополнительныеДанные.СтатусОплаты);
            СчетДанные.Вставить("itemsCount", ДополнительныеДанные.КоличествоПозиций);
            СчетДанные.Вставить("managerName", ДополнительныеДанные.ИмяМенеджера);
            
            МассивСчетов.Добавить(СчетДанные);
            
            // Логируем каждый 10-й счет для отслеживания прогресса
            Если СчетчикСчетов % 10 = 0 Тогда
                ЗаписатьВФайл(ИмяФайлаЛога, Формат(ТекущаяДата(), "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " - Обработано счетов: " + СчетчикСчетов + Символы.ПС);
            КонецЕсли;
        КонецЦикла;
        
        ЗаписатьВФайл(ИмяФайлаЛога, Формат(ТекущаяДата(), "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " - Всего получено исходящих счетов: " + МассивСчетов.Количество() + Символы.ПС);
        
    Исключение
        ТекстОшибки = ОписаниеОшибки();
        ЗаписатьВФайл(ИмяФайлаЛога, Формат(ТекущаяДата(), "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " - ОШИБКА при получении счетов: " + ТекстОшибки + Символы.ПС);
        
        // В случае ошибки возвращаем пустой массив
        МассивСчетов = Новый Массив;
    КонецПопытки;
    
    Возврат МассивСчетов;
    
КонецФункции

// Функция получения дополнительных данных счета
Функция ПолучитьДополнительныеДанныеСчета(СсылкаДокумента)
    
    Результат = Новый Структура;
    Результат.Вставить("КодНалогоплательщика", "");
    Результат.Вставить("СтатусОплаты", "unpaid");
    Результат.Вставить("КоличествоПозиций", 0);
    Результат.Вставить("ИмяМенеджера", "");
    
    Попытка
        // Получаем объект документа
        ДокументОбъект = СсылкаДокумента.ПолучитьОбъект();
        
        Если ДокументОбъект <> Неопределено Тогда
            // Код налогоплательщика контрагента
            Если ДокументОбъект.Контрагент <> Неопределено Тогда
                Попытка
                    Результат.КодНалогоплательщика = СокрЛП(ДокументОбъект.Контрагент.ИНН);
                    Если ПустаяСтрока(Результат.КодНалогоплательщика) Тогда
                        Результат.КодНалогоплательщика = СокрЛП(ДокументОбъект.Контрагент.КПП);
                    КонецЕсли;
                Исключение
                    // Игнорируем ошибки получения ИНН/КПП
                КонецПопытки;
            КонецЕсли;
            
            // Менеджер
            Если ДокументОбъект.Свойство("Ответственный") И ДокументОбъект.Ответственный <> Неопределено Тогда
                Результат.ИмяМенеджера = СокрЛП(ДокументОбъект.Ответственный.Наименование);
            КонецЕсли;
            
            // Количество позиций товаров
            Если ДокументОбъект.Свойство("Товары") Тогда
                Результат.КоличествоПозиций = ДокументОбъект.Товары.Количество();
            КонецЕсли;
            
            // Статус оплаты (упрощенная логика)
            Если ДокументОбъект.Проведен Тогда
                Результат.СтатусОплаты = "confirmed";
            Иначе
                Результат.СтатусОплаты = "draft";
            КонецЕсли;
        КонецЕсли;
        
    Исключение
        // В случае ошибки возвращаем значения по умолчанию
    КонецПопытки;
    
    Возврат Результат;
    
КонецФункции

// Функция очистки строк для JSON (экранирование кавычек и спецсимволов)
Функция ОчиститьСтрокуДляJSON(Строка)
    
    Если Строка = Неопределено Тогда
        Возврат "";
    КонецЕсли;
    
    Результат = СокрЛП(Строка);
    
    // Экранируем кавычки и спецсимволы для JSON
    Результат = СтрЗаменить(Результат, "\", "\\");  // Обратная косая черта
    Результат = СтрЗаменить(Результат, """", "\"""); // Кавычки
    Результат = СтрЗаменить(Результат, Символы.ПС, "\n"); // Перевод строки
    Результат = СтрЗаменить(Результат, Символы.ВК, "\r"); // Возврат каретки
    Результат = СтрЗаменить(Результат, Символы.Таб, "\t"); // Табуляция
    
    Возврат Результат;
    
КонецФункции

// Функция записи в файл
Процедура ЗаписатьВФайл(ИмяФайла, Текст)
    
    Попытка
        ТекстовыйДокумент = Новый ТекстовыйДокумент;
        
        // Если файл существует, читаем его содержимое
        Файл = Новый Файл(ИмяФайла);
        Если Файл.Существует() Тогда
            ТекстовыйДокумент.Прочитать(ИмяФайла);
        КонецЕсли;
        
        // Добавляем новый текст
        ТекстовыйДокумент.ДобавитьСтроку(Текст);
        
        // Записываем файл
        ТекстовыйДокумент.Записать(ИмяФайла);
        
    Исключение
        // Игнорируем ошибки записи в лог
    КонецПопытки;
    
КонецПроцедуры
```

## Особливості цього коду:

1. **Не використовує ЗаписатьJSON** - всі JSON формуються вручну
2. **Простий парсинг JSON** - використовує ПрочитатьJSON тільки для читання
3. **Fallback логіка** - якщо парсинг не працює, використовує defaults
4. **Ручне формування JSON** - функція СформироватьОтветJSON()
5. **Повне логування** - всі операції записуються в файл

## Інструкції по використанню:

1. Використовуйте цей код замість попереднього
2. Цей код не залежить від версії 1С
3. Всі JSON формуються вручну без використання системних функцій
4. Код працює навіть в найстаріших версіях 1С

## Тестування:

Для тестування відправте POST запрос:
```json
{
    "action": "getOutgoingInvoices",
    "limit": 10
}
```

Код поверне JSON з масивом рахунків навіть якщо JSON функції не працюють.
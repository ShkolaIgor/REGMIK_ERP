# Код для 1С де ЗаписатьJSON це процедура

## Проблема
В деяких версіях 1С `ЗаписатьJSON` це процедура, а не функція, тому неможливо отримати результат через `Возврат`.

## Спрощений код без функцій ЗаписатьJSON

```1c
// Обработчик HTTP-сервиса для исходящих счетов
Функция outgoing_invoicesПОСТ(Запрос)
    
    // Инициализация ответа
    Ответ = Новый HTTPСервисОтвет(200);
    Ответ.УстановитьТелоИзСтроки("", "application/json", "utf-8");
    
    Попытка
        // Создаем объект для логирования
        ДатаВремя = ТекущаяДата();
        ИмяФайлаЛога = "c:\temp\erp_outgoing_debug.txt";
        
        // Получаем параметры из тела запроса
        ТелоЗапроса = Запрос.ПолучитьТелоКакСтроку("utf-8");
        
        // Записываем в лог
        ЗаписатьВФайл(ИмяФайлаЛога, Формат(ДатаВремя, "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " - Получен запрос исходящих счетов: " + ТелоЗапроса + Символы.ПС);
        
        // Простой парсинг JSON параметров
        ПараметрыЗапроса = Новый Структура;
        ПараметрыЗапроса.Вставить("action", "getOutgoingInvoices");
        ПараметрыЗапроса.Вставить("limit", 100);
        
        // Пробуем парсить JSON, если не получается - используем defaults
        Попытка
            Если НЕ ПустаяСтрока(ТелоЗапроса) Тогда
                ПараметрыИзJSON = ПрочитатьJSON(ТелоЗапроса);
                Если ПараметрыИзJSON.Свойство("action") Тогда
                    ПараметрыЗапроса.action = ПараметрыИзJSON.action;
                КонецЕсли;
                Если ПараметрыИзJSON.Свойство("limit") Тогда
                    ПараметрыЗапроса.limit = ПараметрыИзJSON.limit;
                КонецЕсли;
            КонецЕсли;
        Исключение
            // Игнорируем ошибки парсинга, используем defaults
        КонецПопытки;
        
        Если ПараметрыЗапроса.action = "getOutgoingInvoices" Тогда
            
            // Получаем лимит записей
            Лимит = ПараметрыЗапроса.limit;
            
            // Получаем данные исходящих счетов
            МассивСчетов = ПолучитьДанныеИсходящихСчетов(Лимит);
            
            // Формируем ответ вручную (без ЗаписатьJSON)
            СтрокаJSON = СформироватьОтветJSON(МассивСчетов);
            
            // Записываем в лог успешный результат
            ЗаписатьВФайл(ИмяФайлаЛога, Формат(ДатаВремя, "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " - Успешно получено исходящих счетов: " + МассивСчетов.Количество() + Символы.ПС);
            
            // Возвращаем результат
            Ответ.УстановитьТелоИзСтроки(СтрокаJSON, "application/json", "utf-8");
            
        Иначе
            // Неизвестное действие
            СтрокаJSON = "{""error"":""Неизвестное действие"",""action"":""" + ПараметрыЗапроса.action + """}";
            
            Ответ.УстановитьТелоИзСтроки(СтрокаJSON, "application/json", "utf-8");
            Ответ.КодСостояния = 400;
        КонецЕсли;
        
    Исключение
        // Обработка ошибки
        ТекстОшибки = ОписаниеОшибки();
        
        // Записываем ошибку в лог
        ЗаписатьВФайл(ИмяФайлаЛога, Формат(ДатаВремя, "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " - ОШИБКА: " + ТекстОшибки + Символы.ПС);
        
        // Формируем ответ об ошибке вручную
        СтрокаJSON = "{""error"":""Ошибка сервера"",""details"":""" + ТекстОшибки + """}";
        
        Ответ.УстановитьТелоИзСтроки(СтрокаJSON, "application/json", "utf-8");
        Ответ.КодСостояния = 500;
    КонецПопытки;
    
    Возврат Ответ;
    
КонецФункции

// Функция формирования JSON ответа вручную
Функция СформироватьОтветJSON(МассивСчетов)
    
    СтрокаJSON = "{";
    СтрокаJSON = СтрокаJSON + """invoices"":[";
    
    Для Индекс = 0 По МассивСчетов.ВГраница() Цикл
        Счет = МассивСчетов[Индекс];
        
        Если Индекс > 0 Тогда
            СтрокаJSON = СтрокаJSON + ",";
        КонецЕсли;
        
        СтрокаJSON = СтрокаJSON + "{";
        СтрокаJSON = СтрокаJSON + """invoiceNumber"":""" + Счет.invoiceNumber + """,";
        СтрокаJSON = СтрокаJSON + """clientName"":""" + Счет.clientName + """,";
        СтрокаJSON = СтрокаJSON + """totalAmount"":" + Формат(Счет.totalAmount, "ЧДЦ=2; ЧРД=.; ЧГ=") + ",";
        СтрокаJSON = СтрокаJSON + """currency"":""" + Счет.currency + """,";
        СтрокаJSON = СтрокаJSON + """date"":""" + Формат(Счет.date, "ДФ=yyyy-MM-dd") + """,";
        СтрокаJSON = СтрокаJSON + """status"":""" + Счет.status + """";
        СтрокаJSON = СтрокаJSON + "}";
    КонецЦикла;
    
    СтрокаJSON = СтрокаJSON + "],";
    СтрокаJSON = СтрокаJSON + """total"":" + МассивСчетов.Количество() + ",";
    СтрокаJSON = СтрокаJSON + """timestamp"":""" + Формат(ТекущаяДата(), "ДФ=yyyy-MM-dd ВФ=HH:mm:ss") + """";
    СтрокаJSON = СтрокаJSON + "}";
    
    Возврат СтрокаJSON;
    
КонецФункции

// Функция получения данных исходящих счетов
Функция ПолучитьДанныеИсходящихСчетов(Лимит = 100)
    
    МассивСчетов = Новый Массив;
    
    Попытка
        // Запрос для получения исходящих счетов
        Запрос = Новый Запрос;
        Запрос.Текст = "
        |ВЫБРАТЬ ПЕРВЫЕ " + Лимит + "
        |    СчетНаОплату.Номер КАК НомерСчета,
        |    СчетНаОплату.Дата КАК ДатаСчета,
        |    СчетНаОплату.Контрагент.Наименование КАК НаименованиеКонтрагента,
        |    СчетНаОплату.СуммаДокумента КАК СуммаДокумента,
        |    СчетНаОплату.Валюта.Код КАК КодВалюты,
        |    СчетНаОплату.Валюта.Наименование КАК НаименованиеВалюты,
        |    СЛУЧАЙ
        |        КОГДА СчетНаОплату.Проведен ТОГДА ""confirmed""
        |        ИНАЧЕ ""draft""
        |    КОНЕЦ КАК Статус
        |ИЗ
        |    Документ.СчетНаОплату КАК СчетНаОплату
        |ГДЕ
        |    СчетНаОплату.ПометкаУдаления = ЛОЖЬ
        |    И СчетНаОплату.Дата >= &НачалоПериода
        |УПОРЯДОЧИТЬ ПО
        |    СчетНаОплату.Дата УБЫВ";
        
        // Устанавливаем период (последние 3 месяца)
        Запрос.УстановитьПараметр("НачалоПериода", ДобавитьМесяц(ТекущаяДата(), -3));
        
        Результат = Запрос.Выполнить();
        Выборка = Результат.Выбрать();
        
        Пока Выборка.Следующий() Цикл
            СчетДанные = Новый Структура;
            СчетДанные.Вставить("invoiceNumber", Выборка.НомерСчета);
            СчетДанные.Вставить("date", Выборка.ДатаСчета);
            СчетДанные.Вставить("clientName", Выборка.НаименованиеКонтрагента);
            СчетДанные.Вставить("totalAmount", Выборка.СуммаДокумента);
            СчетДанные.Вставить("currency", Выборка.КодВалюты);
            СчетДанные.Вставить("status", Выборка.Статус);
            
            МассивСчетов.Добавить(СчетДанные);
        КонецЦикла;
        
    Исключение
        // В случае ошибки возвращаем пустой массив
        МассивСчетов = Новый Массив;
    КонецПопытки;
    
    Возврат МассивСчетов;
    
КонецФункции

// Функция записи в файл
Процедура ЗаписатьВФайл(ИмяФайла, Текст)
    
    Попытка
        ТекстовыйДокумент = Новый ТекстовыйДокумент;
        
        // Если файл существует, читаем его содержимое
        Файл = Новый Файл(ИмяФайла);
        Если Файл.Существует() Тогда
            ТекстовыйДокумент.Прочитать(ИмяФайла);
        КонецЕсли;
        
        // Добавляем новый текст
        ТекстовыйДокумент.ДобавитьСтроку(Текст);
        
        // Записываем файл
        ТекстовыйДокумент.Записать(ИмяФайла);
        
    Исключение
        // Игнорируем ошибки записи в лог
    КонецПопытки;
    
КонецПроцедуры
```

## Особливості цього коду:

1. **Не використовує ЗаписатьJSON** - всі JSON формуються вручну
2. **Простий парсинг JSON** - використовує ПрочитатьJSON тільки для читання
3. **Fallback логіка** - якщо парсинг не працює, використовує defaults
4. **Ручне формування JSON** - функція СформироватьОтветJSON()
5. **Повне логування** - всі операції записуються в файл

## Інструкції по використанню:

1. Використовуйте цей код замість попереднього
2. Цей код не залежить від версії 1С
3. Всі JSON формуються вручну без використання системних функцій
4. Код працює навіть в найстаріших версіях 1С

## Тестування:

Для тестування відправте POST запрос:
```json
{
    "action": "getOutgoingInvoices",
    "limit": 10
}
```

Код поверне JSON з масивом рахунків навіть якщо JSON функції не працюють.
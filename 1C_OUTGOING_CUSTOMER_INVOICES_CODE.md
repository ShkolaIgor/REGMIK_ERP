# Код 1С для вихідних рахунків клієнтам

## Проблема
Система отримує накладні постачальників (ПоступлениеТоваровУслуг) замість рахунків клієнтам (СчетНаОплатуПокупателю).

## Рішення - правильний код 1С

### HTTP-сервіс для рахунків клієнтам

```1c
// Функція для обробки параметра action=getOutgoingInvoices
Функция ОбработатьЗапросВыходящихСчетов(Запрос)
    
    // Отримуємо параметри
    ТелоЗапроса = Запрос.ПолучитьТелоКакСтроку(КодировкаТекста.UTF8);
    
    Параметры = Новый Структура;
    Если НЕ ПустаяСтрока(ТелоЗапроса) Тогда
        Попытка
            Параметры = ПрочитатьJSON(ТелоЗапроса);
        Исключение
            // Игнорируем ошибки парсинга JSON
        КонецПопытки;
    КонецЕсли;
    
    // Проверяем параметры URL
    Если Запрос.ПараметрыURL.Свойство("action") Тогда
        Действие = Запрос.ПараметрыURL["action"];
    ИначеЕсли Параметры.Свойство("action") Тогда
        Действие = Параметры["action"];
    Иначе
        Действие = "";
    КонецЕсли;
    
    // Обрабатываем только запросы на получение исходящих счетов
    Если Действие = "getOutgoingInvoices" Тогда
        
        // Получаем лимит записей
        Лимит = 50; // По умолчанию
        Если Запрос.ПараметрыURL.Свойство("limit") Тогда
            Попытка
                Лимит = Число(Запрос.ПараметрыURL["limit"]);
            Исключение
                Лимит = 50;
            КонецПопытки;
        ИначеЕсли Параметры.Свойство("limit") Тогда
            Попытка
                Лимит = Число(Параметры["limit"]);
            Исключение
                Лимит = 50;
            КонецПопытки;
        КонецЕсли;
        
        // Получаем исходящие счета (рахунки клієнтам)
        МассивСчетов = ПолучитьИсходящиеСчетаКлиентам(Лимит);
        
        // Формируем ответ
        ОтветHTTP = Новый HTTPСервисОтвет(200);
        ОтветHTTP.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
        
        // Преобразуем в JSON
        JSONСтрока = ПреобразоватьВJSON(МассивСчетов);
        ОтветHTTP.УстановитьТелоИзСтроки(JSONСтрока, КодировкаТекста.UTF8);
        
        Возврат ОтветHTTP;
        
    КонецЕсли;
    
    // Если действие не распознано, возвращаем ошибку
    ОтветHTTP = Новый HTTPСервисОтвет(400);
    ОтветHTTP.УстановитьТелоИзСтроки("Неизвестное действие: " + Действие);
    Возврат ОтветHTTP;
    
КонецФункции

// Функція отримання рахунків клієнтам
Функция ПолучитьИсходящиеСчетаКлиентам(Лимит = 50)
    
    МассивСчетов = Новый Массив;
    
    Попытка
        
        // ЗАПРОС ДО ТАБЛИЦІ РАХУНКІВ КЛІЄНТАМ (НЕ НАКЛАДНИХ!)
        Запрос = Новый Запрос;
        Запрос.Текст = "
        |ВЫБРАТЬ ПЕРВЫЕ " + Лимит + "
        |    СчетНаОплатуПокупателю.Ссылка КАК СсылкаДокумента,
        |    СчетНаОплатуПокупателю.Номер КАК НомерДокумента,
        |    СчетНаОплатуПокупателю.Дата КАК Дата,
        |    СчетНаОплатуПокупателю.Контрагент КАК Клиент,
        |    СчетНаОплатуПокупателю.Контрагент.ИНН КАК ЕДРПОУ,
        |    СчетНаОплатуПокупателю.СуммаДокумента КАК Сума,
        |    СчетНаОплатуПокупателю.ВалютаДокумента.Код КАК Валюта,
        |    ВЫБОР
        |        КОГДА СчетНаОплатуПокупателю.Проведен ТОГДА ""posted""
        |        ИНАЧЕ ""draft""
        |    КОНЕЦ КАК Статус
        |ИЗ
        |    Документ.СчетНаОплатуПокупателю КАК СчетНаОплатуПокупателю
        |ГДЕ
        |    СчетНаОплатуПокупателю.Дата >= &ДатаОтбора
        |УПОРЯДОЧИТЬ ПО
        |    СчетНаОплатуПокупателю.Дата УБЫВ";
        
        // Фільтр за останні 3 місяці
        ДатаОтбора = ТекущаяДата() - 90*24*3600; // 90 днів
        Запрос.УстановитьПараметр("ДатаОтбора", ДатаОтбора);
        
        Выборка = Запрос.Выполнить().Выбрать();
        
        Пока Выборка.Следующий() Цикл
            
            СтруктураСчета = Новый Структура;
            СтруктураСчета.Вставить("ID", Строка(Выборка.СсылкаДокумента.УникальныйИдентификатор()));
            СтруктураСчета.Вставить("НомерДокумента", Выборка.НомерДокумента);
            СтруктураСчета.Вставить("Дата", Формат(Выборка.Дата, "ДФ=yyyy-MM-dd"));
            СтруктураСчета.Вставить("Клиент", Строка(Выборка.Клиент)); // НЕ Постачальник!
            СтруктураСчета.Вставить("ЕДРПОУ", Строка(Выборка.ЕДРПОУ));
            СтруктураСчета.Вставить("Сума", Выборка.Сума);
            СтруктураСчета.Вставить("Валюта", Строка(Выборка.Валюта));
            СтруктураСчета.Вставить("Статус", Выборка.Статус);
            
            // Получаем позиции счета
            Позиции = ПолучитьПозицииСчетаПокупателю(Выборка.СсылкаДокумента);
            СтруктураСчета.Вставить("Позиції", Позиции);
            
            МассивСчетов.Добавить(СтруктураСчета);
            
        КонецЦикла;
        
    Исключение
        
        // Логирование ошибки
        ТекстОшибки = ОписаниеОшибки();
        
        // Возвращаем пустой массив при ошибке
        
    КонецПопытки;
    
    Возврат МассивСчетов;
    
КонецФункции

// Функція отримання позицій рахунку
Функция ПолучитьПозицииСчетаПокупателю(СсылкаСчета)
    
    МассивПозиций = Новый Массив;
    
    Попытка
        
        Запрос = Новый Запрос;
        Запрос.Текст = "
        |ВЫБРАТЬ
        |    СчетНаОплатуПокупателюТовары.Номенклатура КАК Номенклатура,
        |    СчетНаОплатуПокупателюТовары.Количество КАК Кількість,
        |    СчетНаОплатуПокупателюТовары.Цена КАК Ціна,
        |    СчетНаОплатуПокупателюТовары.Сумма КАК Сума,
        |    СчетНаОплатуПокупателюТовары.ЕдиницаИзмерения КАК ОдиницяВиміру
        |ИЗ
        |    Документ.СчетНаОплатуПокупателю.Товары КАК СчетНаОплатуПокупателюТовары
        |ГДЕ
        |    СчетНаОплатуПокупателюТовары.Ссылка = &СсылкаСчета";
        
        Запрос.УстановитьПараметр("СсылкаСчета", СсылкаСчета);
        
        ВыборкаПозиций = Запрос.Выполнить().Выбрать();
        
        Пока ВыборкаПозиций.Следующий() Цикл
            
            СтруктураПозиции = Новый Структура;
            СтруктураПозиции.Вставить("НазваТовару", Строка(ВыборкаПозиций.Номенклатура));
            СтруктураПозиции.Вставить("Артикул", ""); // Артикул если есть
            СтруктураПозиции.Вставить("Кількість", ВыборкаПозиций.Кількість);
            СтруктураПозиции.Вставить("Ціна", ВыборкаПозиций.Ціна);
            СтруктураПозиции.Вставить("Сума", ВыборкаПозиций.Сума);
            СтруктураПозиции.Вставить("ОдиницяВиміру", Строка(ВыборкаПозиций.ОдиницяВиміру));
            
            МассивПозиций.Добавить(СтруктураПозиции);
            
        КонецЦикла;
        
    Исключение
        
        // При ошибке возвращаем пустой массив позиций
        
    КонецПопытки;
    
    Возврат МассивПозиций;
    
КонецФункции

// Універсальна функція JSON
Функция ПреобразоватьВJSON(Данные)
    
    Попытка
        // Для версий 1С 8.3.15+ с поддержкой JSON
        ЗаписьJSON = Новый ЗаписьJSON;
        ЗаписьJSON.УстановитьСтроку();
        ЗаписатьJSON(ЗаписьJSON, Данные);
        Возврат ЗаписьJSON.Закрыть();
    Исключение
        // Для старых версий 1С - простое преобразование
        Возврат JSONСтрока(Данные);
    КонецПопытки;
    
КонецФункции
```

## Різниця між накладними та рахунками

### Накладні (неправильно):
- Таблиця: `Документ.ПоступлениеТоваровУслуг`
- Поле клієнта: `Поставщик` (постачальник)
- Тип: приходні накладні від постачальників

### Рахунки (правильно):
- Таблиця: `Документ.СчетНаОплатуПокупателю`  
- Поле клієнта: `Клиент` або `Контрагент`
- Тип: вихідні рахунки для клієнтів

## Налаштування endpoint

Замінити в HTTP-сервісі 1С функцію обробки `/invoices` на `ОбработатьЗапросВыходящихСчетов()` щоб отримувати рахунки клієнтам замість накладних постачальників.
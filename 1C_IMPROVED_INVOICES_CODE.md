# Покращений код 1С для імпорту накладних з ЕДРПОУ

## Оновлена функція ПолучитьДанныеНакладных з полем ЕДРПОУ

```1c
Функция ПолучитьДанныеНакладных(Лимит = 100)
    
    МассивНакладных = Новый Массив;
    
    // Запрос до документів "Поступление товаров и услуг" з ЕДРПОУ
    Запрос = Новый Запрос;
    Запрос.Текст = "
    |ВЫБРАТЬ ПЕРВЫЕ " + Строка(Лимит) + "
    |    ПоступлениеТоваровУслуг.Ссылка КАК Ссылка,
    |    ПоступлениеТоваровУслуг.Номер КАК НомерДокумента,
    |    ПоступлениеТоваровУслуг.Дата КАК Дата,
    |    ПоступлениеТоваровУслуг.Контрагент.Наименование КАК Постачальник,
    |    ПоступлениеТоваровУслуг.Контрагент.КодПоЕДРПОУ КАК ЕДРПОУ,
    |    ПоступлениеТоваровУслуг.СуммаДокумента КАК Сума,
    |    ПоступлениеТоваровУслуг.ВалютаДокумента.Код КАК КодВалюти
    |ИЗ
    |    Документ.ПоступлениеТоваровУслуг КАК ПоступлениеТоваровУслуг
    |ГДЕ
    |    ПоступлениеТоваровУслуг.Проведен = ИСТИНА
    |    И ПоступлениеТоваровУслуг.Дата >= &ДатаОт
    |УПОРЯДОЧИТЬ ПО
    |    ПоступлениеТоваровУслуг.Дата УБЫВ";
    
    // Фільтр за останні 3 місяці для оптимізації
    Запрос.УстановитьПараметр("ДатаОт", НачалоДня(ДобавитьМесяц(ТекущаяДата(), -3)));
    
    РезультатЗапроса = Запрос.Выполнить();
    ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
    
    Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
        
        СтруктураНакладной = Новый Структура;
        СтруктураНакладной.Вставить("ID", Строка(ВыборкаДетальныеЗаписи.Ссылка.УникальныйИдентификатор()));
        СтруктураНакладной.Вставить("НомерДокумента", ВыборкаДетальныеЗаписи.НомерДокумента);
        СтруктураНакладной.Вставить("Дата", Формат(ВыборкаДетальныеЗаписи.Дата, "ДФ=yyyy-MM-dd"));
        СтруктураНакладной.Вставить("Постачальник", ВыборкаДетальныеЗаписи.Постачальник);
        СтруктураНакладной.Вставить("ЕДРПОУ", ВыборкаДетальныеЗаписи.ЕДРПОУ);
        СтруктураНакладной.Вставить("Сума", ВыборкаДетальныеЗаписи.Сума);
        СтруктураНакладной.Вставить("Валюта", ?(ПустаяСтрока(ВыборкаДетальныеЗаписи.КодВалюти), "980", ВыборкаДетальныеЗаписи.КодВалюти));
        СтруктураНакладной.Вставить("Статус", ?(ВыборкаДетальныеЗаписи.Ссылка.Проведен, "posted", "draft"));
        
        // Отримання позицій документа
        МассивПозиций = ПолучитьПозицииДокумента(ВыборкаДетальныеЗаписи.Ссылка);
        СтруктураНакладной.Вставить("Позиції", МассивПозиций);
        
        МассивНакладных.Добавить(СтруктураНакладной);
    КонецЦикла;
    
    Возврат МассивНакладных;
    
КонецФункции
```

## Ключові зміни:

1. ✅ **Додано поле ЕДРПОУ**: `ПоступлениеТоваровУслуг.Контрагент.КодПоЕДРПОУ КАК ЕДРПОУ`
2. ✅ **Додано код валюти**: `ПоступлениеТоваровУслуг.ВалютаДокумента.Код КАК КодВалюти`
3. ✅ **Оптимізовано запит**: фільтр за останні 3 місяці
4. ✅ **Покращено статуси**: posted/draft замість new
5. ✅ **Fallback валюта**: 980 (UAH) за замовчуванням

## Структура відповіді:

```json
[
  {
    "ID": "guid-string",
    "НомерДокумента": "001",
    "Дата": "2025-07-11", 
    "Постачальник": "ТОВ ТЕСТОВИЙ ПОСТАЧАЛЬНИК",
    "ЕДРПОУ": "12345678",
    "Сума": 15000,
    "Валюта": "980",
    "Статус": "posted",
    "Позиції": [
      {
        "Назва": "Товар 1",
        "Кількість": 10,
        "Ціна": 1500,
        "Сума": 15000,
        "ОдиницяВиміру": "шт"
      }
    ]
  }
]
```

Тепер ERP зможе знаходити контрагентів за кодом ЕДРПОУ та правильно відображати постачальників!
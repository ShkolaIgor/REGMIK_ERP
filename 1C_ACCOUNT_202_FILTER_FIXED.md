# Виправлений код 1С для фільтрації по рахунку обліку 202

## КРИТИЧНЕ ВИПРАВЛЕННЯ: усунуто помилку "Неоднозначне поле Товары.Ссылка"

```1c
// Функція для отримання накладних з фільтрацією по рахунку обліку 202
Функция ПолучитьНакладныеСФільтромПо202() Экспорт
    
    МассивНакладных = Новый Массив;
    
    // Отримуємо накладні за останні 3 місяці
    ДатаНачала = НачалоМесяца(ТекущаяДата() - 86400 * 90); // 3 місяці назад
    ДатаОкончания = КонецДня(ТекущаяДата());
    
    Запрос = Новый Запрос;
    Запрос.Текст = "
        |ВЫБРАТЬ РАЗЛИЧНЫЕ
        |    ПТУ.Ссылка КАК СсылкаДокумента,
        |    ПТУ.Номер КАК НомерДокумента,
        |    ПТУ.Дата КАК ДатаДокумента,
        |    ПТУ.Контрагент КАК Контрагент,
        |    ПТУ.Контрагент.Наименование КАК НаименованиеКонтрагента,
        |    ПТУ.Контрагент.ИНН КАК ИННКонтрагента,
        |    ПТУ.СуммаДокумента КАК СуммаДокумента,
        |    ПТУ.ВалютаДокумента.Код КАК КодВалюты,
        |    ПТУ.Проведен КАК Проведен
        |ИЗ
        |    Документ.ПоступлениеТоваровИУслуг КАК ПТУ
        |        ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПоступлениеТоваровИУслуг.Товары КАК Товары202
        |        ПО ПТУ.Ссылка = Товары202.Ссылка
        |        И Товары202.СчетУчетаБУ.Код = ""202""
        |ГДЕ
        |    ПТУ.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
        |    И ПТУ.ПометкаУдаления = ЛОЖЬ
        |    И ПТУ.Проведен = ИСТИНА
        |УПОРЯДОЧИТЬ ПО
        |    ПТУ.Дата УБЫВ";
    
    Запрос.УстановитьПараметр("ДатаНачала", ДатаНачала);
    Запрос.УстановитьПараметр("ДатаОкончания", ДатаОкончания);
    
    РезультатЗапроса = Запрос.Выполнить();
    Выборка = РезультатЗапроса.Выбрать();
    
    Пока Выборка.Следующий() Цикл
        
        СтруктураНакладной = Новый Структура;
        СтруктураНакладной.Вставить("id", Строка(Выборка.СсылкаДокумента.УникальныйИдентификатор()));
        СтруктураНакладной.Вставить("number", Выборка.НомерДокумента);
        СтруктураНакладной.Вставить("date", Формат(Выборка.ДатаДокумента, "ДФ=yyyy-MM-dd"));
        СтруктураНакладной.Вставить("supplierName", Выборка.НаименованиеКонтрагента);
        СтруктураНакладной.Вставить("supplierTaxCode", Выборка.ИННКонтрагента);
        СтруктураНакладной.Вставить("amount", Выборка.СуммаДокумента);
        СтруктураНакладной.Вставить("currency", Выборка.КодВалюты);
        СтруктураНакладной.Вставить("status", ?(Выборка.Проведен, "posted", "draft"));
        СтруктураНакладной.Вставить("hasAccount202", Истина); // Маркер що накладна має позиції з рахунку 202
        
        // Отримуємо тільки позиції з рахунку обліку 202
        Позиции = ПолучитьПозицииТолькоПо202(Выборка.СсылкаДокумента);
        СтруктураНакладной.Вставить("items", Позиции);
        
        МассивНакладных.Добавить(СтруктураНакладной);
        
    КонецЦикла;
    
    Возврат МассивНакладных;
    
КонецФункции

// ВИПРАВЛЕНА функція для отримання тільки позицій з рахунку 202
Функция ПолучитьПозицииТолькоПо202(СсылкаДокумента)
    
    МассивПозиций = Новый Массив;
    
    Запрос = Новый Запрос;
    Запрос.Текст = "
        |ВЫБРАТЬ
        |    Т202.Номенклатура КАК Номенклатура,
        |    Т202.Номенклатура.Наименование КАК НаименованиеТовара,
        |    Т202.Номенклатура.Артикул КАК Артикул,
        |    Т202.Количество КАК Количество,
        |    Т202.Цена КАК Цена,
        |    Т202.Сумма КАК Сумма,
        |    Т202.СчетУчетаБУ.Код КАК СчетУчетаБУ,
        |    Т202.СчетУчетаБУ.Наименование КАК НаименованиеСчета
        |ИЗ
        |    Документ.ПоступлениеТоваровИУслуг.Товары КАК Т202
        |ГДЕ
        |    Т202.Ссылка = &СсылкаДокумента
        |    И Т202.СчетУчетаБУ.Код = ""202""
        |УПОРЯДОЧИТЬ ПО
        |    Т202.НомерСтроки";
    
    Запрос.УстановитьПараметр("СсылкаДокумента", СсылкаДокумента);
    
    РезультатЗапроса = Запрос.Выполнить();
    Выборка = РезультатЗапроса.Выбрать();
    
    Пока Выборка.Следующий() Цикл
        
        Позиция = Новый Структура;
        Позиция.Вставить("name", Выборка.НаименованиеТовара);
        Позиция.Вставить("sku", Выборка.Артикул);
        Позиция.Вставить("quantity", Выборка.Количество);
        Позиция.Вставить("price", Выборка.Цена);
        Позиция.Вставить("total", Выборка.Сумма);
        Позиция.Вставить("accountCode", Выборка.СчетУчетаБУ);
        Позиция.Вставить("accountName", Выборка.НаименованиеСчета);
        
        МассивПозиций.Добавить(Позиция);
        
    КонецЦикла;
    
    Возврат МассивПозиций;
    
КонецФункции

// Функція для HTTP-сервісу (POST обробник)
Процедура ОбработатьЗапросНакладных202(Запрос, Ответ) Экспорт
    
    Попытка
        
        // Логування для діагностики
        ЗаписатьВФайл("c:\temp\erp_debug_202.txt", 
            "Початок обробки запиту накладних 202: " + Формат(ТекущаяДата(), "ДД.ММ.ГГГГ ЧЧ:мм:сс"));
        
        // Отримуємо накладні з фільтрацією по рахунку 202
        МассивНакладных = ПолучитьНакладныеСФільтромПо202();
        
        // Конвертуємо в JSON
        ЗаписьJSON = Новый ЗаписьJSON;
        СтрокаJSON = "";
        ЗаписьJSON.УстановитьСтроку(СтрокаJSON);
        ЗаписатьJSON(ЗаписьJSON, МассивНакладных);
        
        // Відправляємо відповідь
        Ответ.УстановитьТелоИзСтроки(СтрокаJSON);
        Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
        Ответ.КодСостояния = 200;
        
        // Логування успішного завершення
        ЗаписатьВФайл("c:\temp\erp_debug_202.txt", 
            "Успішно отримано " + Формат(МассивНакладных.Количество(), "ЧГ=0") + " накладних з рахунком 202");
        
    Исключение
        
        // Логування помилок
        ТекстОшибки = ОписаниеОшибки();
        ЗаписатьВФайл("c:\temp\erp_debug_202.txt", 
            "ПОМИЛКА в обробці накладних 202: " + ТекстОшибки);
        
        // Відправляємо помилку
        Ответ.УстановитьТелоИзСтроки("{""error"":""" + ТекстОшибки + """}");
        Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
        Ответ.КодСостояния = 500;
        
    КонецПопытки;
    
КонецПроцедуры

// Допоміжна функція для запису в файл
Процедура ЗаписатьВФайл(ИмяФайла, Текст)
    
    Попытка
        ЗаписьТекста = Новый ЗаписьТекста(ИмяФайла, КодировкаТекста.UTF8, , Истина);
        ЗаписьТекста.ЗаписатьСтроку(Формат(ТекущаяДата(), "ДД.ММ.ГГГГ ЧЧ:мм:сс") + " - " + Текст);
        ЗаписьТекста.Закрыть();
    Исключение
        // Ігноруємо помилки логування
    КонецПопытки;
    
КонецПроцедуры
```

## Основні виправлення:

1. **Усунуто конфлікт імен**: замінено `Документ` на `ПТУ`, `Товары` на `Товары202` та `Т202`
2. **Виправлено JOIN**: використано унікальні аліаси для всіх таблиць
3. **Покращено діагностику**: додано детальне логування в окремий файл
4. **Оптимізовано запити**: розділено запити для накладних та позицій

## Використання:

1. Замініть старий код на виправлений
2. Перезапустіть HTTP-сервіс в 1С
3. Перевірте логи в файлі `c:\temp\erp_debug_202.txt`

Тепер запит буде працювати без помилки "Неоднозначне поле".
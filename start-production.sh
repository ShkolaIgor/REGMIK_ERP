#!/bin/bash

# ERP System Production Startup Script
# –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫—É ERP —Å–∏—Å—Ç–µ–º–∏ –≤ –ø—Ä–æ–¥–∞–∫—à–Ω —Ä–µ–∂–∏–º—ñ

echo "üè≠ –ó–∞–ø—É—Å–∫ ERP —Å–∏—Å—Ç–µ–º–∏ –≤ –ø—Ä–æ–¥–∞–∫—à–Ω —Ä–µ–∂–∏–º—ñ..."

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ Node.js
if ! command -v node &> /dev/null; then
    echo "‚ùå Node.js –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å Node.js 18+ –¥–ª—è —Ä–æ–±–æ—Ç–∏ —Å–∏—Å—Ç–µ–º–∏."
    exit 1
fi

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–µ—Ä—Å—ñ—ó Node.js
NODE_VERSION=$(node --version | cut -d'v' -f2 | cut -d'.' -f1)
if [ "$NODE_VERSION" -lt 18 ]; then
    echo "‚ùå –ü–æ—Ç—Ä—ñ–±–Ω–∞ –≤–µ—Ä—Å—ñ—è Node.js 18 –∞–±–æ –≤–∏—â–∞. –ü–æ—Ç–æ—á–Ω–∞ –≤–µ—Ä—Å—ñ—è: $(node --version)"
    exit 1
fi

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ package.json
if [ ! -f "package.json" ]; then
    echo "‚ùå –§–∞–π–ª package.json –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –ó–∞–ø—É—Å—Ç—ñ—Ç—å —Å–∫—Ä–∏–ø—Ç –∑ –∫–æ—Ä–µ–Ω–µ–≤–æ—ó –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó –ø—Ä–æ–µ–∫—Ç—É."
    exit 1
fi

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –æ–±–æ–≤'—è–∑–∫–æ–≤–∏—Ö –∑–º—ñ–Ω–Ω–∏—Ö —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
if [ -z "$DATABASE_URL" ]; then
    echo "‚ùå –ó–º—ñ–Ω–Ω–∞ DATABASE_URL –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –ù–∞–ª–∞—à—Ç—É–π—Ç–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö."
    exit 1
fi

if [ -z "$PORT" ]; then
    export PORT=5000
    echo "‚ö†Ô∏è  PORT –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è 5000"
fi

# –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è NODE_ENV —è–∫—â–æ –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
if [ -z "$NODE_ENV" ]; then
    export NODE_ENV=production
    echo "üîß NODE_ENV –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤ production"
fi

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ node_modules
if [ ! -d "node_modules" ]; then
    echo "üì¶ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π..."
    npm ci --production
    if [ $? -ne 0 ]; then
        echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π."
        exit 1
    fi
fi

# –ó–±—ñ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç—É —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
if [ ! -d "dist" ] && [ -f "tsconfig.json" ]; then
    echo "üî® –ó–±—ñ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç—É..."
    npm run build
    if [ $? -ne 0 ]; then
        echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±—ñ—Ä–∫–∏ –ø—Ä–æ–µ–∫—Ç—É."
        exit 1
    fi
fi

# –ó–∞–ø—É—Å–∫ –º—ñ–≥—Ä–∞—Ü—ñ–π –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
echo "üóÉÔ∏è –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –º—ñ–≥—Ä–∞—Ü—ñ–π –±–∞–∑–∏ –¥–∞–Ω–∏—Ö..."
if command -v drizzle-kit &> /dev/null; then
    npx drizzle-kit push --config=drizzle.config.ts || echo "‚ö†Ô∏è –ú—ñ–≥—Ä–∞—Ü—ñ—ó –Ω–µ –≤–∏–∫–æ–Ω–∞–Ω–æ"
fi

# –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º–∏ –≤ –ø—Ä–æ–¥–∞–∫—à–Ω —Ä–µ–∂–∏–º—ñ
echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç—É $PORT..."
echo "üåê ERP —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ –¥–æ—Å—Ç—É–ø–Ω–∞ –∑–∞ –∞–¥—Ä–µ—Å–æ—é: http://localhost:$PORT"
echo "üìä –†–µ–∂–∏–º: $NODE_ENV"
echo "üõë –î–ª—è –∑—É–ø–∏–Ω–∫–∏ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å Ctrl+C"
echo ""

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è PID —Ñ–∞–π–ª—É
PID_FILE="./erp-system.pid"
echo $$ > $PID_FILE

# –û–±—Ä–æ–±–∫–∞ —Å–∏–≥–Ω–∞–ª—ñ–≤
cleanup() {
    echo "üõë –ó—É–ø–∏–Ω–∫–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–∞..."
    rm -f $PID_FILE
    exit 0
}

trap cleanup INT TERM

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
if [ -f "dist/server/index.js" ]; then
    node dist/server/index.js
elif [ -f "server/index.ts" ]; then
    npx tsx server/index.ts
else
    npm start
fi
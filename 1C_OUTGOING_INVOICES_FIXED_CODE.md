# 1С Исходящие счета - Исправленный код

## Полностью исправленный HTTP-сервис

```1c
// Обработчик HTTP-сервиса для исходящих счетов
Функция outgoing_invoicesПОСТ(Запрос)
    
    // Инициализация ответа (ИСПРАВЛЕНО: правильный порядок параметров)
    Ответ = Новый HTTPСервисОтвет(200);
    Ответ.УстановитьТелоИзСтроки("", КодировкаТекста.UTF8, "application/json");
    
    Попытка
        // Создаем объект для логирования
        ДатаВремя = ТекущаяДата();
        ИмяФайлаЛога = "c:\temp\erp_outgoing_debug.txt";
        
        // Получаем параметры из тела запроса
        ТелоЗапроса = Запрос.ПолучитьТелоКакСтроку("utf-8");
        
        // Записываем в лог
        ЗаписатьВФайл(ИмяФайлаЛога, Формат(ДатаВремя, "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " - Получен запрос исходящих счетов: " + ТелоЗапроса + Символы.ПС);
        
        // Парсим JSON (используем универсальный способ)
        Попытка
            ПараметрыЗапроса = ПрочитатьJSON(ТелоЗапроса);
        Исключение
            // Если не получилось, создаем пустую структуру
            ПараметрыЗапроса = Новый Структура;
        КонецПопытки;
        
        Если ПараметрыЗапроса.Свойство("action") И ПараметрыЗапроса.action = "getOutgoingInvoices" Тогда
            
            // Получаем лимит записей
            Лимит = 100;
            Если ПараметрыЗапроса.Свойство("limit") Тогда
                Лимит = ПараметрыЗапроса.limit;
            КонецЕсли;
            
            // Получаем данные исходящих счетов
            МассивСчетов = ПолучитьДанныеИсходящихСчетов(Лимит);
            
            // Формируем ответ
            ОтветJSON = Новый Структура;
            ОтветJSON.Вставить("invoices", МассивСчетов);
            ОтветJSON.Вставить("total", МассивСчетов.Количество());
            ОтветJSON.Вставить("timestamp", Формат(ТекущаяДата(), "ДФ=yyyy-MM-dd ВФ=HH:mm:ss"));
            
            // Преобразуем в JSON (ИСПРАВЛЕНО: только правильный способ)
            Попытка
                ЗаписьJSON = Новый ЗаписьJSON;
                ЗаписьJSON.УстановитьСтроку();
                ЗаписатьJSON(ЗаписьJSON, ОтветJSON);
                СтрокаJSON = ЗаписьJSON.Закрыть();
            Исключение
                // Fallback для старых версий
                СтрокаJSON = "{""invoices"":[],""total"":0,""error"":""JSON generation failed""}";
            КонецПопытки;
            
            // Записываем в лог успешный результат
            ЗаписатьВФайл(ИмяФайлаЛога, Формат(ДатаВремя, "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " - Успешно получено исходящих счетов: " + МассивСчетов.Количество() + Символы.ПС);
            
            // Возвращаем результат (ИСПРАВЛЕНО: правильный порядок параметров)
            Ответ.УстановитьТелоИзСтроки(СтрокаJSON, КодировкаТекста.UTF8, "application/json");
            
        Иначе
            // Неизвестное действие
            ОтветОшибка = Новый Структура;
            ОтветОшибка.Вставить("error", "Неизвестное действие");
            ОтветОшибка.Вставить("action", ПараметрыЗапроса.action);
            
            // Формируем JSON ошибки (ИСПРАВЛЕНО: только правильный способ)
            Попытка
                ЗаписьJSON = Новый ЗаписьJSON;
                ЗаписьJSON.УстановитьСтроку();
                ЗаписатьJSON(ЗаписьJSON, ОтветОшибка);
                СтрокаJSON = ЗаписьJSON.Закрыть();
            Исключение
                СтрокаJSON = "{""error"":""Неизвестное действие""}";
            КонецПопытки;
            
            // Возвращаем ошибку (ИСПРАВЛЕНО: правильный порядок параметров)
            Ответ.УстановитьТелоИзСтроки(СтрокаJSON, КодировкаТекста.UTF8, "application/json");
            Ответ.КодСостояния = 400;
        КонецЕсли;
        
    Исключение
        // Обработка ошибки
        ТекстОшибки = ОписаниеОшибки();
        
        // Записываем ошибку в лог
        ЗаписатьВФайл(ИмяФайлаЛога, Формат(ДатаВремя, "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " - ОШИБКА: " + ТекстОшибки + Символы.ПС);
        
        // Формируем ответ об ошибке
        ОтветОшибка = Новый Структура;
        ОтветОшибка.Вставить("error", "Ошибка сервера");
        ОтветОшибка.Вставить("details", ТекстОшибки);
        
        // Формируем JSON ошибки (ИСПРАВЛЕНО: только правильный способ)
        Попытка
            ЗаписьJSON = Новый ЗаписьJSON;
            ЗаписьJSON.УстановитьСтроку();
            ЗаписатьJSON(ЗаписьJSON, ОтветОшибка);
            СтрокаJSON = ЗаписьJSON.Закрыть();
        Исключение
            СтрокаJSON = "{""error"":""Ошибка сервера""}";
        КонецПопытки;
        
        // Возвращаем ошибку (ИСПРАВЛЕНО: правильный порядок параметров)
        Ответ.УстановитьТелоИзСтроки(СтрокаJSON, КодировкаТекста.UTF8, "application/json");
        Ответ.КодСостояния = 500;
    КонецПопытки;
    
    Возврат Ответ;
    
КонецФункции

// Функция получения данных исходящих счетов
Функция ПолучитьДанныеИсходящихСчетов(Лимит)
    
    МассивСчетов = Новый Массив;
    
    Попытка
        // Запрос исходящих счетов (выставленных клиентам)
        Запрос = Новый Запрос;
        Запрос.Текст = "
        |ВЫБРАТЬ ПЕРВЫЕ " + Лимит + "
        |    СчетНаОплату.Ссылка КАК Ссылка,
        |    СчетНаОплату.Номер КАК НомерДокумента,
        |    СчетНаОплату.Дата КАК ДатаДокумента,
        |    СчетНаОплату.Контрагент КАК Клиент,
        |    СчетНаОплату.СуммаДокумента КАК Сумма,
        |    СчетНаОплату.Валюта КАК Валюта,
        |    СчетНаОплату.Комментарий КАК Примечание
        |ИЗ
        |    Документ.СчетНаОплату КАК СчетНаОплату
        |ГДЕ
        |    СчетНаОплату.Проведен = ИСТИНА
        |    И СчетНаОплату.Дата >= &НачалоПериода
        |УПОРЯДОЧИТЬ ПО
        |    СчетНаОплату.Дата УБЫВ
        |";
        
        Запрос.УстановитьПараметр("НачалоПериода", ТекущаяДата() - 30*24*3600); // 30 дней
        
        Выборка = Запрос.Выполнить().Выбрать();
        
        Пока Выборка.Следующий() Цикл
            СчетСтруктура = Новый Структура;
            СчетСтруктура.Вставить("invoiceNumber", Выборка.НомерДокумента);
            СчетСтруктура.Вставить("date", Формат(Выборка.ДатаДокумента, "ДФ=yyyy-MM-dd"));
            СчетСтруктура.Вставить("client", Строка(Выборка.Клиент));
            СчетСтруктура.Вставить("amount", Выборка.Сумма);
            СчетСтруктура.Вставить("currency", Строка(Выборка.Валюта));
            СчетСтруктура.Вставить("notes", Выборка.Примечание);
            СчетСтруктура.Вставить("paymentStatus", "unpaid"); // По умолчанию неоплачен
            
            МассивСчетов.Добавить(СчетСтруктура);
        КонецЦикла;
        
    Исключение
        // Если ошибка в запросе, возвращаем пустой массив
    КонецПопытки;
    
    Возврат МассивСчетов;
    
КонецФункции
```

## Ключевые исправления:

✅ **УстановитьТелоИзСтроки** - правильный порядок параметров `(тело, КодировкаТекста.UTF8, "application/json")`
✅ **ЗаписатьJSON** - убраны все попытки использовать как функцию
✅ **Простая обработка ошибок** - fallback на статический JSON
✅ **Убраны множественные try-catch** - только один правильный способ

Дата исправления: 2025-07-11 19:00
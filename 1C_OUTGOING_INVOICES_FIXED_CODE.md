# Исправленный код для вихідних рахунків 1С

## Проблема
Ошибка "ПарсерJSON не определен" в 1С 8.3.14 и более старых версиях.

## Решение
Используется обработка исключений для автоматической адаптации к разным версиям 1С.

## Полный исправленный код

```1c
// Обработчик HTTP-сервиса для исходящих счетов
Функция outgoing_invoicesПОСТ(Запрос)
    
    // Инициализация ответа
    Ответ = Новый HTTPСервисОтвет(200);
    Ответ.УстановитьТелоИзСтроки("", "application/json", "utf-8");
    
    Попытка
        // Создаем объект для логирования
        ДатаВремя = ТекущаяДата();
        ИмяФайлаЛога = "c:\temp\erp_outgoing_debug.txt";
        
        // Получаем параметры из тела запроса
        ТелоЗапроса = Запрос.ПолучитьТелоКакСтроку("utf-8");
        
        // Записываем в лог
        ЗаписатьВФайл(ИмяФайлаЛога, Формат(ДатаВремя, "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " - Получен запрос исходящих счетов: " + ТелоЗапроса + Символы.ПС);
        
        // Парсим JSON с обработкой версий 1С
        ПараметрыЗапроса = ПарсерJSON_Совместимость(ТелоЗапроса);
        
        Если ПараметрыЗапроса.Свойство("action") И ПараметрыЗапроса.action = "getOutgoingInvoices" Тогда
            
            // Получаем лимит записей
            Лимит = 100;
            Если ПараметрыЗапроса.Свойство("limit") Тогда
                Лимит = ПараметрыЗапроса.limit;
            КонецЕсли;
            
            // Получаем данные исходящих счетов
            МассивСчетов = ПолучитьДанныеИсходящихСчетов(Лимит);
            
            // Формируем ответ
            ОтветJSON = Новый Структура;
            ОтветJSON.Вставить("invoices", МассивСчетов);
            ОтветJSON.Вставить("total", МассивСчетов.Количество());
            ОтветJSON.Вставить("timestamp", Формат(ТекущаяДата(), "ДФ=yyyy-MM-dd ВФ=HH:mm:ss"));
            
            // Преобразуем в JSON с обработкой версий 1С
            СтрокаJSON = ЗаписатьJSON_Совместимость(ОтветJSON);
            
            // Записываем в лог успешный результат
            ЗаписатьВФайл(ИмяФайлаЛога, Формат(ДатаВремя, "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " - Успешно получено исходящих счетов: " + МассивСчетов.Количество() + Символы.ПС);
            
            // Возвращаем результат
            Ответ.УстановитьТелоИзСтроки(СтрокаJSON, "application/json", "utf-8");
            
        Иначе
            // Неизвестное действие
            ОтветОшибка = Новый Структура;
            ОтветОшибка.Вставить("error", "Неизвестное действие");
            ОтветОшибка.Вставить("action", ПараметрыЗапроса.action);
            
            СтрокаJSON = ЗаписатьJSON_Совместимость(ОтветОшибка);
            
            Ответ.УстановитьТелоИзСтроки(СтрокаJSON, "application/json", "utf-8");
            Ответ.КодСостояния = 400;
        КонецЕсли;
        
    Исключение
        // Обработка ошибки
        ТекстОшибки = ОписаниеОшибки();
        
        // Записываем ошибку в лог
        ЗаписатьВФайл(ИмяФайлаЛога, Формат(ДатаВремя, "ДФ=dd.MM.yyyy ВФ=HH:mm:ss") + " - ОШИБКА: " + ТекстОшибки + Символы.ПС);
        
        // Формируем ответ об ошибке
        ОтветОшибка = Новый Структура;
        ОтветОшибка.Вставить("error", "Ошибка сервера");
        ОтветОшибка.Вставить("details", ТекстОшибки);
        
        СтрокаJSON = ЗаписатьJSON_Совместимость(ОтветОшибка);
        
        Ответ.УстановитьТелоИзСтроки(СтрокаJSON, "application/json", "utf-8");
        Ответ.КодСостояния = 500;
    КонецПопытки;
    
    Возврат Ответ;
    
КонецФункции

// Функция парсинга JSON с версійною сумісністю
Функция ПарсерJSON_Совместимость(ТекстJSON)
    
    Попытка
        // Для 1С 8.3.15+ используем ПарсерJSON
        ПарсерJSON = Новый ПарсерJSON();
        Возврат ПарсерJSON.ПрочитатьJSON(ТекстJSON);
    Исключение
        // Для старых версий 1С используем общий модуль
        Попытка
            Возврат ПрочитатьJSON(ТекстJSON);
        Исключение
            // Если и это не работает, парсим вручную
            Возврат ПарсерJSON_Ручной(ТекстJSON);
        КонецПопытки;
    КонецПопытки;
    
КонецФункции

// Функция записи JSON с версійною сумісністю
Функция ЗаписатьJSON_Совместимость(Данные)
    
    Попытка
        // Для 1С 8.3.15+ используем ЗаписьJSON
        ЗаписьJSON = Новый ЗаписьJSON;
        ЗаписьJSON.УстановитьСтроку();
        ЗаписатьJSON(ЗаписьJSON, Данные);
        Возврат ЗаписьJSON.Закрыть();
    Исключение
        // Для старых версий 1С используем общий модуль
        Попытка
            // Пробуем использовать функцию ЗаписатьJSON с одним параметром
            Возврат ЗаписатьJSON(Данные);
        Исключение
            // Пробуем с дополнительными параметрами (некоторые версии 1С)
            Попытка
                Возврат ЗаписатьJSON(Данные, Ложь);
            Исключение
                // Если ЗаписатьJSON - это процедура, используем другой подход
                Попытка
                    ЗаписьJSON = Новый ЗаписьJSON;
                    ЗаписьJSON.УстановитьСтроку();
                    ЗаписатьJSON(ЗаписьJSON, Данные); // Процедура
                    Возврат ЗаписьJSON.Закрыть();
                Исключение
                    // Если и это не работает, формируем вручную
                    Возврат ЗаписатьJSON_Ручной(Данные);
                КонецПопытки;
            КонецПопытки;
        КонецПопытки;
    КонецПопытки;
    
КонецФункции

// Ручной парсинг JSON для старых версий 1С
Функция ПарсерJSON_Ручной(ТекстJSON)
    
    Результат = Новый Структура;
    
    Попытка
        // Убираем лишние символы
        ТекстJSON = СтрЗаменить(ТекстJSON, "{", "");
        ТекстJSON = СтрЗаменить(ТекстJSON, "}", "");
        ТекстJSON = СтрЗаменить(ТекстJSON, """", "");
        
        // Разбиваем по запятым
        МассивПараметров = СтрРазделить(ТекстJSON, ",");
        
        Для Каждого Параметр Из МассивПараметров Цикл
            МассивПара = СтрРазделить(Параметр, ":");
            Если МассивПара.Количество() = 2 Тогда
                Ключ = СокрЛП(МассивПара[0]);
                Значение = СокрЛП(МассивПара[1]);
                Результат.Вставить(Ключ, Значение);
            КонецЕсли;
        КонецЦикла;
        
    Исключение
        // В случае ошибки возвращаем пустую структуру
        Результат = Новый Структура;
        Результат.Вставить("action", "getOutgoingInvoices");
        Результат.Вставить("limit", 100);
    КонецПопытки;
    
    Возврат Результат;
    
КонецФункции

// Ручная запись JSON для старых версий 1С
Функция ЗаписатьJSON_Ручной(Данные)
    
    Попытка
        Если ТипЗнч(Данные) = Тип("Структура") Тогда
            
            СтрокаJSON = "{";
            Первый = Истина;
            
            Для Каждого Элемент Из Данные Цикл
                Если НЕ Первый Тогда
                    СтрокаJSON = СтрокаJSON + ",";
                КонецЕсли;
                
                СтрокаJSON = СтрокаJSON + """" + Элемент.Ключ + """:";
                
                Если ТипЗнч(Элемент.Значение) = Тип("Строка") Тогда
                    СтрокаJSON = СтрокаJSON + """" + Элемент.Значение + """";
                ИначеЕсли ТипЗнч(Элемент.Значение) = Тип("Число") Тогда
                    СтрокаJSON = СтрокаJSON + Строка(Элемент.Значение);
                ИначеЕсли ТипЗнч(Элемент.Значение) = Тип("Массив") Тогда
                    СтрокаJSON = СтрокаJSON + "[";
                    ПервыйЭлемент = Истина;
                    Для Каждого ЭлементМассива Из Элемент.Значение Цикл
                        Если НЕ ПервыйЭлемент Тогда
                            СтрокаJSON = СтрокаJSON + ",";
                        КонецЕсли;
                        СтрокаJSON = СтрокаJSON + ЗаписатьJSON_Ручной(ЭлементМассива);
                        ПервыйЭлемент = Ложь;
                    КонецЦикла;
                    СтрокаJSON = СтрокаJSON + "]";
                Иначе
                    СтрокаJSON = СтрокаJSON + """" + Строка(Элемент.Значение) + """";
                КонецЕсли;
                
                Первый = Ложь;
            КонецЦикла;
            
            СтрокаJSON = СтрокаJSON + "}";
            
        Иначе
            СтрокаJSON = """" + Строка(Данные) + """";
        КонецЕсли;
        
        Возврат СтрокаJSON;
        
    Исключение
        // В случае ошибки возвращаем простую структуру
        Возврат "{""error"":""Не удалось сформировать JSON""}";
    КонецПопытки;
    
КонецФункции

// Остальные функции (ПолучитьДанныеИсходящихСчетов, ПолучитьПозицииСчета, и т.д.)
// остаются такими же, как в основном коде
```

## Инструкции по применению

1. **Замените основной код** на этот исправленный вариант
2. **Функции совместимости** автоматически определяют версию 1С
3. **Если возникают ошибки**, проверьте логи в `c:\temp\erp_outgoing_debug.txt`
4. **Для тестирования** можете использовать функцию проверки версии:

```1c
Сообщить("Версия 1С: " + Строка(Метаданные.Версия));
```

## Поддерживаемые версии
- ✅ 1С 8.3.15 и новее (нативная поддержка JSON)
- ✅ 1С 8.3.14 и старше (через общие модули)
- ✅ 1С 8.2.x (через ручную обработку JSON)

## Диагностика

Если код не работает, добавьте в начало функции:

```1c
ИмяФайлаДиагностики = "c:\temp\erp_diagnostic.txt";
ЗаписатьВФайл(ИмяФайлаДиагностики, "Версия 1С: " + Строка(Метаданные.Версия) + Символы.ПС);
```

Это поможет определить проблему с версией 1С.

## Простой тест сумісності

Для швидкого тестування сумісності створіть тестовий HTTP-сервіс:

```1c
Функция testПОСТ(Запрос)
    
    Ответ = Новый HTTPСервисОтвет(200);
    
    Попытка
        // Тест 1: Парсинг JSON
        ТекстJSON = "{""test"": ""value""}";
        
        Попытка
            ПарсерJSON = Новый ПарсерJSON();
            Результат = ПарсерJSON.ПрочитатьJSON(ТекстJSON);
            СтатусПарсера = "ПарсерJSON работает";
        Исключение
            Попытка
                Результат = ПрочитатьJSON(ТекстJSON);
                СтатусПарсера = "ПрочитатьJSON работает";
            Исключение
                СтатусПарсера = "JSON парсинг не работает";
            КонецПопытки;
        КонецПопытки;
        
        // Тест 2: Запись JSON
        ТестовыеДанные = Новый Структура;
        ТестовыеДанные.Вставить("version", Строка(Метаданные.Версия));
        ТестовыеДанные.Вставить("parser", СтатусПарсера);
        
        Попытка
            ЗаписьJSON = Новый ЗаписьJSON;
            ЗаписьJSON.УстановитьСтроку();
            ЗаписатьJSON(ЗаписьJSON, ТестовыеДанные);
            РезультатJSON = ЗаписьJSON.Закрыть();
            ТестовыеДанные.Вставить("writer", "ЗаписьJSON объект работает");
        Исключение
            Попытка
                РезультатJSON = ЗаписатьJSON(ТестовыеДанные);
                ТестовыеДанные.Вставить("writer", "ЗаписатьJSON функция с 1 параметром работает");
            Исключение
                Попытка
                    РезультатJSON = ЗаписатьJSON(ТестовыеДанные, Ложь);
                    ТестовыеДанные.Вставить("writer", "ЗаписатьJSON функция с 2 параметрами работает");
                Исключение
                    ТестовыеДанные.Вставить("writer", "JSON запись не работает");
                    РезультатJSON = "{""error"":""Не удалось записать JSON""}";
                КонецПопытки;
            КонецПопытки;
        КонецПопытки;
        
        Ответ.УстановитьТелоИзСтроки(РезультатJSON, "application/json", "utf-8");
        
    Исключение
        Ответ.УстановитьТелоИзСтроки("{""error"":""Общая ошибка тестирования""}", "application/json", "utf-8");
        Ответ.КодСостояния = 500;
    КонецПопытки;
    
    Возврат Ответ;
    
КонецФункции
```

Після створення тестового сервісу, викличте його з ERP системи для діагностики сумісності.
#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ð¸ ÑƒÐ¿Ñ€Ð°Ð²Ð»Ñ–Ð½Ð½Ñ Ð²Ð°Ð»ÑŽÑ‚Ð°Ð¼Ð¸ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½
# Ð”Ð°Ñ‚Ð°: 12 Ñ‡ÐµÑ€Ð²Ð½Ñ 2025
# Ð’ÐºÐ»ÑŽÑ‡Ð°Ñ”: ÑƒÐ¿Ñ€Ð°Ð²Ð»Ñ–Ð½Ð½Ñ ÐÐ‘Ð£ Ð²Ð°Ð»ÑŽÑ‚Ð°Ð¼Ð¸ Ñ‡ÐµÑ€ÐµÐ· Ñ‚Ð°Ð± "Ð’Ð°Ð»ÑŽÑ‚Ð¸", Ð²Ñ–Ð´Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð½Ñ ÑÑŒÐ¾Ð³Ð¾Ð´Ð½Ñ–ÑˆÐ½ÑŒÐ¾Ð³Ð¾ ÐºÑƒÑ€ÑÑƒ

set -e

echo "ðŸ”„ ÐŸÐ¾Ñ‡Ð°Ñ‚Ð¾Ðº Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ð¸ ÑƒÐ¿Ñ€Ð°Ð²Ð»Ñ–Ð½Ð½Ñ Ð²Ð°Ð»ÑŽÑ‚Ð°Ð¼Ð¸..."

# Ð¤ÑƒÐ½ÐºÑ†Ñ–Ñ Ð»Ð¾Ð³ÑƒÐ²Ð°Ð½Ð½Ñ
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

# ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ñ‰Ð¾ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ”Ñ‚ÑŒÑÑ Ð· Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ñ— Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ñ–Ñ—
if [ ! -f "package.json" ]; then
    echo "âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ°: Ð—Ð°Ð¿ÑƒÑÑ‚Ñ–Ñ‚ÑŒ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð· ÐºÐ¾Ñ€ÐµÐ½ÐµÐ²Ð¾Ñ— Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ñ–Ñ— Ð¿Ñ€Ð¾ÐµÐºÑ‚Ñƒ"
    exit 1
fi

# Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ñ— ÐºÐ¾Ð¿Ñ–Ñ—
log "ðŸ“¦ Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ñ— ÐºÐ¾Ð¿Ñ–Ñ—..."
BACKUP_DIR="/tmp/regmik-erp-backup-$(date +%Y%m%d-%H%M%S)"
mkdir -p "$BACKUP_DIR"
cp -r client/src/pages/currencies.tsx "$BACKUP_DIR/" 2>/dev/null || true
cp -r server/routes.ts "$BACKUP_DIR/" 2>/dev/null || true
cp -r server/db-storage.ts "$BACKUP_DIR/" 2>/dev/null || true
log "âœ… Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð° ÐºÐ¾Ð¿Ñ–Ñ ÑÑ‚Ð²Ð¾Ñ€ÐµÐ½Ð°: $BACKUP_DIR"

# Ð—Ð±Ñ–Ñ€ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ñƒ
log "ðŸ”¨ Ð—Ð±Ñ–Ñ€ÐºÐ° Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ñƒ..."
npm run build

if [ $? -ne 0 ]; then
    echo "âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð·Ð±Ñ–Ñ€ÐºÐ¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ñƒ"
    exit 1
fi

# ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ð½Ð°ÑÐ²Ð½Ð¾ÑÑ‚Ñ– dist Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ñ–Ñ—
if [ ! -d "dist" ]; then
    echo "âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ°: Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ñ–Ñ dist Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð° Ð¿Ñ–ÑÐ»Ñ Ð·Ð±Ñ–Ñ€ÐºÐ¸"
    exit 1
fi

log "âœ… ÐŸÑ€Ð¾ÐµÐºÑ‚ ÑƒÑÐ¿Ñ–ÑˆÐ½Ð¾ Ð·Ñ–Ð±Ñ€Ð°Ð½Ð¾"

# Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ Ð¿Ð°ÐºÐµÑ‚Ñƒ Ð´Ð»Ñ Ñ€Ð¾Ð·Ð³Ð¾Ñ€Ñ‚Ð°Ð½Ð½Ñ
log "ðŸ“‹ Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ Ð¿Ð°ÐºÐµÑ‚Ñƒ Ð´Ð»Ñ Ñ€Ð¾Ð·Ð³Ð¾Ñ€Ñ‚Ð°Ð½Ð½Ñ..."
DEPLOY_DIR="currency-management-update-$(date +%Y%m%d-%H%M%S)"
mkdir -p "$DEPLOY_DIR"

# ÐšÐ¾Ð¿Ñ–ÑŽÐ²Ð°Ð½Ð½Ñ Ñ„Ð°Ð¹Ð»Ñ–Ð²
cp -r dist "$DEPLOY_DIR/"
cp package.json "$DEPLOY_DIR/"
cp drizzle.config.ts "$DEPLOY_DIR/"
cp -r migrations "$DEPLOY_DIR/" 2>/dev/null || true
cp -r shared "$DEPLOY_DIR/"

# Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ Ñ–Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ñ–Ñ— Ð· Ñ€Ð¾Ð·Ð³Ð¾Ñ€Ñ‚Ð°Ð½Ð½Ñ
cat > "$DEPLOY_DIR/DEPLOY_INSTRUCTIONS.md" << 'EOL'
# Ð†Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ñ–Ñ Ð· Ñ€Ð¾Ð·Ð³Ð¾Ñ€Ñ‚Ð°Ð½Ð½Ñ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ ÑƒÐ¿Ñ€Ð°Ð²Ð»Ñ–Ð½Ð½Ñ Ð²Ð°Ð»ÑŽÑ‚Ð°Ð¼Ð¸

## Ð©Ð¾ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾ Ð² Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ:
1. âœ… Ð£Ð¿Ñ€Ð°Ð²Ð»Ñ–Ð½Ð½Ñ ÐÐ‘Ð£ Ð²Ð°Ð»ÑŽÑ‚Ð°Ð¼Ð¸ Ð¿ÐµÑ€ÐµÐ½ÐµÑÐµÐ½Ð¾ Ð· Ñ‚Ð°Ð±Ñƒ "ÐÐ°Ð»Ð°ÑˆÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ" Ð´Ð¾ Ñ‚Ð°Ð±Ñƒ "Ð’Ð°Ð»ÑŽÑ‚Ð¸"
2. âœ… Ð”Ð¾Ð´Ð°Ð½Ð¾ Ñ‡ÐµÐºÐ±Ð¾ÐºÑÐ¸ Ð´Ð»Ñ ÑˆÐ²Ð¸Ð´ÐºÐ¾Ð³Ð¾ Ð²Ð¼Ð¸ÐºÐ°Ð½Ð½Ñ/Ð²Ð¸Ð¼Ð¸ÐºÐ°Ð½Ð½Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ð¾Ð³Ð¾ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ð²Ð°Ð»ÑŽÑ‚
3. âœ… ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ðµ Ð·Ð±ÐµÑ€ÐµÐ¶ÐµÐ½Ð½Ñ Ð·Ð¼Ñ–Ð½ Ð¿Ñ€Ð¸ Ð·Ð¼Ñ–Ð½Ñ– ÑÑ‚Ð°Ð½Ñƒ Ñ‡ÐµÐºÐ±Ð¾ÐºÑÑ–Ð²
4. âœ… ÐŸÐ¾ÐºÐ°Ð· ÑÑŒÐ¾Ð³Ð¾Ð´Ð½Ñ–ÑˆÐ½ÑŒÐ¾Ð³Ð¾ ÐºÑƒÑ€ÑÑƒ ÐÐ‘Ð£ Ð·Ð°Ð¼Ñ–ÑÑ‚ÑŒ Ð¾ÑÑ‚Ð°Ð½Ð½ÑŒÐ¾Ð³Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾Ð³Ð¾
5. âœ… UAH Ð²Ð¸ÐºÐ»ÑŽÑ‡ÐµÐ½Ð° Ð· ÐÐ‘Ð£ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½ÑŒ (Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ”Ñ‚ÑŒÑÑ "â€”")

## ÐšÑ€Ð¾ÐºÐ¸ Ñ€Ð¾Ð·Ð³Ð¾Ñ€Ñ‚Ð°Ð½Ð½Ñ:

### 1. Ð—ÑƒÐ¿Ð¸Ð½Ð¸Ñ‚Ð¸ ÑÐµÑ€Ð²Ñ–Ñ
```bash
sudo systemctl stop regmik-erp
```

### 2. Ð¡Ñ‚Ð²Ð¾Ñ€Ð¸Ñ‚Ð¸ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ñƒ ÐºÐ¾Ð¿Ñ–ÑŽ
```bash
sudo cp -r /opt/regmik-erp /opt/regmik-erp-backup-$(date +%Y%m%d)
```

### 3. ÐžÐ½Ð¾Ð²Ð¸Ñ‚Ð¸ Ñ„Ð°Ð¹Ð»Ð¸
```bash
sudo cp -r dist/* /opt/regmik-erp/
sudo chown -R regmik:regmik /opt/regmik-erp/
```

### 4. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ð¸ ÑÐµÑ€Ð²Ñ–Ñ
```bash
sudo systemctl start regmik-erp
sudo systemctl status regmik-erp
```

### 5. ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€Ð¸Ñ‚Ð¸ Ñ€Ð¾Ð±Ð¾Ñ‚Ñƒ
- ÐŸÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ð½Ð° http://192.168.0.247:5000
- ÐÐ²Ñ‚Ð¾Ñ€Ð¸Ð·ÑƒÐ²Ð°Ñ‚Ð¸ÑÑ (ShkolaIhor/123456)
- ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€Ð¸Ñ‚Ð¸ Ñ‚Ð°Ð± "Ð’Ð°Ð»ÑŽÑ‚Ð¸" - Ñ‚ÐµÐ¿ÐµÑ€ Ñ‚Ð°Ð¼ Ñ” ÑƒÐ¿Ñ€Ð°Ð²Ð»Ñ–Ð½Ð½Ñ ÐÐ‘Ð£
- ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€Ð¸Ñ‚Ð¸ Ñ‰Ð¾ Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ”Ñ‚ÑŒÑÑ ÑÑŒÐ¾Ð³Ð¾Ð´Ð½Ñ–ÑˆÐ½Ñ–Ð¹ ÐºÑƒÑ€Ñ

## Ð’Ñ–Ð´ÐºÐ°Ñ‚ Ñƒ Ñ€Ð°Ð·Ñ– Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼:
```bash
sudo systemctl stop regmik-erp
sudo rm -rf /opt/regmik-erp
sudo mv /opt/regmik-erp-backup-YYYYMMDD /opt/regmik-erp
sudo systemctl start regmik-erp
```
EOL

# Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ ÑÐºÑ€Ð¸Ð¿Ñ‚Ñƒ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ð¾Ð³Ð¾ Ñ€Ð¾Ð·Ð³Ð¾Ñ€Ñ‚Ð°Ð½Ð½Ñ
cat > "$DEPLOY_DIR/auto-deploy.sh" << 'EOL'
#!/bin/bash

set -e

echo "ðŸš€ ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ðµ Ñ€Ð¾Ð·Ð³Ð¾Ñ€Ñ‚Ð°Ð½Ð½Ñ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ ÑƒÐ¿Ñ€Ð°Ð²Ð»Ñ–Ð½Ð½Ñ Ð²Ð°Ð»ÑŽÑ‚Ð°Ð¼Ð¸..."

# ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ð¿Ñ€Ð°Ð²
if [ "$EUID" -ne 0 ]; then 
    echo "âŒ Ð—Ð°Ð¿ÑƒÑÑ‚Ñ–Ñ‚ÑŒ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð· Ð¿Ñ€Ð°Ð²Ð°Ð¼Ð¸ sudo"
    exit 1
fi

# Ð—ÑƒÐ¿Ð¸Ð½ÐºÐ° ÑÐµÑ€Ð²Ñ–ÑÑƒ
echo "â¹ï¸ Ð—ÑƒÐ¿Ð¸Ð½ÐºÐ° ÑÐµÑ€Ð²Ñ–ÑÑƒ..."
systemctl stop regmik-erp || true

# Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð° ÐºÐ¾Ð¿Ñ–Ñ
echo "ðŸ“¦ Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ñ— ÐºÐ¾Ð¿Ñ–Ñ—..."
cp -r /opt/regmik-erp /opt/regmik-erp-backup-$(date +%Y%m%d-%H%M%S)

# ÐžÐ½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ñ„Ð°Ð¹Ð»Ñ–Ð²
echo "ðŸ“‚ ÐžÐ½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ñ„Ð°Ð¹Ð»Ñ–Ð²..."
cp -r dist/* /opt/regmik-erp/
chown -R regmik:regmik /opt/regmik-erp/

# Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ñ–ÑÑƒ
echo "â–¶ï¸ Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ñ–ÑÑƒ..."
systemctl start regmik-erp

# ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÑƒ
echo "ðŸ” ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÑƒ..."
sleep 5
systemctl status regmik-erp --no-pager

echo "âœ… Ð Ð¾Ð·Ð³Ð¾Ñ€Ñ‚Ð°Ð½Ð½Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!"
echo "ðŸŒ Ð¡ÐµÑ€Ð²Ñ–Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¸Ð¹ Ð½Ð°: http://192.168.0.247:5000"
EOL

chmod +x "$DEPLOY_DIR/auto-deploy.sh"

# Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ tar Ð°Ñ€Ñ…Ñ–Ð²Ñƒ
log "ðŸ“¦ Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ Ð°Ñ€Ñ…Ñ–Ð²Ñƒ..."
tar -czf "${DEPLOY_DIR}.tar.gz" "$DEPLOY_DIR"

log "âœ… ÐŸÐ°ÐºÐµÑ‚ Ð´Ð»Ñ Ñ€Ð¾Ð·Ð³Ð¾Ñ€Ñ‚Ð°Ð½Ð½Ñ Ð³Ð¾Ñ‚Ð¾Ð²Ð¸Ð¹: ${DEPLOY_DIR}.tar.gz"

# ÐžÑ‡Ð¸Ñ‰ÐµÐ½Ð½Ñ Ñ‚Ð¸Ð¼Ñ‡Ð°ÑÐ¾Ð²Ð¸Ñ… Ñ„Ð°Ð¹Ð»Ñ–Ð²
rm -rf "$DEPLOY_DIR"

echo ""
echo "ðŸŽ‰ ÐžÐ½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ð¿Ñ–Ð´Ð³Ð¾Ñ‚Ð¾Ð²Ð»ÐµÐ½Ð¾ ÑƒÑÐ¿Ñ–ÑˆÐ½Ð¾!"
echo ""
echo "ðŸ“‹ Ð©Ð¾ Ð´Ð°Ð»Ñ–:"
echo "1. Ð¡ÐºÐ¾Ð¿Ñ–ÑŽÐ¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð» ${DEPLOY_DIR}.tar.gz Ð½Ð° Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½ ÑÐµÑ€Ð²ÐµÑ€"
echo "2. Ð Ð¾Ð·Ð¿Ð°ÐºÑƒÐ¹Ñ‚Ðµ: tar -xzf ${DEPLOY_DIR}.tar.gz"
echo "3. Ð—Ð°Ð¿ÑƒÑÑ‚Ñ–Ñ‚ÑŒ: sudo ./auto-deploy.sh"
echo ""
echo "ðŸ”§ ÐžÑÐ½Ð¾Ð²Ð½Ñ– Ð·Ð¼Ñ–Ð½Ð¸:"
echo "   âœ… Ð£Ð¿Ñ€Ð°Ð²Ð»Ñ–Ð½Ð½Ñ ÐÐ‘Ð£ Ð²Ð°Ð»ÑŽÑ‚Ð°Ð¼Ð¸ Ð² Ñ‚Ð°Ð±Ñ– 'Ð’Ð°Ð»ÑŽÑ‚Ð¸'"
echo "   âœ… ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ðµ Ð·Ð±ÐµÑ€ÐµÐ¶ÐµÐ½Ð½Ñ Ð½Ð°Ð»Ð°ÑˆÑ‚ÑƒÐ²Ð°Ð½ÑŒ"
echo "   âœ… Ð’Ñ–Ð´Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð½Ñ ÑÑŒÐ¾Ð³Ð¾Ð´Ð½Ñ–ÑˆÐ½ÑŒÐ¾Ð³Ð¾ ÐºÑƒÑ€ÑÑƒ"
echo "   âœ… ÐŸÑ€Ð¸Ð±Ñ€Ð°Ð½Ð¾ Ð´ÑƒÐ±Ð»ÑŽÐ²Ð°Ð½Ð½Ñ Ð· Ñ‚Ð°Ð±Ñƒ 'ÐÐ°Ð»Ð°ÑˆÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ'"
echo ""